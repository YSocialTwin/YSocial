{% include "admin/head.html" %}

<style>
    .sidebar-box {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 16px;
        margin-bottom: 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    .sidebar-box h3 {
        font-size: 1em;
        font-weight: 600;
        color: #1f2937;
        margin: 0 0 12px 0;
        padding-bottom: 8px;
        border-bottom: 1px solid #e5e7eb;
    }
    .sidebar-box .help-block {
        font-size: 0.85em;
        line-height: 1.5;
        color: #6b7280;
    }
    .sidebar-box .help-block p {
        margin: 0 0 10px 0;
    }
    .sidebar-box .help-block p:last-child {
        margin-bottom: 0;
    }
    .sidebar-box .help-block b {
        color: #374151;
        font-weight: 600;
    }
    .sidebar-box .input {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        font-size: 0.9em;
        transition: border-color 0.2s;
    }
    .sidebar-box .input:focus {
        outline: none;
        border-color: #22c55e;
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
    }
    .sidebar-box .button-wrap {
        margin-top: 12px;
    }
    .sidebar-box .button {
        width: 100%;
        padding: 8px 16px;
        font-size: 0.9em;
        font-weight: 500;
    }
</style>

<div class="view-wrapper is-dashboard">
    <!--Dashboard container-->
    <div id="creator-dashboard" class="dashboard-container">
        <!--Toolbar-->
        {% include "admin/dash_head.html" %}

        <div class="dashboard-body">
            <div class="columns">
                <div class="column is-12">

                    {% for message in get_flashed_messages() %}
                    <div class="alert alert-warning">
                        <button type="button" class="close" data-dismiss="alert">&times;</button>
                        {{ message }}
                    </div>
                    {% endfor %}

                    <div class="dashboard-box">
                        <h3 class="title is-5 is-thin">Available Experiments</h3>

                        <div class="box-content">


                            <div id="table"></div>

                            <script src="{{ url_for('static', filename='assets/vendor/js/gridjs.umd.js') }}"></script>

                            <style>

                              #table td {
                                vertical-align: middle !important;
                              }
                            </style>

<script>
    const tableDiv = document.getElementById('table');

    const updateUrl = (prev, query) => {
        return prev + (prev.indexOf('?') >= 0 ? '&' : '?') + new URLSearchParams(query).toString();
    };

    const editableCellAttributes = (data, row, col) => {
        if (row) {
            return {
                contentEditable: 'true',
                'data-element-id': row.cells[0].data,
                'data-column-id': col.id
            };
        } else {
            return {};
        }
    };

    new gridjs.Grid({
        columns: [
            { id: 'idexp', hidden: true },
            { id: 'exp_name', name: 'Name', attributes: editableCellAttributes },
            { id: 'owner', name: 'Owner', sort: false },
            { id: 'platform_type', name: 'Platform Type', sort: true },
            {
                id: 'annotations',
                name: 'Annotations',
                sort: false,
                formatter: (cell) => {
                    if (!cell || cell === '') {
                        return gridjs.html('<div style="text-align: center;">-</div>');
                    }
                    const annotations = cell.split(',').filter(a => a.trim());
                    const tags = annotations.map(annotation => {
                        const colors = {
                            'toxicity': '#dc3545',
                            'sentiment': '#28a745',
                            'emotion': '#17a2b8'
                        };
                        const color = colors[annotation.trim()] || '#6c757d';
                        return `<span style="display: inline-block; background-color: ${color}; color: white; padding: 2px 8px; margin: 2px; border-radius: 12px; font-size: 0.75rem;">${annotation.trim()}</span>`;
                    }).join('');
                    return gridjs.html(`<div style="display: flex; justify-content: center; flex-wrap: wrap;">${tags}</div>`);
                }
            },
            { 
                id: 'running', 
                name: 'Simulation', 
                sort: true,
                formatter: (cell) => {
                    const isRunning = cell === 'Running';
                    const color = isRunning ? '#28a745' : '#dc3545';
                    return gridjs.html(`
                        <div style="display: flex; justify-content: center; align-items: center;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background-color: ${color};" title="${cell}"></div>
                        </div>
                    `);
                }
            },
            { 
                id: 'web', 
                name: 'Web', 
                sort: true,
                formatter: (cell) => {
                    const isLoaded = cell === 'Loaded';
                    const color = isLoaded ? '#28a745' : '#6c757d';
                    return gridjs.html(`
                        <div style="display: flex; justify-content: center; align-items: center;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background-color: ${color};" title="${cell}"></div>
                        </div>
                    `);
                }
            },
            {% if enable_notebook %}
            { 
                id: 'jupyter_status', 
                name: 'Notebook', 
                sort: true,
                formatter: (cell) => {
                    const isActive = cell === 'Active';
                    const color = isActive ? '#28a745' : '#6c757d';
                    return gridjs.html(`
                        <div style="display: flex; justify-content: center; align-items: center;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background-color: ${color};" title="${cell}"></div>
                        </div>
                    `);
                }
            },
            {% endif %}
            {
                id: 'details',
                name: 'Actions',
                sort: false,
                formatter: (cell, row) => {
                    const id = row.cells[0].data;
                    return gridjs.html(`
                        <div style="display: flex; gap: 8px; justify-content: center;">
                            <a href="/admin/experiment_details/${id}"
                               style="background-color: #28a745; color: white; padding: 6px 12px; border-radius: 4px; text-decoration: none; font-size: 0.85rem;">
                                Details
                            </a>
                            <a href="/admin/delete_simulation/${id}"
                               style="background-color: #dc3545; color: white; padding: 6px 12px; border-radius: 4px; text-decoration: none; font-size: 0.85rem;">
                                Delete
                            </a>
                        </div>
                    `);
                }
            },
        ],
        server: {
            url: '/admin/experiments_data',
            then: results => results.data,
            total: results => results.total,
        },
        search: {
            enabled: true,
            server: {
                url: (prev, search) => {
                    return updateUrl(prev, { search });
                },
            },
        },
        sort: {
            enabled: true,
            multiColumn: true,
            server: {
                url: (prev, columns) => {
                    const columnIds = ['idexp', 'exp_name', 'platform_type', 'exp_descr', 'owner', 'web', 'running'];
                    const sort = columns.map(col => (col.direction === 1 ? '+' : '-') + columnIds[col.index]);
                    return updateUrl(prev, { sort });
                },
            },
        },
        pagination: {
            enabled: true,
            server: {
                url: (prev, page, limit) => {
                    return updateUrl(prev, { start: page * limit, length: limit });
                },
            },
        },
    }).render(tableDiv);

    let savedValue;

    // Inline editing support
    tableDiv.addEventListener('focusin', ev => {
        if (ev.target.tagName === 'TD') {
            savedValue = ev.target.textContent;
        }
    });

    tableDiv.addEventListener('focusout', ev => {
        if (ev.target.tagName === 'TD') {
            if (savedValue !== ev.target.textContent) {
                fetch('/admin/experiments_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: ev.target.dataset.elementId,
                        [ev.target.dataset.columnId]: ev.target.textContent
                    }),
                });
            }
            savedValue = undefined;
        }
    });

    tableDiv.addEventListener('keydown', ev => {
        if (ev.target.tagName === 'TD') {
            if (ev.key === 'Escape') {
                ev.target.textContent = savedValue;
                ev.target.blur();
            } else if (ev.key === 'Enter') {
                ev.preventDefault();
                ev.target.blur();
            }
        }
    });

    // Handle Delete Button
    tableDiv.addEventListener('click', function (event) {
        const target = event.target;
        if (target.classList.contains('delete-button')) {
            const id = target.getAttribute('data-id');
            if (confirm('Are you sure you want to delete this experiment?')) {
                fetch(`/admin/delete_simulation/${id}`, {
                    method: 'DELETE',
                })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to delete');
                    // Refresh table after deletion
                    location.reload();
                })
                .catch(err => {
                    alert('Error deleting experiment.');
                    console.error(err);
                });
            }
        }
    });
</script>



                        </div>
                    </div>

                </div>

            </div>

            <div class="columns">
                <!--Dashboard column-->
                <div class="column is-8">
                    <!--Dashboard box-->

                    <div class="dashboard-box">
                        <h3 class="title is-5 is-thin">New Experiment</h3>
                        <div class="box-content">
                            <form action="/admin/create_experiment" enctype="multipart/form-data" method="POST">
                                <div class="box-lines">

                                    <div class="box-line">
                                        <span class="left">Platform Type</span>
                                        <span class="right" style="width: 70%;">
                                            <div class="select">
                                                <select name="platform_type" style="width: 100%">
                                                    <option value="microblogging">Microblogging (i.e., X/BlueSky)</option>
                                                    <option value="forum" disabled>Forum (i.e., Reddit)</option>
                                                </select>
                                            </div>
                                        </span>
                                    </div>

                                    <div class="box-line">
                                        <span class="left">Name</span>
                                        <span class="right" style="width: 70%;"><input type="text" name="exp_name"
                                                                                       class="input"></span>
                                    </div>
                                    <div class="box-line">
                                        <span class="left">Description</span>
                                        <span class="right" style="width: 70%;"><input type="textarea" name="exp_descr"
                                                                                       class="input"></span>
                                    </div>
                                    <div class="box-line">
                                        <span class="left">Simulation Topics</span>
                                        <span class="right" style="width: 70%;">

                                            <div class="tags-input" style="width: 100%;">
                                            <ul id="tags"></ul>
                                            <input type="hidden" id="tags-hidden" name="tags">
                                            <input type="text" id="input-tag" placeholder="Enter topic name" style="width: 100%;"/>
                                        </div>

                                        <script>
                                            const tags = document.getElementById('tags');
    const input = document.getElementById('input-tag');
    const hiddenInput = document.getElementById('tags-hidden');
    const tagList = [];

    function updateButtonState() {
        const createBtn = document.getElementById('create-experiment-btn');
        if (createBtn) {
            if (tagList.length > 0) {
                createBtn.disabled = false;
            } else {
                createBtn.disabled = true;
            }
        }
    }

    input.addEventListener('keydown', function (event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            const tagContent = input.value.trim();
            if (tagContent !== '' && !tagList.includes(tagContent)) {
                tagList.push(tagContent);
                const tag = document.createElement('li');
                tag.innerHTML = `${tagContent} <button class="delete-button">X</button>`;
                tags.appendChild(tag);
                hiddenInput.value = tagList.join(',');
                input.value = '';
                updateButtonState();
            }
        }
    });

    tags.addEventListener('click', function (event) {
        if (event.target.classList.contains('delete-button')) {
            const tagText = event.target.parentNode.textContent.slice(0, -1);
            tagList.splice(tagList.indexOf(tagText), 1);
            hiddenInput.value = tagList.join(',');
            event.target.parentNode.remove();
            updateButtonState();
        }
    });
                                        </script>
                                        </span>
                                    </div>

                                    <div class="box-line">
                                        <span class="left">Generated Content Annotation</span>
                                        <span class="right" style="width: 70%;">
                                            <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                                                <div style="display: flex; align-items: center; gap: 8px;">
                                                    <label class="switch-small">
                                                        <input type="checkbox" id="toxicity_annotation_toggle" name="toxicity_annotation" value="true">
                                                        <span class="slider-small round"></span>
                                                    </label>
                                                    <span style="font-size: 0.9rem;">Toxicity</span>
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 8px;">
                                                    <label class="switch-small">
                                                        <input type="checkbox" id="sentiment_annotation_toggle" name="sentiment_annotation" value="true" checked>
                                                        <span class="slider-small round"></span>
                                                    </label>
                                                    <span style="font-size: 0.9rem;">Sentiment</span>
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 8px;">
                                                    <label class="switch-small">
                                                        <input type="checkbox" id="emotion_annotation_toggle" name="emotion_annotation" value="true" checked>
                                                        <span class="slider-small round"></span>
                                                    </label>
                                                    <span style="font-size: 0.9rem;">Emotion</span>
                                                </div>
                                            </div>
                                        </span>
                                    </div>

                                    <div class="box-line" id="perspective_api_field" style="display: none;">
                                        <span class="left">Perspective API Key<br> <small>(Required for toxicity)</small></span>
                                        <span class="right" style="width: 70%;"><input type="text" name="perspective_api"
                                                                                       class="input"
                                                                                       value=""></span>
                                    </div>
                                </div>
                                <div class="button-wrap">
                                    <button id="create-experiment-btn" class="button is-solid primary-button is-fullwidth" disabled>
                                        Create
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <style>
                        /* Toggle Switch Styles */
                        .switch {
                            position: relative;
                            display: inline-block;
                            width: 60px;
                            height: 34px;
                        }

                        .switch input {
                            opacity: 0;
                            width: 0;
                            height: 0;
                        }

                        .slider {
                            position: absolute;
                            cursor: pointer;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background-color: #ccc;
                            transition: .4s;
                        }

                        .slider:before {
                            position: absolute;
                            content: "";
                            height: 26px;
                            width: 26px;
                            left: 4px;
                            bottom: 4px;
                            background-color: white;
                            transition: .4s;
                        }

                        input:checked + .slider {
                            background-color: #5596e6;
                        }

                        input:focus + .slider {
                            box-shadow: 0 0 1px #5596e6;
                        }

                        input:checked + .slider:before {
                            transform: translateX(26px);
                        }

                        .slider.round {
                            border-radius: 34px;
                        }

                        .slider.round:before {
                            border-radius: 50%;
                        }

                        /* Small Toggle Switch Styles */
                        .switch-small {
                            position: relative;
                            display: inline-block;
                            width: 40px;
                            height: 22px;
                        }

                        .switch-small input {
                            opacity: 0;
                            width: 0;
                            height: 0;
                        }

                        .slider-small {
                            position: absolute;
                            cursor: pointer;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background-color: #ccc;
                            transition: .4s;
                        }

                        .slider-small:before {
                            position: absolute;
                            content: "";
                            height: 16px;
                            width: 16px;
                            left: 3px;
                            bottom: 3px;
                            background-color: white;
                            transition: .4s;
                        }

                        input:checked + .slider-small {
                            background-color: #5596e6;
                        }

                        input:focus + .slider-small {
                            box-shadow: 0 0 1px #5596e6;
                        }

                        input:checked + .slider-small:before {
                            transform: translateX(18px);
                        }

                        .slider-small.round {
                            border-radius: 22px;
                        }

                        .slider-small.round:before {
                            border-radius: 50%;
                        }
                    </style>

                    <script>
                        // Show/hide Perspective API field based on toxicity annotation toggle
                        document.addEventListener('DOMContentLoaded', function() {
                            const toxicityToggle = document.getElementById('toxicity_annotation_toggle');
                            const perspectiveApiField = document.getElementById('perspective_api_field');

                            toxicityToggle.addEventListener('change', function() {
                                if (this.checked) {
                                    perspectiveApiField.style.display = 'flex';
                                } else {
                                    perspectiveApiField.style.display = 'none';
                                }
                            });
                        });
                    </script>

                    <!--Dashboard box-->
                    <!-- <div class="dashboard-box">
                        <h3 class="title is-5 is-thin">Available Experiments</h3>

                        <div class="box-content">

                            {% for exp in experiments %}
                            <div class="box-subscribers">

                                <div class="box-subscriber">
                                    <img class="subscriber-avatar" src="https://via.placeholder.com/300x300"
                                         data-demo-src="{{ url_for('static', filename='assets/img/icons/emoji/robot.svg') }}"
                                         data-user-popover="10" alt=""/>
                                    <div class="subscriber-meta" style="width: 80%;">
                                        <span class="meta-title">{{ exp.exp_name }}</span>
                                        <span class="meta-content">Description: {{ exp.exp_descr }}</span>
                                        <span class="meta-content">Owner: {{ exp.owner }} </span>

                                    </div>

                                    {% if exp.status==0 %}
                                    <a class="button is-solid primary-button_small green-button"
                                       href='/admin/select_experiment/{{ exp.idexp }}'
                                       title="Activate experiment">
                                        <div class="mdi mdi-play"></div>
                                    </a>
                                    {% endif %}
                                    {% if exp.status==1 %}
                                    <a class="button is-solid primary-button_small orange-button"
                                       href='/admin/select_experiment/{{ exp.idexp }}'
                                       title="Deactivate experiment">
                                        <div class="mdi mdi-stop"></div>
                                    </a>
                                    <a class="button is-solid primary-button_small" 
                                       href="/admin/join_experiment/{{ exp.idexp }}"
                                       title="Join experiment">
                                        <div class="mdi mdi-login"></div>
                                    </a>
                                    {% endif %}
                                    <a class="button is-solid primary-button_small red-button"
                                       href="/admin/delete_simulation/{{ exp.idexp }}">
                                        <div class="mdi mdi-delete"></div>
                                    </a>
                                </div>

                            </div>
                            {% endfor %}

                            <div class="link-wrap">
                                <a class="link">
                                    <span>View All</span>
                                    <i data-feather="arrow-right"></i>
                                </a>
                            </div>
                        </div>
                    </div> -->
                </div>


                <!--Dashboard column-->
                <div class="column is-4">
                    <!--Box-->
                    <div class="sidebar-box">
                        <h3>Guide</h3>
                        <div class="help-block">

                            <p>
                                <b>What is an Experiment?</b>
                                An experiment is the core of the YSocial platform.
                                It composes the YServer, the SQlite database, the YClient and the agents' populations.
                            </p>
                            <br>


                            <p>
                               <b>Uploading an Experiment.</b>
                                To upload an experiment, load the zip file containing the experiment files (as exported from a YSocial experiment detail page).
                            </p>
                            <br>

                            <p>
                                <b>Creating an Experiment.</b>
                                To create a new experiment, provide a name, description, owner, host, and port.
                                <br><br>
                                Once created the experiment it will be possible to: (i) configure it, (ii) allocate synthetic agents to it and, (ii) create clients to interact with it.
                                <br><br>
                                <b>Note:</b> Specify at least two simulation topics and to enable agent content generation.
                            </p>
                        </div>
                    </div>

                    {%if dbtype=="sqlite" %}
                    <div class="sidebar-box">
                        <h3>Upload Experiment</h3>
                        <form action="/admin/upload_experiment" enctype="multipart/form-data" method="POST">
                            <style>
                                .file-upload-wrapper-exp {
                                    position: relative;
                                    overflow: hidden;
                                    display: block;
                                    margin-bottom: 12px;
                                }
                                .file-upload-wrapper-exp input[type=file] {
                                    position: absolute;
                                    left: -9999px;
                                }
                                .file-upload-label-exp {
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    padding: 10px 12px;
                                    background: #f9fafb;
                                    border: 1px dashed #d1d5db;
                                    border-radius: 4px;
                                    cursor: pointer;
                                    transition: all 0.2s;
                                    font-size: 0.85em;
                                }
                                .file-upload-label-exp:hover {
                                    background: #f3f4f6;
                                    border-color: #22c55e;
                                }
                                .file-upload-icon-exp {
                                    margin-right: 8px;
                                    font-size: 1.1em;
                                }
                                .file-upload-text-exp {
                                    color: #6b7280;
                                }
                                .file-name-display-exp {
                                    margin-top: 6px;
                                    font-size: 0.8em;
                                    color: #22c55e;
                                    font-weight: 500;
                                    text-align: center;
                                }
                            </style>
                            <div class="file-upload-wrapper-exp">
                                <input type="file" id="experiment" name="experiment" accept=".zip" onchange="displayExperimentFileName(this)">
                                <label for="experiment" class="file-upload-label-exp">
                                    <span class="file-upload-icon-exp">📦</span>
                                    <span class="file-upload-text-exp">Choose ZIP file...</span>
                                </label>
                                <div id="experiment-file-name-display" class="file-name-display-exp"></div>
                            </div>
                            <div class="button-wrap">
                                <button class="button is-solid primary-button is-fullwidth">
                                    Upload Experiment
                                </button>
                            </div>
                        </form>
                        <script>
                            function displayExperimentFileName(input) {
                                const display = document.getElementById('experiment-file-name-display');
                                if (input.files && input.files[0]) {
                                    display.textContent = '✓ ' + input.files[0].name;
                                } else {
                                    display.textContent = '';
                                }
                            }
                        </script>
                    </div>
                    {% endif %}


                </div>
            </div>
        </div>
    </div>

</div>

{% include "admin/footer.html" %}