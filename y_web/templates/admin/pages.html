{% include "admin/head.html" %}

<style>
    .sidebar-box {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 16px;
        margin-bottom: 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    .sidebar-box h3 {
        font-size: 1em;
        font-weight: 600;
        color: #1f2937;
        margin: 0 0 12px 0;
        padding-bottom: 8px;
        border-bottom: 1px solid #e5e7eb;
    }
    .sidebar-box .help-block {
        font-size: 0.85em;
        line-height: 1.5;
        color: #6b7280;
    }
    .sidebar-box .help-block p {
        margin: 0 0 10px 0;
    }
    .sidebar-box .help-block p:last-child {
        margin-bottom: 0;
    }
    .sidebar-box .help-block b {
        color: #374151;
        font-weight: 600;
    }
    .sidebar-box .input {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        font-size: 0.9em;
        transition: border-color 0.2s;
    }
    .sidebar-box .input:focus {
        outline: none;
        border-color: #22c55e;
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
    }
    .sidebar-box .button-wrap {
        margin-top: 12px;
    }
    .sidebar-box .button {
        width: 100%;
        padding: 8px 16px;
        font-size: 0.9em;
        font-weight: 500;
    }
</style>

<div class="view-wrapper is-dashboard">
    <!--Dashboard container-->
    <div id="creator-dashboard" class="dashboard-container">
        <!--Toolbar-->
        {% include "admin/dash_head.html" %}

        <div class="dashboard-body">
            <div class="columns">
                <div class="column is-12">

                    {% for message in get_flashed_messages() %}
                    <div class="alert alert-warning">
                        <button type="button" class="close" data-dismiss="alert">&times;</button>
                        {{ message }}
                    </div>
                    {% endfor %}

                    <div class="dashboard-box">
                        <h3 class="title is-5 is-thin">Available Pages</h3>

                        <div class="box-content">


                            <div id="table"></div>

                            <script src="{{ url_for('static', filename='assets/vendor/js/gridjs.umd.js') }}"></script>
                                <style>
                                  td[data-column-id="logo"] {
                                    padding: 0 !important;       /* Remove padding */
                                    text-align: center;          /* Center horizontally */
                                    vertical-align: middle;      /* Center vertically */
                                  }

                                  #table td {
                                    vertical-align: middle !important;
                                  }
                                </style>

                                <script>
                                    const tableDiv = document.getElementById('table');

                                    const updateUrl = (prev, query) => {
                                        return prev + (prev.indexOf('?') >= 0 ? '&' : '?') + new URLSearchParams(query).toString();
                                    };

                                    const editableCellAttributes = (data, row, col) => {
                                        if (row) {
                                            return {
                                                contentEditable: 'true',
                                                'data-element-id': row.cells[1].data, // id now at index 1 because of logo column
                                                'data-column-id': col.id
                                            };
                                        } else {
                                            return {};
                                        }
                                    };

                                    new gridjs.Grid({
                                        columns: [
                                            {
                                                id: 'logo',
                                                name: '',
                                                formatter: (cell, row) => {
                                                    return gridjs.html(`
                                                        <div style="display: flex; justify-content: center; align-items: center; height: 100%; width: 100%;">
                                                            <img src="${cell}" alt="logo" style="height: 25px; object-fit: contain; margin: 0; padding: 0; display: block;">
                                                        </div>
                                                    `);
                                                },
                                                sort: false,
                                                searchable: false,
                                                width: '60px',
                                            },
                                            { id: 'id', hidden: true },
                                            { id: 'name', name: 'Name', attributes: editableCellAttributes },
                                            { id: 'page_type', name: 'Type' },
                                            { id: 'leaning', name: 'Political Leaning' },
                                            {
                                                id: 'activity_profile',
                                                name: 'Activity Profile',
                                                sort: false,
                                                formatter: (cell) => {
                                                    if (!cell || cell.length === 0) {
                                                        return '';
                                                    }
                                                    const tags = cell.map(profile =>
                                                        `<span style="display: inline-block; background-color: #039be5; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.75rem; margin: 2px;">${profile}</span>`
                                                    ).join(' ');
                                                    return gridjs.html(`<div style="display: flex; flex-wrap: wrap; gap: 4px;">${tags}</div>`);
                                                }
                                            },
                                            {
                                                id: 'actions',
                                                name: 'Actions',
                                                formatter: (cell, row) => {
                                                    const id = row.cells[1].data; // id at index 1
                                                    return gridjs.html(`
                                                        <div style="display: flex; gap: 8px; justify-content: center;">
                                                            <a href="/admin/page_details/${id}"
                                                               style="background-color: #28a745; color: white; padding: 6px 12px; border-radius: 4px; text-decoration: none; font-size: 0.85rem;">
                                                                Details
                                                            </a>
                                                            <a href="/admin/delete_page/${id}"
                                                                style="background-color: #dc3545; color: white; padding: 6px 12px; border-radius: 4px; text-decoration: none; font-size: 0.85rem;">
                                                                Delete
                                                              </a>
                                                        </div>
                                                    `);
                                                }
                                            },
                                        ],
                                        server: {
                                            url: '/admin/pages_data',
                                            then: results => results.data,
                                            total: results => results.total,
                                        },
                                        search: {
                                            enabled: true,
                                            server: {
                                                url: (prev, search) => {
                                                    return updateUrl(prev, { search });
                                                },
                                            },
                                        },
                                        sort: {
                                            enabled: true,
                                            multiColumn: true,
                                            server: {
                                                url: (prev, columns) => {
                                                    const columnIds = ['logo', 'id', 'name', 'page_type', 'leaning', 'activity_profiles'];
                                                    const sort = columns.map(col => (col.direction === 1 ? '+' : '-') + columnIds[col.index]);
                                                    return updateUrl(prev, { sort });
                                                },
                                            },
                                        },
                                        pagination: {
                                            enabled: true,
                                            server: {
                                                url: (prev, page, limit) => {
                                                    return updateUrl(prev, { start: page * limit, length: limit });
                                                },
                                            },
                                        },
                                    }).render(tableDiv);

                                    let savedValue;

                                    // Inline editing
                                    tableDiv.addEventListener('focusin', ev => {
                                        if (ev.target.tagName === 'TD') {
                                            savedValue = ev.target.textContent;
                                        }
                                    });

                                    tableDiv.addEventListener('focusout', ev => {
                                        if (ev.target.tagName === 'TD') {
                                            if (savedValue !== ev.target.textContent) {
                                                fetch('/admin/pages_data', {
                                                    method: 'POST',
                                                    headers: { 'Content-Type': 'application/json' },
                                                    body: JSON.stringify({
                                                        id: ev.target.dataset.elementId,
                                                        [ev.target.dataset.columnId]: ev.target.textContent
                                                    }),
                                                });
                                            }
                                            savedValue = undefined;
                                        }
                                    });

                                    tableDiv.addEventListener('keydown', ev => {
                                        if (ev.target.tagName === 'TD') {
                                            if (ev.key === 'Escape') {
                                                ev.target.textContent = savedValue;
                                                ev.target.blur();
                                            } else if (ev.key === 'Enter') {
                                                ev.preventDefault();
                                                ev.target.blur();
                                            }
                                        }
                                    });

                                    // Delete button handler
                                    tableDiv.addEventListener('click', function (event) {
                                        const target = event.target;
                                        if (target.classList.contains('delete-button')) {
                                            const id = target.getAttribute('data-id');
                                            if (confirm('Are you sure you want to delete this page?')) {
                                                fetch(`/admin/delete_page/${id}`, {
                                                    method: 'DELETE',
                                                })
                                                .then(response => {
                                                    if (!response.ok) throw new Error('Failed to delete');
                                                    location.reload();
                                                })
                                                .catch(err => {
                                                    alert('Error deleting page.');
                                                    console.error(err);
                                                });
                                            }
                                        }
                                    });
                                </script>

                        </div>
                    </div>
                </div>

            </div>

            <div class="columns">
                <!--Dashboard column-->
                <div class="column is-8">
                    <!--Dashboard box-->

                    <div class="dashboard-box">
                        <h3 class="title is-5 is-thin">Create Page</h3>
                        <div class="box-content">
                            <form action="/admin/create_page" enctype="multipart/form-data" method="POST" onsubmit="showLoading('Creating page...');">
                                <div class="box-lines">

                                    <div class="box-line">
                                        <span class="left">Page Name</span>
                                        <span class="right" style="width: 70%;"><input type="text" name="name"
                                                                                       class="input"></span>
                                    </div>
                                    <div class="box-line">
                                        <span class="left">Description</span>
                                        <span class="right" style="width: 70%;"><input type="text" name="descr"
                                                                                       class="input"></span>
                                    </div>
                                    <div class="box-line">
                                        <span class="left">Type</span>
                                        <div class="select">
                                            <select name="page_type">
                                                <option value="media">Media Page</option>
                                                <option value="other">Other</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="box-line">
                                        <span class="left">Political Leaning</span>
                                        <div class="select">
                                            <select name="leaning">
                                                <option value=""></option>
                                                {% for leaning in leanings %}
                                                <option value="{{ leaning.leaning }}">{{ leaning.leaning }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="box-line">
                                        <span class="left">RSS Feed</span>
                                        <span class="right" style="width: 70%;"><input type="text" name="feed"
                                                                                       class="input"></span>
                                    </div>

                                    <div class="box-line">
                                        <span class="left">Logo Image<small>(public url)</small></span>
                                        <span class="right" style="width: 70%;"><input type="text" name="logo"
                                                                                       class="input"></span>
                                    </div>

                                    <hr>
                                    <style>
                                        .form-section-header-page {
                                            font-size: 0.95em;
                                            font-weight: 600;
                                            color: #333;
                                            margin: 15px 0 8px 0;
                                        }
                                        .form-section-description-page {
                                            font-size: 0.85em;
                                            color: #666;
                                            margin-bottom: 15px;
                                            line-height: 1.4;
                                        }
                                    </style>

                                    <div class="form-section-header-page">Activity Profile</div>
                                    <div class="form-section-description-page">
                                        Select when this page will be active for posting content. The default "Always On" profile keeps the page active 24/7.
                                    </div>
                                    <div class="box-line">
                                        <span class="left">Activity Pattern</span>
                                        
                                            <div class="select">
                                                <select name="activity_profile" id="activity_profile_select">
                                                    {% if activity_profiles %}
                                                        {% for profile in activity_profiles %}
                                                        <option value="{{ profile.id }}" {% if profile.name == 'Always On' %}selected{% endif %}>
                                                            {{ profile.name }}
                                                        </option>
                                                        {% endfor %}
                                                    {% endif %}
                                                </select>
                                            </div>

                                    </div>

                                </div>
                                <div class="button-wrap">
                                    <button class="button is-solid primary-button is-fullwidth">
                                        Create
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <!--Dashboard box-->

                </div>


                <!--Dashboard column-->
                <div class="column is-4">
                    <!--Box-->
                    <div class="sidebar-box">
                        <h3>Guide</h3>
                        <div class="help-block">

                            <p>
                                <b>Pages</b>
                                are a particular type of synthetic agent that can be used to display information to users.
                                Each page has a name, description, type, and keywords.
                            </p>

                            <p>
                                <b>News.</b><br>
                                Each News Page is associated with an RSS feed - the feed is used to populate, in real time, the page timeline with real-world articles.
                                <br><br>
                                <b>Articles'</b> topics are annotated by the LLM: such tagging allows to dynamically introduce novel topics among the interests of the agents that interact with the news source.

                            </p>
                        </div>
                    </div>

                    <div class="sidebar-box">
                        <h3>Load Pages Collection</h3>
                        <form action="/admin/upload_page_collection" enctype="multipart/form-data" method="POST">
                            <style>
                                .file-upload-wrapper-pages {
                                    position: relative;
                                    overflow: hidden;
                                    display: block;
                                    margin-bottom: 12px;
                                }
                                .file-upload-wrapper-pages input[type=file] {
                                    position: absolute;
                                    left: -9999px;
                                }
                                .file-upload-label-pages {
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    padding: 10px 12px;
                                    background: #f9fafb;
                                    border: 1px dashed #d1d5db;
                                    border-radius: 4px;
                                    cursor: pointer;
                                    transition: all 0.2s;
                                    font-size: 0.85em;
                                }
                                .file-upload-label-pages:hover {
                                    background: #f3f4f6;
                                    border-color: #22c55e;
                                }
                                .file-upload-icon-pages {
                                    margin-right: 8px;
                                    font-size: 1.1em;
                                }
                                .file-upload-text-pages {
                                    color: #6b7280;
                                }
                                .file-name-display-pages {
                                    margin-top: 6px;
                                    font-size: 0.8em;
                                    color: #22c55e;
                                    font-weight: 500;
                                    text-align: center;
                                }
                            </style>
                            <div class="file-upload-wrapper-pages">
                                <input type="file" id="collection_file" name="collection" accept=".json" onchange="displayPageCollectionFileName(this)">
                                <label for="collection_file" class="file-upload-label-pages">
                                    <span class="file-upload-icon-pages">üìÅ</span>
                                    <span class="file-upload-text-pages">Choose JSON file...</span>
                                </label>
                                <div id="collection-file-name-display" class="file-name-display-pages"></div>
                            </div>
                            <div class="button-wrap">
                                <button class="button is-solid primary-button is-fullwidth">
                                    Upload Collection
                                </button>
                            </div>
                        </form>
                        <script>
                            function displayPageCollectionFileName(input) {
                                const display = document.getElementById('collection-file-name-display');
                                if (input.files && input.files[0]) {
                                    display.textContent = '‚úì ' + input.files[0].name;
                                } else {
                                    display.textContent = '';
                                }
                            }
                        </script>
                    </div>


                </div>
            </div>
        </div>
    </div>

</div>



{% include "admin/footer.html" %}