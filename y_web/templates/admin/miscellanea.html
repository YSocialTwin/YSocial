{% include "admin/head.html" %}

<div class="view-wrapper is-dashboard">
    <!--Dashboard container-->
    <div id="creator-dashboard" class="dashboard-container">
        <!--Toolbar-->
        {% include "admin/dash_head.html" %}

        <div class="dashboard-body">

            <style>
                .misc-tabs {
                    display: flex;
                    border-bottom: 2px solid #e5e7eb;
                    margin-bottom: 20px;
                    flex-wrap: wrap;
                }
                .misc-tab {
                    padding: 12px 24px;
                    cursor: pointer;
                    border: none;
                    background: transparent;
                    font-size: 0.95em;
                    font-weight: 500;
                    color: #666;
                    transition: all 0.2s;
                    border-bottom: 3px solid transparent;
                    margin-bottom: -2px;
                }
                .misc-tab:hover {
                    color: #22c55e;
                    background: rgba(34, 197, 94, 0.05);
                }
                .misc-tab.active {
                    color: #22c55e;
                    border-bottom-color: #22c55e;
                }
                .misc-tab-content {
                    display: none;
                }
                .misc-tab-content.active {
                    display: block;
                }
                .misc-section-description {
                    background: #f9fafb;
                    border-left: 3px solid #22c55e;
                    padding: 15px 20px;
                    margin-bottom: 20px;
                    border-radius: 4px;
                    font-size: 0.9em;
                    color: #666;
                    line-height: 1.6;
                }
            </style>

            <div class="misc-tabs">
                <button class="misc-tab active" onclick="switchMiscTab('demographics')">Demographics & Attributes</button>
                <button class="misc-tab" onclick="switchMiscTab('content-behavior')">Content & Behavior</button>
                <button class="misc-tab" onclick="switchMiscTab('system-settings')">System Settings</button>
                {% if llm_backend['backend'] is not none %}
                <button class="misc-tab" onclick="switchMiscTab('llm-management')">LLM Management</button>
                {% endif %}
            </div>

            <!-- Demographics & Attributes Tab (merged Agent Attributes + Demographics) -->
            <div id="tab-demographics" class="misc-tab-content active">
                <div class="misc-section-description">
                    <strong>Demographics & Attributes:</strong> Configure demographic characteristics (languages, nationalities) and social attributes (political leanings, education levels, professions) that define the agents in your simulations.
                </div>

                <style>
                    .misc-grid {
                        display: grid;
                        grid-template-columns: repeat(3, 1fr);
                        gap: 20px;
                        margin-bottom: 20px;
                    }
                    
                    @media (max-width: 1400px) {
                        .misc-grid {
                            grid-template-columns: repeat(2, 1fr);
                        }
                    }
                    
                    @media (max-width: 768px) {
                        .misc-grid {
                            grid-template-columns: 1fr;
                        }
                    }
                    
                    .misc-compact-box {
                        background: #fff;
                        border: 1px solid #e5e7eb;
                        border-radius: 8px;
                        padding: 16px;
                        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
                        transition: box-shadow 0.2s;
                    }
                    
                    .misc-compact-box:hover {
                        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    }
                    
                    .misc-compact-box h3 {
                        font-size: 1em;
                        font-weight: 600;
                        margin-bottom: 12px;
                        color: #1f2937;
                        border-bottom: 1px solid #e5e7eb;
                        padding-bottom: 8px;
                    }
                    
                    .misc-compact-box .box-content {
                        margin-top: 12px;
                    }
                    
                    .misc-compact-box .input {
                        font-size: 0.9em;
                        padding: 6px 10px;
                    }
                    
                    .misc-compact-box .button {
                        font-size: 0.9em;
                        padding: 8px 12px;
                    }
                    
                    .misc-compact-box #leaning_table,
                    .misc-compact-box #edu_table,
                    .misc-compact-box #profession_table,
                    .misc-compact-box #language_table,
                    .misc-compact-box #nationality_table {
                        font-size: 0.85em;
                    }
                    
                    .misc-compact-box .box-lines {
                        margin-top: 12px;
                    }
                    
                    .misc-compact-box .box-line {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        margin-bottom: 8px;
                    }
                    
                    .misc-compact-box .box-line .left {
                        flex: 0 0 auto;
                        font-size: 0.85em;
                        font-weight: 500;
                        color: #374151;
                        min-width: 60px;
                    }
                    
                    .misc-compact-box .box-line .right {
                        flex: 1;
                    }
                </style>

                <div class="misc-grid">
                    <div class="misc-compact-box">
                        <h3>Political Leanings</h3>

                        <div class="box-content">


                            <div id="leaning_table"></div>

                            <script src="{{ url_for('static', filename='assets/vendor/js/gridjs.umd.js') }}"></script>
                            <script>
    const tableDiv = document.getElementById('leaning_table');

    const updateUrl = (prev, query) => {
        return prev + (prev.indexOf('?') >= 0 ? '&' : '?') + new URLSearchParams(query).toString();
    };

    const editableCellAttributes = (data, row, col) => {
        if (row) {
            return {
                contentEditable: 'true',
                'data-element-id': row.cells[0].data,
                'data-column-id': 'leaning'
            };
        } else {
            return {};
        }
    };

    const grid = new gridjs.Grid({
        columns: [
            { id: 'id', hidden: true },
            {
                id: 'leaning',
                name: 'Name',
                attributes: editableCellAttributes
            },
            {
                name: 'Actions',
                attributes: () => ({ style: 'text-align: center;' }),
                formatter: (cell, row) => {
                    return gridjs.h(
                        'div',
                        { style: 'display: flex; justify-content: center;' },
                        gridjs.h(
                            'button',
                            {
                                className: 'btn btn-sm btn-danger',
                                onClick: () => {
                                    const id = row.cells[0].data;
                                    fetch(`/admin/delete_leaning/${id}`, {
                                        method: 'DELETE',
                                    }).then(res => {
                                        if (res.ok) {
                                            grid.forceRender();
                                        } else {
                                            alert("Failed to delete leaning.");
                                        }
                                    });
                                }
                            },
                            'Delete'
                        )
                    );
                }
            }
        ],
        server: {
            url: '/admin/leanings_data',
            then: results => results.data,
            total: results => results.total,
        },
        search: {
            enabled: true,
            server: {
                url: (prev, search) => updateUrl(prev, { search }),
            },
        },
        sort: {
            enabled: true,
            multiColumn: true,
            server: {
                url: (prev, columns) => {
                    const columnIds = ['id', 'leaning'];
                    const sort = columns.map(col => (col.direction === 1 ? '+' : '-') + columnIds[col.index]);
                    return updateUrl(prev, { sort });
                },
            },
        },
        pagination: {
            limit: 5,
            enabled: true,
            server: {
                url: (prev, page, limit) => updateUrl(prev, { start: page * limit, length: limit }),
            },
        },
    });

    grid.render(tableDiv);

    // Inline edit tracking
    let savedValue;

    tableDiv.addEventListener('focusin', ev => {
        if (ev.target.tagName === 'TD') {
            savedValue = ev.target.textContent;
        }
    });

    tableDiv.addEventListener('focusout', ev => {
        if (ev.target.tagName === 'TD' && ev.target.dataset.elementId) {
            if (savedValue !== ev.target.textContent) {
                fetch('/admin/leanings_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: ev.target.dataset.elementId,
                        [ev.target.dataset.columnId]: ev.target.textContent
                    }),
                });
            }
            savedValue = undefined;
        }
    });

    tableDiv.addEventListener('keydown', ev => {
        if (ev.target.tagName === 'TD') {
            if (ev.key === 'Escape') {
                ev.target.textContent = savedValue;
                ev.target.blur();
            } else if (ev.key === 'Enter') {
                ev.preventDefault();
                ev.target.blur();
            }
        }
    });
</script>


                        </div>

                        <div class="box-content" style="margin-top: 30px;">
                            <h4 style="font-size: 0.9em; font-weight: 600; margin-bottom: 10px;">New Political Leaning</h4>
                            <form action="/admin/create_leaning" method="POST">
                                <div class="box-lines">
                                    <div class="box-line">
                                        <span class="left">Name</span>
                                        <span class="right" ><input type="text" name="leaning"
                                                                                       class="input"></span>
                                    </div>
                                </div>
                                <div class="button-wrap">
                                    <button class="button is-solid primary-button is-fullwidth">
                                        Create
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="misc-compact-box">
                        <h3>Education Levels</h3>

                        <div class="box-content">


                            <div id="edu_table"></div>

                            <script src="{{ url_for('static', filename='assets/vendor/js/gridjs.umd.js') }}"></script>
                            <script>
    const tableDiv5 = document.getElementById('edu_table');

    const updateUrl5 = (prev, query) => {
        return prev + (prev.indexOf('?') >= 0 ? '&' : '?') + new URLSearchParams(query).toString();
    };

    const editableCellAttributes5 = (data, row, col) => {
        if (row) {
            return {
                contentEditable: 'true',
                'data-element-id': row.cells[0].data,
                'data-column-id': 'education_level'
            };
        } else {
            return {};
        }
    };

    const grid5 = new gridjs.Grid({
        columns: [
            { id: 'id', hidden: true },
            {
                id: 'education_level',
                name: 'Name',
                attributes: editableCellAttributes5
            },
            {
                name: 'Actions',
                attributes: () => ({ style: 'text-align: center;' }),
                formatter: (cell, row) => {
                    return gridjs.h(
                        'div',
                        { style: 'display: flex; justify-content: center;' },
                        gridjs.h(
                            'button',
                            {
                                className: 'btn btn-sm btn-danger',
                                onClick: () => {
                                    const id = row.cells[0].data;
                                    fetch(`/admin/delete_education/${id}`, {
                                        method: 'DELETE',
                                    }).then(res => {
                                        if (res.ok) {
                                            grid5.forceRender();
                                        } else {
                                            alert("Failed to delete education level.");
                                        }
                                    });
                                }
                            },
                            'Delete'
                        )
                    );
                }
            }
        ],
        server: {
            url: '/admin/educations_data',
            then: results => results.data,
            total: results => results.total,
        },
        search: {
            enabled: true,
            server: {
                url: (prev, search) => updateUrl5(prev, { search }),
            },
        },
        sort: {
            enabled: true,
            multiColumn: true,
            server: {
                url: (prev, columns) => {
                    const columnIds = ['id', 'education_level'];
                    const sort = columns.map(col => (col.direction === 1 ? '+' : '-') + columnIds[col.index]);
                    return updateUrl5(prev, { sort });
                },
            },
        },
        pagination: {
            limit: 5,
            enabled: true,
            server: {
                url: (prev, page, limit) => updateUrl5(prev, { start: page * limit, length: limit }),
            },
        },
    });

    grid5.render(tableDiv5);

    // Inline editing
    let savedValue5;

    tableDiv5.addEventListener('focusin', ev => {
        if (ev.target.tagName === 'TD') {
            savedValue5 = ev.target.textContent;
        }
    });

    tableDiv5.addEventListener('focusout', ev => {
        if (ev.target.tagName === 'TD' && ev.target.dataset.elementId) {
            if (savedValue5 !== ev.target.textContent) {
                fetch('/admin/educations_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: ev.target.dataset.elementId,
                        [ev.target.dataset.columnId]: ev.target.textContent
                    }),
                });
            }
            savedValue5 = undefined;
        }
    });

    tableDiv5.addEventListener('keydown', ev => {
        if (ev.target.tagName === 'TD') {
            if (ev.key === 'Escape') {
                ev.target.textContent = savedValue5;
                ev.target.blur();
            } else if (ev.key === 'Enter') {
                ev.preventDefault();
                ev.target.blur();
            }
        }
    });
</script>


                        </div>

                        <div class="box-content" style="margin-top: 30px;">
                            <h4 style="font-size: 0.9em; font-weight: 600; margin-bottom: 10px;">New Education Level</h4>
                            <form action="/admin/create_education" method="POST">
                                <div class="box-lines">
                                    <div class="box-line">
                                        <span class="left">Name</span>
                                        <span class="right" ><input type="text" name="education_level"
                                                                                       class="input"></span>
                                    </div>
                                </div>
                                <div class="button-wrap">
                                    <button class="button is-solid primary-button is-fullwidth">
                                        Create
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="misc-compact-box">
                        <h3>Professions</h3>

                        <div class="box-content">
                            <div id="profession_table"></div>

                            <script src="{{ url_for('static', filename='assets/vendor/js/gridjs.umd.js') }}"></script>
                            <script>
    const tableDiv4 = document.getElementById('profession_table');

    const updateUrl4 = (prev, query) => {
        return prev + (prev.indexOf('?') >= 0 ? '&' : '?') + new URLSearchParams(query).toString();
    };

    const editableCellAttributes4 = (data, row, col) => {
        if (row) {
            const columnId = col.id;
            return {
                contentEditable: 'true',
                'data-element-id': row.cells[0].data,
                'data-column-id': columnId
            };
        } else {
            return {};
        }
    };

    const grid4 = new gridjs.Grid({
        columns: [
            { id: 'id', hidden: true },
            {
                id: 'profession',
                name: 'Name',
                attributes: editableCellAttributes4
            },
            {
                id: 'background',
                name: 'Category',
                attributes: editableCellAttributes4
            },
            {
                name: 'Actions',
                attributes: () => ({ style: 'text-align: center;' }),
                formatter: (cell, row) => {
                    return gridjs.h(
                        'div',
                        { style: 'display: flex; justify-content: center;' },
                        gridjs.h(
                            'button',
                            {
                                className: 'btn btn-sm btn-danger',
                                onClick: () => {
                                    const id = row.cells[0].data;
                                    fetch(`/admin/delete_profession/${id}`, {
                                        method: 'DELETE',
                                    }).then(res => {
                                        if (res.ok) {
                                            grid4.forceRender();
                                        } else {
                                            alert("Failed to delete profession.");
                                        }
                                    });
                                }
                            },
                            'Delete'
                        )
                    );
                }
            }
        ],
        server: {
            url: '/admin/professions_data',
            then: results => results.data,
            total: results => results.total,
        },
        search: {
            enabled: true,
            server: {
                url: (prev, search) => updateUrl4(prev, { search }),
            },
        },
        sort: {
            enabled: true,
            multiColumn: true,
            server: {
                url: (prev, columns) => {
                    const columnIds = ['id', 'profession', 'background'];
                    const sort = columns.map(col => (col.direction === 1 ? '+' : '-') + columnIds[col.index]);
                    return updateUrl4(prev, { sort });
                },
            },
        },
        pagination: {
            limit: 5,
            enabled: true,
            server: {
                url: (prev, page, limit) => updateUrl4(prev, { start: page * limit, length: limit }),
            },
        },
    });

    grid4.render(tableDiv4);

    let savedValue4;

    tableDiv4.addEventListener('focusin', ev => {
        if (ev.target.tagName === 'TD') {
            savedValue4 = ev.target.textContent;
        }
    });

    tableDiv4.addEventListener('focusout', ev => {
        if (ev.target.tagName === 'TD' && ev.target.dataset.elementId) {
            if (savedValue4 !== ev.target.textContent) {
                fetch('/admin/professions_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: ev.target.dataset.elementId,
                        [ev.target.dataset.columnId]: ev.target.textContent
                    }),
                });
            }
            savedValue4 = undefined;
        }
    });

    tableDiv4.addEventListener('keydown', ev => {
        if (ev.target.tagName === 'TD') {
            if (ev.key === 'Escape') {
                ev.target.textContent = savedValue4;
                ev.target.blur();
            } else if (ev.key === 'Enter') {
                ev.preventDefault();
                ev.target.blur();
            }
        }
    });
</script>

                        </div>

                        <div class="box-content" style="margin-top: 30px;">
                            <h4 style="font-size: 0.9em; font-weight: 600; margin-bottom: 10px;">New Profession</h4>
                            <form action="/admin/create_profession" method="POST">
                                <div class="box-lines">
                                    <div class="box-line">
                                        <span class="left">Name</span>
                                        <span class="right" ><input type="text" name="profession"
                                                                                       class="input"></span>
                                    </div>
                                    <div class="box-line">
                                        <span class="left">Category</span>
                                        <span class="right" ><input type="text" name="background"
                                                                                       class="input"></span>
                                    </div>
                                </div>
                                <div class="button-wrap">
                                    <button class="button is-solid primary-button is-fullwidth">
                                        Create
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="misc-compact-box">
                        <h3>Languages</h3>

                        <div class="box-content">
                            <div id="language_table"></div>
                            <script>
    const tableDiv1 = document.getElementById('language_table');

    const updateUrl1 = (prev, query) => {
        return prev + (prev.indexOf('?') >= 0 ? '&' : '?') + new URLSearchParams(query).toString();
    };

    const editableCellAttributes1 = (data, row, col) => {
        if (row) {
            const columnId = col.id;
            return {
                contentEditable: 'true',
                'data-element-id': row.cells[0].data,
                'data-column-id': columnId
            };
        } else {
            return {};
        }
    };

    const grid1 = new gridjs.Grid({
        columns: [
            { id: 'id', hidden: true },
            {
                id: 'language',
                name: 'Name',
                attributes: editableCellAttributes1
            },
            {
                name: 'Actions',
                attributes: () => ({ style: 'text-align: center;' }),
                formatter: (cell, row) => {
                    return gridjs.h(
                        'div',
                        { style: 'display: flex; justify-content: center;' },
                        gridjs.h(
                            'button',
                            {
                                className: 'btn btn-sm btn-danger',
                                onClick: () => {
                                    const id = row.cells[0].data;
                                    fetch(`/admin/delete_language/${id}`, {
                                        method: 'DELETE',
                                    }).then(res => {
                                        if (res.ok) {
                                            grid1.forceRender();
                                        } else {
                                            alert("Failed to delete language.");
                                        }
                                    });
                                }
                            },
                            'Delete'
                        )
                    );
                }
            }
        ],
        server: {
            url: '/admin/languages_data',
            then: results => results.data,
            total: results => results.total,
        },
        search: {
            enabled: true,
            server: {
                url: (prev, search) => updateUrl1(prev, { search }),
            },
        },
        sort: {
            enabled: true,
            multiColumn: true,
            server: {
                url: (prev, columns) => {
                    const columnIds = ['id', 'language'];
                    const sort = columns.map(col => (col.direction === 1 ? '+' : '-') + columnIds[col.index]);
                    return updateUrl1(prev, { sort });
                },
            },
        },
        pagination: {
            limit: 5,
            enabled: true,
            limit: 5,
            server: {
                url: (prev, page, limit) => updateUrl1(prev, { start: page * limit, length: limit }),
            },
        },
    });

    grid1.render(tableDiv1);

    let savedValue1;

    tableDiv1.addEventListener('focusin', ev => {
        if (ev.target.tagName === 'TD') {
            savedValue1 = ev.target.textContent;
        }
    });

    tableDiv1.addEventListener('focusout', ev => {
        if (ev.target.tagName === 'TD' && ev.target.dataset.elementId) {
            if (savedValue1 !== ev.target.textContent) {
                fetch('/admin/languages_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: ev.target.dataset.elementId,
                        [ev.target.dataset.columnId]: ev.target.textContent
                    }),
                });
            }
            savedValue1 = undefined;
        }
    });

    tableDiv1.addEventListener('keydown', ev => {
        if (ev.target.tagName === 'TD') {
            if (ev.key === 'Escape') {
                ev.target.textContent = savedValue1;
                ev.target.blur();
            } else if (ev.key === 'Enter') {
                ev.preventDefault();
                ev.target.blur();
            }
        }
    });
</script>
                        </div>

                        <div class="box-content" style="margin-top: 30px;">
                            <h4 style="font-size: 0.9em; font-weight: 600; margin-bottom: 10px;">New Language</h4>
                            <form action="/admin/create_language" method="POST">
                                <div class="box-lines">
                                    <div class="box-line">
                                        <span class="left">Name</span>
                                        <span class="right"><input type="text" name="language" class="input"></span>
                                    </div>
                                </div>
                                <div class="button-wrap">
                                    <button class="button is-solid primary-button is-fullwidth">
                                        Create
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="misc-compact-box">
                        <h3>Nationalities</h3>

                        <div class="box-content">
                            <div id="nationality_table"></div>
                           <script>
    const tableDiv2 = document.getElementById('nationality_table');

    const updateUrl2 = (prev, query) => {
        return prev + (prev.indexOf('?') >= 0 ? '&' : '?') + new URLSearchParams(query).toString();
    };

    const editableCellAttributes2 = (data, row, col) => {
        if (row) {
            const columnId = col.id;
            return {
                contentEditable: 'true',
                'data-element-id': row.cells[0].data,
                'data-column-id': columnId
            };
        } else {
            return {};
        }
    };

    const grid2 = new gridjs.Grid({
        columns: [
            { id: 'id', hidden: true },
            {
                id: 'nationality',
                name: 'Name',
                attributes: editableCellAttributes2
            },
            {
                name: 'Actions',
                attributes: () => ({ style: 'text-align: center;' }),
                formatter: (cell, row) => {
                    return gridjs.h(
                        'div',
                        { style: 'display: flex; justify-content: center;' },
                        gridjs.h(
                            'button',
                            {
                                className: 'btn btn-sm btn-danger',
                                onClick: () => {
                                    const id = row.cells[0].data;
                                    fetch(`/admin/delete_nationality/${id}`, {
                                        method: 'DELETE',
                                    }).then(res => {
                                        if (res.ok) {
                                            grid2.forceRender();
                                        } else {
                                            alert("Failed to delete nationality.");
                                        }
                                    });
                                }
                            },
                            'Delete'
                        )
                    );
                }
            }
        ],
        server: {
            url: '/admin/nationalities_data',
            then: results => results.data,
            total: results => results.total,
        },
        search: {
            enabled: true,
            server: {
                url: (prev, search) => updateUrl2(prev, { search }),
            },
        },
        sort: {
            enabled: true,
            multiColumn: true,
            server: {
                url: (prev, columns) => {
                    const columnIds = ['id', 'nationality'];
                    const sort = columns.map(col => (col.direction === 1 ? '+' : '-') + columnIds[col.index]);
                    return updateUrl2(prev, { sort });
                },
            },
        },
        pagination: {
            limit: 5,
            enabled: true,
            limit: 5,
            server: {
                url: (prev, page, limit) => updateUrl2(prev, { start: page * limit, length: limit }),
            },
        },
    });

    grid2.render(tableDiv2);

    let savedValue2;

    tableDiv2.addEventListener('focusin', ev => {
        if (ev.target.tagName === 'TD') {
            savedValue2 = ev.target.textContent;
        }
    });

    tableDiv2.addEventListener('focusout', ev => {
        if (ev.target.tagName === 'TD' && ev.target.dataset.elementId) {
            if (savedValue2 !== ev.target.textContent) {
                fetch('/admin/nationalities_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: ev.target.dataset.elementId,
                        [ev.target.dataset.columnId]: ev.target.textContent
                    }),
                });
            }
            savedValue2 = undefined;
        }
    });

    tableDiv2.addEventListener('keydown', ev => {
        if (ev.target.tagName === 'TD') {
            if (ev.key === 'Escape') {
                ev.target.textContent = savedValue2;
                ev.target.blur();
            } else if (ev.key === 'Enter') {
                ev.preventDefault();
                ev.target.blur();
            }
        }
    });
</script>
                        </div>

                        <div class="box-content" style="margin-top: 30px;">
                            <h4 style="font-size: 0.9em; font-weight: 600; margin-bottom: 10px;">New Nationality</h4>
                            <form action="/admin/create_nationality" method="POST">
                                <div class="box-lines">
                                    <div class="box-line">
                                        <span class="left">Name</span>
                                        <span class="right"><input type="text" name="nationality" class="input"></span>
                                    </div>
                                </div>
                                <div class="button-wrap">
                                    <button class="button is-solid primary-button is-fullwidth">
                                        Create
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="misc-compact-box">
                        <h3>Age Classes</h3>

                        <div class="box-content">
                            <div id="age_classes_table"></div>

                            <script src="{{ url_for('static', filename='assets/vendor/js/gridjs.umd.js') }}"></script>
                            <script>
    const tableDivAgeClasses = document.getElementById('age_classes_table');

    const updateUrlAgeClasses = (prev, query) => {
        return prev + (prev.indexOf('?') >= 0 ? '&' : '?') + new URLSearchParams(query).toString();
    };

    const editableCellAttributesAgeClasses = (data, row, col) => {
        if (row) {
            const columnId = col.id;
            return {
                contentEditable: 'true',
                'data-element-id': row.cells[0].data,
                'data-column-id': columnId
            };
        } else {
            return {};
        }
    };

    const gridAgeClasses = new gridjs.Grid({
        columns: [
            { id: 'id', hidden: true },
            {
                id: 'name',
                name: 'Name',
                attributes: editableCellAttributesAgeClasses
            },
            {
                id: 'age_start',
                name: 'Age Start',
                attributes: editableCellAttributesAgeClasses
            },
            {
                id: 'age_end',
                name: 'Age End',
                attributes: editableCellAttributesAgeClasses
            },
            {
                name: 'Actions',
                attributes: () => ({ style: 'text-align: center;' }),
                formatter: (cell, row) => {
                    return gridjs.h(
                        'div',
                        { style: 'display: flex; justify-content: center;' },
                        gridjs.h(
                            'button',
                            {
                                className: 'btn btn-sm btn-danger',
                                onClick: () => {
                                    const id = row.cells[0].data;
                                    fetch(`/admin/delete_age_class/${id}`, {
                                        method: 'DELETE',
                                    }).then(res => {
                                        if (res.ok) {
                                            gridAgeClasses.forceRender();
                                        } else {
                                            alert("Failed to delete age class.");
                                        }
                                    });
                                }
                            },
                            'Delete'
                        )
                    );
                }
            }
        ],
        server: {
            url: '/admin/age_classes_data',
            then: results => results.data,
            total: results => results.total,
        },
        search: {
            enabled: true,
            server: {
                url: (prev, search) => updateUrlAgeClasses(prev, { search }),
            },
        },
        sort: {
            enabled: true,
            multiColumn: true,
            server: {
                url: (prev, columns) => {
                    const columnIds = ['id', 'name', 'age_start', 'age_end'];
                    const sort = columns.map(col => (col.direction === 1 ? '+' : '-') + columnIds[col.index]);
                    return updateUrlAgeClasses(prev, { sort });
                },
            },
        },
        pagination: {
            limit: 5,
            enabled: true,
            server: {
                url: (prev, page, limit) => updateUrlAgeClasses(prev, { start: page * limit, length: limit }),
            },
        },
    });

    gridAgeClasses.render(tableDivAgeClasses);

    // Inline editing
    let savedValueAgeClasses;

    tableDivAgeClasses.addEventListener('focusin', ev => {
        if (ev.target.tagName === 'TD') {
            savedValueAgeClasses = ev.target.textContent;
        }
    });

    tableDivAgeClasses.addEventListener('focusout', ev => {
        if (ev.target.tagName === 'TD' && ev.target.dataset.elementId) {
            if (savedValueAgeClasses !== ev.target.textContent) {
                fetch('/admin/age_classes_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: ev.target.dataset.elementId,
                        [ev.target.dataset.columnId]: ev.target.textContent
                    }),
                });
            }
            savedValueAgeClasses = undefined;
        }
    });

    tableDivAgeClasses.addEventListener('keydown', ev => {
        if (ev.target.tagName === 'TD') {
            if (ev.key === 'Escape') {
                ev.target.textContent = savedValueAgeClasses;
                ev.target.blur();
            } else if (ev.key === 'Enter') {
                ev.preventDefault();
                ev.target.blur();
            }
        }
    });
</script>
                        </div>

                        <div class="box-content" style="margin-top: 30px;">
                            <h4 style="font-size: 0.9em; font-weight: 600; margin-bottom: 10px;">New Age Class</h4>
                            <form action="/admin/create_age_class" method="POST">
                                <div class="box-lines">
                                    <div class="box-line">
                                        <span class="left">Name</span>
                                        <span class="right"><input type="text" name="name" class="input" required></span>
                                    </div>
                                    <div class="box-line">
                                        <span class="left">Age Start</span>
                                        <span class="right"><input type="number" name="age_start" class="input" min="0" max="150" value="0" required></span>
                                    </div>
                                    <div class="box-line">
                                        <span class="left">Age End</span>
                                        <span class="right"><input type="number" name="age_end" class="input" min="0" max="150" value="100" required></span>
                                    </div>
                                </div>
                                <div class="button-wrap">
                                    <button class="button is-solid primary-button is-fullwidth">
                                        Create
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Demographics & Attributes Tab -->



            <!-- Content & Behavior Tab -->
            <div id="tab-content-behavior" class="misc-tab-content">
                <div class="misc-section-description">
                    <strong>Content & Behavior:</strong> Define content topics, toxicity levels, and activity patterns to create realistic agent behaviors and content interactions within your simulations.
                </div>

                <div class="misc-grid">
                    <div class="misc-compact-box">
                        <h3>Topics</h3>

                        <div class="box-content">
                            <div id="topics_table"></div>

                            <script src="{{ url_for('static', filename='assets/vendor/js/gridjs.umd.js') }}"></script>
                            <script>
    const tableDiv6 = document.getElementById('topics_table');

    const updateUrl6 = (prev, query) => {
        return prev + (prev.indexOf('?') >= 0 ? '&' : '?') + new URLSearchParams(query).toString();
    };

    const editableCellAttributes6 = (data, row, col) => {
        if (row) {
            return {
                contentEditable: 'true',
                'data-element-id': row.cells[0].data,
                'data-column-id': 'name'
            };
        } else {
            return {};
        }
    };

    const grid6 = new gridjs.Grid({
        columns: [
            { id: 'id', hidden: true },
            {
                id: 'name',
                name: 'Name',
                attributes: editableCellAttributes6
            },
            {
                name: 'Actions',
                attributes: () => ({ style: 'text-align: center;' }),
                formatter: (cell, row) => {
                    return gridjs.h(
                        'div',
                        { style: 'display: flex; justify-content: center;' },
                        gridjs.h(
                            'button',
                            {
                                className: 'btn btn-sm btn-danger',
                                onClick: () => {
                                    const id = row.cells[0].data;
                                    fetch(`/admin/delete_topic/${id}`, {
                                        method: 'DELETE',
                                    }).then(res => {
                                        if (res.ok) {
                                            grid6.forceRender(); // refresh table
                                        } else {
                                            alert("Failed to delete topic.");
                                        }
                                    });
                                }
                            },
                            'Delete'
                        )
                    );
                }
            }
        ],
        server: {
            url: '/admin/topic_data',
            then: results => results.data,
            total: results => results.total,
        },
        search: {
            enabled: true,
            server: {
                url: (prev, search) => updateUrl6(prev, { search }),
            },
        },
        sort: {
            enabled: true,
            multiColumn: true,
            server: {
                url: (prev, columns) => {
                    const columnIds = ['id', 'name'];
                    const sort = columns.map(col => (col.direction === 1 ? '+' : '-') + columnIds[col.index]);
                    return updateUrl6(prev, { sort });
                },
            },
        },
        pagination: {
            limit: 5,
            enabled: true,
            server: {
                url: (prev, page, limit) => updateUrl6(prev, { start: page * limit, length: limit }),
            },
        },
    });

    grid6.render(tableDiv6);

    // Handle inline editing
    let savedValue6;

    tableDiv6.addEventListener('focusin', ev => {
        if (ev.target.tagName === 'TD') {
            savedValue6 = ev.target.textContent;
        }
    });

    tableDiv6.addEventListener('focusout', ev => {
        if (ev.target.tagName === 'TD' && ev.target.dataset.elementId) {
            if (savedValue6 !== ev.target.textContent) {
                fetch('/admin/topic_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: ev.target.dataset.elementId,
                        [ev.target.dataset.columnId]: ev.target.textContent
                    }),
                });
            }
            savedValue6 = undefined;
        }
    });

    tableDiv6.addEventListener('keydown', ev => {
        if (ev.target.tagName === 'TD') {
            if (ev.key === 'Escape') {
                ev.target.textContent = savedValue6;
                ev.target.blur();
            } else if (ev.key === 'Enter') {
                ev.preventDefault();
                ev.target.blur();
            }
        }
    });
</script>
                        </div>

                        <div class="box-content" style="margin-top: 30px;">
                            <h4 style="font-size: 0.9em; font-weight: 600; margin-bottom: 10px;">New Topic</h4>
                            <form action="/admin/create_topic" method="POST">
                                <div class="box-lines">
                                    <div class="box-line">
                                        <span class="left">Name</span>
                                        <span class="right"><input type="text" name="topic" class="input"></span>
                                    </div>
                                </div>
                                <div class="button-wrap">
                                    <button class="button is-solid primary-button is-fullwidth">
                                        Create
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="misc-compact-box">
                        <h3>Toxicity Levels</h3>

                        <div class="box-content">
                            <div id="toxicity_table"></div>
                           <script>
    const tableDiv3 = document.getElementById('toxicity_table');

    const updateUrl3 = (prev, query) => {
        return prev + (prev.indexOf('?') >= 0 ? '&' : '?') + new URLSearchParams(query).toString();
    };

    const editableCellAttributes3 = (data, row, col) => {
        if (row) {
            const columnId = col.id;
            return {
                contentEditable: 'true',
                'data-element-id': row.cells[0].data,
                'data-column-id': columnId
            };
        } else {
            return {};
        }
    };

    const grid3 = new gridjs.Grid({
        columns: [
            { id: 'id', hidden: true },
            {
                id: 'toxicity_level',
                name: 'Name',
                attributes: editableCellAttributes3
            },
            {
                name: 'Actions',
                attributes: () => ({ style: 'text-align: center;' }),
                formatter: (cell, row) => {
                    return gridjs.h(
                        'div',
                        { style: 'display: flex; justify-content: center;' },
                        gridjs.h(
                            'button',
                            {
                                className: 'btn btn-sm btn-danger',
                                onClick: () => {
                                    const id = row.cells[0].data;
                                    fetch(`/admin/delete_toxicity_level/${id}`, {
                                        method: 'DELETE',
                                    }).then(res => {
                                        if (res.ok) {
                                            grid3.forceRender();
                                        } else {
                                            alert("Failed to delete toxicity level.");
                                        }
                                    });
                                }
                            },
                            'Delete'
                        )
                    );
                }
            }
        ],
        server: {
            url: '/admin/toxicity_levels_data',
            then: results => results.data,
            total: results => results.total,
        },
        search: {
            enabled: true,
            server: {
                url: (prev, search) => updateUrl3(prev, { search }),
            },
        },
        sort: {
            enabled: true,
            multiColumn: true,
            server: {
                url: (prev, columns) => {
                    const columnIds = ['id', 'toxicity_level'];
                    const sort = columns.map(col => (col.direction === 1 ? '+' : '-') + columnIds[col.index]);
                    return updateUrl3(prev, { sort });
                },
            },
        },
        pagination: {
            limit: 5,
            enabled: true,
            server: {
                url: (prev, page, limit) => updateUrl3(prev, { start: page * limit, length: limit }),
            },
        },
    });

    grid3.render(tableDiv3);

    let savedValue3;

    tableDiv3.addEventListener('focusin', ev => {
        if (ev.target.tagName === 'TD') {
            savedValue3 = ev.target.textContent;
        }
    });

    tableDiv3.addEventListener('focusout', ev => {
        if (ev.target.tagName === 'TD' && ev.target.dataset.elementId) {
            if (savedValue3 !== ev.target.textContent) {
                fetch('/admin/toxicity_levels_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: ev.target.dataset.elementId,
                        [ev.target.dataset.columnId]: ev.target.textContent
                    }),
                });
            }
            savedValue3 = undefined;
        }
    });

    tableDiv3.addEventListener('keydown', ev => {
        if (ev.target.tagName === 'TD') {
            if (ev.key === 'Escape') {
                ev.target.textContent = savedValue3;
                ev.target.blur();
            } else if (ev.key === 'Enter') {
                ev.preventDefault();
                ev.target.blur();
            }
        }
    });
</script>

                        </div>


                        <div class="box-content" style="margin-top: 30px;">
                            <h4 style="font-size: 0.9em; font-weight: 600; margin-bottom: 10px;">New Toxicity Level</h4>
                            <form action="/admin/create_toxicity_level" method="POST">
                                <div class="box-lines">
                                    <div class="box-line">
                                        <span class="left">Name</span>
                                        <span class="right" ><input type="text" name="toxicity_level"
                                                                                       class="input"></span>
                                    </div>
                                </div>
                                <div class="button-wrap">
                                    <button class="button is-solid primary-button is-fullwidth">
                                        Create
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Activity Profiles in its own row spanning 2 columns -->
                <div class="misc-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="misc-compact-box" style="grid-column: span 2;">
                        <h3>Activity Profiles</h3>

                        <div class="box-content">
                            <div id="activity_profiles_table"></div>
                           <script>
    const tableDivActivity = document.getElementById('activity_profiles_table');

    const updateUrlActivity = (prev, query) => {
        return prev + (prev.indexOf('?') >= 0 ? '&' : '?') + new URLSearchParams(query).toString();
    };

    const editableCellAttributesActivity = (data, row, col) => {
        if (row && col.id === 'name') {
            return {
                contentEditable: 'true',
                'data-element-id': row.cells[0].data,
                'data-column-id': col.id
            };
        } else {
            return {};
        }
    };

    const gridActivity = new gridjs.Grid({
        columns: [
            { id: 'id', hidden: true },
            {
                id: 'name',
                name: 'Name',
                attributes: editableCellAttributesActivity,
                width: '10%'
            },
            {
                id: 'hours',
                name: 'Activity Hours',
                width: '80%',
                formatter: (cell) => {
                    const hours = cell ? cell.split(',').map(h => parseInt(h.trim())) : [];
                    const barHtml = Array.from({length: 24}, (_, i) => {
                        const isActive = hours.includes(i);
                        const intensity = isActive ? 1 : 0;
                        const bgColor = isActive ? 'rgba(34, 197, 94, 0.8)' : 'rgba(229, 231, 235, 0.5)';
                        return `<div style="display: inline-block; width: 4%; height: 20px; background-color: ${bgColor}; border: 1px solid #e5e7eb; margin: 0; title='Hour ${i}'" title="Hour ${i}"></div>`;
                    }).join('');
                    return gridjs.html(`<div style="display: flex; width: 100%; gap: 0;">${barHtml}</div>`);
                }
            },
            {
                name: 'Actions',
                attributes: () => ({ style: 'text-align: center;' }),
                width: '10%',
                formatter: (cell, row) => {
                    return gridjs.h(
                        'div',
                        { style: 'display: flex; justify-content: center;' },
                        gridjs.h(
                            'button',
                            {
                                className: 'btn btn-sm btn-danger',
                                onClick: () => {
                                    const id = row.cells[0].data;
                                    fetch(`/admin/delete_activity_profile/${id}`, {
                                        method: 'DELETE',
                                    }).then(res => {
                                        if (res.ok) {
                                            gridActivity.forceRender();
                                        } else {
                                            alert("Failed to delete activity profile.");
                                        }
                                    });
                                }
                            },
                            'Delete'
                        )
                    );
                }
            }
        ],
        server: {
            url: '/admin/activity_profiles_data',
            then: results => results.data,
            total: results => results.total,
        },
        search: {
            enabled: true,
            server: {
                url: (prev, search) => updateUrlActivity(prev, { search }),
            },
        },
        sort: {
            enabled: true,
            multiColumn: true,
            server: {
                url: (prev, columns) => {
                    const columnIds = ['id', 'name', 'hours'];
                    const sort = columns.map(col => (col.direction === 1 ? '+' : '-') + columnIds[col.index]);
                    return updateUrlActivity(prev, { sort });
                },
            },
        },
        pagination: {
            limit: 5,
            enabled: true,
            server: {
                url: (prev, page, limit) => updateUrlActivity(prev, { start: page * limit, length: limit }),
            },
        },
    });

    gridActivity.render(tableDivActivity);

    let savedValueActivity;

    tableDivActivity.addEventListener('focusin', ev => {
        if (ev.target.tagName === 'TD') {
            savedValueActivity = ev.target.textContent;
        }
    });

    tableDivActivity.addEventListener('focusout', ev => {
        if (ev.target.tagName === 'TD' && ev.target.dataset.elementId) {
            if (savedValueActivity !== ev.target.textContent) {
                fetch('/admin/activity_profiles_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: ev.target.dataset.elementId,
                        [ev.target.dataset.columnId]: ev.target.textContent
                    }),
                });
            }
            savedValueActivity = undefined;
        }
    });

    tableDivActivity.addEventListener('keydown', ev => {
        if (ev.target.tagName === 'TD') {
            if (ev.key === 'Escape') {
                ev.target.textContent = savedValueActivity;
                ev.target.blur();
            } else if (ev.key === 'Enter') {
                ev.preventDefault();
                ev.target.blur();
            }
        }
    });
</script>

                        </div>


                        <div class="box-content" style="margin-top: 30px;">
                            <h4 style="font-size: 0.9em; font-weight: 600; margin-bottom: 10px;">New Activity Profile</h4>
                            <form action="/admin/create_activity_profile" method="POST">
                                <div class="box-lines">
                                    <div class="box-line">
                                        <span class="left">Profile Name</span>
                                        <span class="right" ><input type="text" name="name" required
                                                                                       class="input" placeholder="e.g., Morning Active"></span>
                                    </div>
                                    <div class="box-line" style="display: block; padding: 15px 0;">
                                        <label style="display: block; margin-bottom: 12px; font-weight: 500;">Select Active Hours (0-23):</label>
                                        <style>
                                            .hour-selector {
                                                display: flex;
                                                flex-wrap: wrap;
                                                gap: 6px;
                                                max-width: 100%;
                                            }
                                            .hour-toggle {
                                                position: relative;
                                                display: inline-block;
                                            }
                                            .hour-toggle input[type="checkbox"] {
                                                position: absolute;
                                                opacity: 0;
                                                width: 0;
                                                height: 0;
                                            }
                                            .hour-toggle label {
                                                display: inline-block;
                                                min-width: 40px;
                                                padding: 6px 10px;
                                                text-align: center;
                                                font-size: 0.85em;
                                                font-weight: 500;
                                                border: 2px solid #e0e0e0;
                                                border-radius: 6px;
                                                background-color: #f8f9fa;
                                                color: #666;
                                                cursor: pointer;
                                                transition: all 0.2s ease;
                                                user-select: none;
                                            }
                                            .hour-toggle input[type="checkbox"]:checked + label {
                                                background-color: #22c55e;
                                                border-color: #16a34a;
                                                color: white;
                                                box-shadow: 0 2px 4px rgba(34, 197, 94, 0.3);
                                            }
                                            .hour-toggle label:hover {
                                                border-color: #22c55e;
                                                transform: translateY(-1px);
                                            }
                                            .hour-selector-controls {
                                                margin-top: 10px;
                                                display: flex;
                                                gap: 8px;
                                            }
                                            .hour-selector-controls button {
                                                padding: 4px 12px;
                                                font-size: 0.8em;
                                                border: 1px solid #ddd;
                                                background: white;
                                                border-radius: 4px;
                                                cursor: pointer;
                                                transition: all 0.2s ease;
                                            }
                                            .hour-selector-controls button:hover {
                                                background: #f0f0f0;
                                                border-color: #999;
                                            }
                                        </style>
                                        <div class="hour-selector">
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="0" id="hour_0"><label for="hour_0">0</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="1" id="hour_1"><label for="hour_1">1</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="2" id="hour_2"><label for="hour_2">2</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="3" id="hour_3"><label for="hour_3">3</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="4" id="hour_4"><label for="hour_4">4</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="5" id="hour_5"><label for="hour_5">5</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="6" id="hour_6"><label for="hour_6">6</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="7" id="hour_7"><label for="hour_7">7</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="8" id="hour_8"><label for="hour_8">8</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="9" id="hour_9"><label for="hour_9">9</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="10" id="hour_10"><label for="hour_10">10</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="11" id="hour_11"><label for="hour_11">11</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="12" id="hour_12"><label for="hour_12">12</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="13" id="hour_13"><label for="hour_13">13</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="14" id="hour_14"><label for="hour_14">14</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="15" id="hour_15"><label for="hour_15">15</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="16" id="hour_16"><label for="hour_16">16</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="17" id="hour_17"><label for="hour_17">17</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="18" id="hour_18"><label for="hour_18">18</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="19" id="hour_19"><label for="hour_19">19</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="20" id="hour_20"><label for="hour_20">20</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="21" id="hour_21"><label for="hour_21">21</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="22" id="hour_22"><label for="hour_22">22</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="23" id="hour_23"><label for="hour_23">23</label></div>
                                        </div>
                                        <div class="hour-selector-controls">
                                            <button type="button" onclick="document.querySelectorAll('.hour-toggle input[type=checkbox]').forEach(cb => cb.checked = true)">Select All</button>
                                            <button type="button" onclick="document.querySelectorAll('.hour-toggle input[type=checkbox]').forEach(cb => cb.checked = false)">Clear All</button>
                                            <button type="button" onclick="document.querySelectorAll('.hour-toggle input[type=checkbox]').forEach((cb, i) => cb.checked = i >= 9 && i <= 17)">Business Hours (9-17)</button>
                                        </div>
                                        <input type="hidden" name="hours" id="hours_input" value="">
                                    </div>
                                </div>
                                <div class="button-wrap">
                                    <button type="submit" class="button is-solid primary-button is-fullwidth">
                                        Create Profile
                                    </button>
                                </div>
                            </form>
                            <script>
                                // Collect selected hours when form is submitted
                                document.querySelector('form[action="/admin/create_activity_profile"]').addEventListener('submit', function(e) {
                                    const checkboxes = document.querySelectorAll('input[name="hour"]:checked');
                                    const hours = Array.from(checkboxes).map(cb => cb.value);
                                    document.getElementById('hours_input').value = hours.join(',');
                                });
                            </script>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Content & Behavior Tab -->

            <!-- System Settings Tab -->
            <div id="tab-system-settings" class="misc-tab-content">
                <style>
                    /* Toggle switch styles for System Settings */
                    .switch-small {
                        position: relative;
                        display: inline-block;
                        width: 44px;
                        height: 22px;
                    }
                    .switch-small input {
                        opacity: 0;
                        width: 0;
                        height: 0;
                    }
                    .slider-small {
                        position: absolute;
                        cursor: pointer;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background-color: #ccc;
                        transition: .4s;
                    }
                    .slider-small:before {
                        position: absolute;
                        content: "";
                        height: 16px;
                        width: 16px;
                        left: 3px;
                        bottom: 3px;
                        background-color: white;
                        transition: .4s;
                    }
                    input:checked + .slider-small {
                        background-color: #22c55e;
                    }
                    input:checked + .slider-small:before {
                        transform: translateX(22px);
                    }
                    .slider-small.round {
                        border-radius: 22px;
                    }
                    .slider-small.round:before {
                        border-radius: 50%;
                    }
                </style>

                <div class="misc-section-description">
                    <strong>System Settings:</strong> Configure system-level settings for the YSocial platform, including telemetry, automatic log synchronization, process monitoring, and system updates.
                </div>

                <!-- Row 1: System Updates & Telemetry Settings -->
                <div class="misc-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <!-- System Updates -->
                    <div class="misc-compact-box">
                        <h3>System Updates</h3>
                        <div class="help-block" style="margin-bottom: 15px;">
                            <p>Check for new YSocial releases and stay up to date.</p>
                        </div>
                        <div style="margin-top: 15px;">
                            <button id="check-updates-btn" class="button is-solid primary-button" style="width: 100%;">
                                <i class="mdi mdi-update"></i> Check for Updates
                            </button>
                        </div>
                        <div id="update-status" style="font-size: 0.8em; color: #777; margin-top: 10px;">
                            Click to check if a newer version of YSocial is available.
                        </div>
                        <script>
                            document.getElementById('check-updates-btn').addEventListener('click', function() {
                                const btn = this;
                                const statusDiv = document.getElementById('update-status');
                                
                                btn.disabled = true;
                                btn.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> Checking...';
                                statusDiv.innerHTML = '<span style="color: #4a90e2;">Checking for updates...</span>';
                                
                                fetch('/admin/check_for_updates', { method: 'POST' })
                                .then(response => {
                                    btn.disabled = false;
                                    btn.innerHTML = '<i class="mdi mdi-update"></i> Check for Updates';
                                    
                                    if (response.redirected) {
                                        window.location.href = response.url;
                                    } else {
                                        statusDiv.innerHTML = '<span style="color: #22c55e;"> Check complete</span>';
                                        setTimeout(() => {
                                            statusDiv.innerHTML = 'Click to check if a newer version of YSocial is available.';
                                        }, 3000);
                                    }
                                })
                                .catch(error => {
                                    btn.disabled = false;
                                    btn.innerHTML = '<i class="mdi mdi-update"></i> Check for Updates';
                                    statusDiv.innerHTML = '<span style="color: #dc3545;"> Error checking for updates</span>';
                                });
                            });
                        </script>
                    </div>

                    <!-- Telemetry Settings -->
                    <div class="misc-compact-box">
                        <h3>Telemetry Settings</h3>
                        <div class="help-block" style="margin-bottom: 15px;">
                            <p>Control anonymous usage data collection to help improve YSocial.</p>
                        </div>
                        <div class="box-lines">
                            <div class="box-line" style="display: flex; align-items: center; gap: 12px; padding: 12px 0;">
                                <span class="left" style="flex: 0 0 140px; font-weight: 500;">Telemetry Data</span>
                                <span class="right" style="flex: 1; display: flex; align-items: center;">
                                    <label class="switch-small">
                                        <input type="checkbox" id="telemetry_enabled" {% if telemetry_enabled %}checked{% endif %}>
                                        <span class="slider-small round"></span>
                                    </label>
                                    <span id="telemetry-status" style="margin-left: 10px; font-size: 0.85em; color: #6b7280;"></span>
                                </span>
                            </div>
                        </div>
                        <div id="telemetry-message" style="margin-top: 10px; padding: 8px 12px; border-radius: 4px; display: none;"></div>
                        <p style="font-size: 0.8em; color: #777; margin-top: 10px;">
                            Enable/disable anonymous usage data collection for improving YSocial.
                        </p>
                        <script>
                            function updateTelemetryStatus(enabled) {
                                const status = document.getElementById('telemetry-status');
                                if (enabled) {
                                    status.innerHTML = '<span style="color: #22c55e;"> Enabled</span>';
                                } else {
                                    status.innerHTML = '<span style="color: #dc3545;"> Disabled</span>';
                                }
                            }
                            
                            function showTelemetryMessage(message, isError) {
                                const msgDiv = document.getElementById('telemetry-message');
                                msgDiv.textContent = message;
                                msgDiv.style.display = 'block';
                                msgDiv.style.backgroundColor = isError ? '#fee2e2' : '#dcfce7';
                                msgDiv.style.color = isError ? '#dc3545' : '#16a34a';
                                setTimeout(() => { msgDiv.style.display = 'none'; }, 3000);
                            }
                            
                            document.getElementById('telemetry_enabled').addEventListener('change', function() {
                                const enabled = this.checked;
                                updateTelemetryStatus(enabled);
                                
                                fetch('/admin/update_telemetry_preference_ajax', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ telemetry_enabled: enabled })
                                })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        showTelemetryMessage('Telemetry setting updated', false);
                                    } else {
                                        showTelemetryMessage(data.message || 'Failed to update', true);
                                    }
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                    showTelemetryMessage('Error updating setting', true);
                                });
                            });
                            
                            // Initialize status on load using data attribute to avoid duplicate initialization
                            (function() {
                                const telemetryCheckbox = document.getElementById('telemetry_enabled');
                                if (telemetryCheckbox && !telemetryCheckbox.dataset.initialized) {
                                    telemetryCheckbox.dataset.initialized = 'true';
                                    updateTelemetryStatus(telemetryCheckbox.checked);
                                }
                            })();
                        </script>
                    </div>
                </div>

                <!-- Row 2: Automatic Log Synchronization, Process Watchdog, About System Settings -->
                <div class="misc-grid" style="grid-template-columns: repeat(3, 1fr); margin-top: 20px;">
                    <!-- Automatic Log Synchronization -->
                    <div class="misc-compact-box">
                        <h3>Automatic Log Synchronization</h3>
                        <div class="help-block" style="margin-bottom: 15px;">
                            <p>Periodic reading of logs from running experiments to keep plot data updated.</p>
                        </div>

                        <div id="log-sync-settings-container">
                            <div class="box-lines">
                                <div class="box-line" style="display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid #e5e7eb;">
                                    <span class="left" style="flex: 0 0 100px; font-weight: 500;">Enable</span>
                                    <span class="right" style="flex: 1; display: flex; align-items: center;">
                                        <label class="switch-small">
                                            <input type="checkbox" id="log_sync_enabled" checked>
                                            <span class="slider-small round"></span>
                                        </label>
                                        <span id="sync-status-indicator" style="margin-left: 10px; font-size: 0.85em; color: #6b7280;"></span>
                                    </span>
                                </div>
                                <div class="box-line" style="display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid #e5e7eb;">
                                    <span class="left" style="flex: 0 0 100px; font-weight: 500;">Interval</span>
                                    <span class="right" style="flex: 1; display: flex; align-items: center; gap: 8px;">
                                        <input type="number" id="sync_interval_minutes" class="input" style="width: 60px;" min="1" max="1440" value="10">
                                        <span style="font-size: 0.9em; color: #6b7280;">min</span>
                                    </span>
                                </div>
                                <div class="box-line" style="display: flex; align-items: center; gap: 12px; padding: 12px 0;">
                                    <span class="left" style="flex: 0 0 100px; font-weight: 500;">Last Sync</span>
                                    <span class="right" style="flex: 1;">
                                        <span id="last-sync-time" style="font-size: 0.9em; color: #6b7280;">Never</span>
                                    </span>
                                </div>
                            </div>

                            <div style="display: flex; gap: 10px; margin-top: 15px;">
                                <button id="save-log-sync-settings" class="button is-solid primary-button" style="flex: 1; font-size: 0.85em; padding: 6px 10px;">
                                    Save
                                </button>
                                <button id="trigger-log-sync" class="button is-solid" style="flex: 1; background-color: #6b7280; color: white; font-size: 0.85em; padding: 6px 10px;">
                                    Sync Now
                                </button>
                            </div>

                            <div id="log-sync-message" style="margin-top: 10px; padding: 8px 12px; border-radius: 4px; display: none;"></div>
                        </div>

                        <script>
                            // Load current log sync settings
                            async function loadLogSyncSettings() {
                                try {
                                    const response = await fetch('/admin/log_sync_settings');
                                    const data = await response.json();
                                    
                                    document.getElementById('log_sync_enabled').checked = data.enabled;
                                    document.getElementById('sync_interval_minutes').value = data.sync_interval_minutes;
                                    
                                    updateSyncStatusIndicator(data.enabled);
                                    
                                    if (data.last_sync) {
                                        const lastSync = new Date(data.last_sync);
                                        document.getElementById('last-sync-time').textContent = lastSync.toLocaleString();
                                    } else {
                                        document.getElementById('last-sync-time').textContent = 'Never';
                                    }
                                } catch (error) {
                                    console.error('Error loading log sync settings:', error);
                                }
                            }

                            function updateSyncStatusIndicator(enabled) {
                                const indicator = document.getElementById('sync-status-indicator');
                                if (enabled) {
                                    indicator.innerHTML = '<span style="color: #22c55e;"> Active</span>';
                                } else {
                                    indicator.innerHTML = '<span style="color: #dc3545;"> Disabled</span>';
                                }
                            }

                            function showLogSyncMessage(message, isError) {
                                const msgDiv = document.getElementById('log-sync-message');
                                msgDiv.textContent = message;
                                msgDiv.style.display = 'block';
                                msgDiv.style.backgroundColor = isError ? '#fee2e2' : '#dcfce7';
                                msgDiv.style.color = isError ? '#dc3545' : '#16a34a';
                                
                                setTimeout(() => {
                                    msgDiv.style.display = 'none';
                                }, 5000);
                            }

                            // Save log sync settings
                            document.getElementById('save-log-sync-settings').addEventListener('click', async function() {
                                const enabled = document.getElementById('log_sync_enabled').checked;
                                const intervalValue = document.getElementById('sync_interval_minutes').value;
                                const interval = Number(intervalValue);
                                
                                // Check for NaN or invalid values
                                if (isNaN(interval) || interval < 1 || interval > 1440) {
                                    showLogSyncMessage('Sync interval must be a valid number between 1 and 1440 minutes', true);
                                    return;
                                }
                                
                                try {
                                    const response = await fetch('/admin/log_sync_settings', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({
                                            enabled: enabled,
                                            sync_interval_minutes: interval
                                        })
                                    });
                                    
                                    const data = await response.json();
                                    
                                    if (data.success) {
                                        updateSyncStatusIndicator(enabled);
                                        showLogSyncMessage('Settings saved successfully', false);
                                    } else {
                                        showLogSyncMessage(data.message || 'Failed to save settings', true);
                                    }
                                } catch (error) {
                                    console.error('Error saving log sync settings:', error);
                                    showLogSyncMessage('Error saving settings', true);
                                }
                            });

                            // Trigger manual sync
                            document.getElementById('trigger-log-sync').addEventListener('click', async function() {
                                this.disabled = true;
                                this.textContent = 'Syncing...';
                                
                                try {
                                    const response = await fetch('/admin/log_sync_trigger', {
                                        method: 'POST'
                                    });
                                    
                                    const data = await response.json();
                                    
                                    if (data.success) {
                                        showLogSyncMessage('Log sync completed successfully', false);
                                        // Reload settings to update last sync time
                                        await loadLogSyncSettings();
                                    } else {
                                        showLogSyncMessage(data.message || 'Failed to trigger sync', true);
                                    }
                                } catch (error) {
                                    console.error('Error triggering log sync:', error);
                                    showLogSyncMessage('Error triggering sync', true);
                                } finally {
                                    this.disabled = false;
                                    this.textContent = 'Sync Now';
                                }
                            });

                            // Update status indicator when toggle changes
                            document.getElementById('log_sync_enabled').addEventListener('change', function() {
                                updateSyncStatusIndicator(this.checked);
                            });

                            // Load settings on page load using data attribute to avoid duplicate initialization
                            (function() {
                                const logSyncContainer = document.getElementById('log-sync-settings-container');
                                if (logSyncContainer && !logSyncContainer.dataset.initialized) {
                                    logSyncContainer.dataset.initialized = 'true';
                                    if (document.readyState === 'loading') {
                                        document.addEventListener('DOMContentLoaded', loadLogSyncSettings);
                                    } else {
                                        // DOM is already loaded
                                        loadLogSyncSettings();
                                    }
                                }
                            })();
                        </script>
                    </div>

                    <!-- Process Watchdog -->
                    <div class="misc-compact-box">
                        <h3>Process Watchdog</h3>
                        <div class="help-block" style="margin-bottom: 15px;">
                            <p>Monitor and auto-restart hung server/client processes.</p>
                        </div>
                        <div class="box-lines">
                            <div class="box-line" style="display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid #e5e7eb;">
                                <span class="left" style="flex: 0 0 100px; font-weight: 500;">Enable</span>
                                <span class="right" style="flex: 1; display: flex; align-items: center;">
                                    <label class="switch-small">
                                        <input type="checkbox" id="watchdog_enabled" checked>
                                        <span class="slider-small round"></span>
                                    </label>
                                    <span id="watchdog-status-indicator" style="margin-left: 10px; font-size: 0.85em; color: #6b7280;"></span>
                                </span>
                            </div>
                            <div class="box-line" style="display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid #e5e7eb;">
                                <span class="left" style="flex: 0 0 100px; font-weight: 500;">Interval</span>
                                <span class="right" style="flex: 1; display: flex; align-items: center; gap: 8px;">
                                    <input type="number" id="watchdog_interval" class="input" style="width: 60px;" 
                                           value="{{ watchdog_interval | default(15) }}" min="1" max="1440">
                                    <span style="font-size: 0.9em; color: #6b7280;">min</span>
                                </span>
                            </div>
                            <div class="box-line" style="display: flex; align-items: center; gap: 12px; padding: 12px 0;">
                                <span class="left" style="flex: 0 0 100px; font-weight: 500;">Last Run</span>
                                <span class="right" style="flex: 1;">
                                    <span id="watchdog-last-run" style="font-size: 0.9em; color: #6b7280;">Never</span>
                                </span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button id="save-watchdog-interval" class="button is-solid primary-button" style="flex: 1; font-size: 0.85em; padding: 6px 10px;">
                                Save
                            </button>
                            <button id="run-watchdog-now" class="button is-solid" style="flex: 1; background-color: #6b7280; color: white; font-size: 0.85em; padding: 6px 10px;">
                                Run Now
                            </button>
                        </div>
                        <div id="watchdog-status" style="font-size: 0.8em; color: #777; margin-top: 10px;">
                            Monitors server/client processes for hangs and auto-restarts them.
                        </div>
                        <script>
                            // Update watchdog status indicator
                            function updateWatchdogStatusIndicator(enabled) {
                                const indicator = document.getElementById('watchdog-status-indicator');
                                if (enabled) {
                                    indicator.innerHTML = '<span style="color: #22c55e;"> Active</span>';
                                } else {
                                    indicator.innerHTML = '<span style="color: #dc3545;"> Disabled</span>';
                                }
                            }

                            // Load watchdog status on page load
                            async function loadWatchdogStatus() {
                                try {
                                    const response = await fetch('/admin/watchdog_status');
                                    const data = await response.json();
                                    
                                    if (data.last_run) {
                                        const lastRun = new Date(data.last_run);
                                        document.getElementById('watchdog-last-run').textContent = lastRun.toLocaleString();
                                    } else {
                                        document.getElementById('watchdog-last-run').textContent = 'Never';
                                    }
                                    
                                    if (data.run_interval_minutes) {
                                        document.getElementById('watchdog_interval').value = data.run_interval_minutes;
                                    }
                                    
                                    // Update enabled status from scheduler_running
                                    const isEnabled = data.scheduler_running !== false;
                                    document.getElementById('watchdog_enabled').checked = isEnabled;
                                    updateWatchdogStatusIndicator(isEnabled);
                                } catch (error) {
                                    console.error('Error loading watchdog status:', error);
                                }
                            }
                            
                            // Handle enable/disable toggle
                            document.getElementById('watchdog_enabled').addEventListener('change', function() {
                                const enabled = this.checked;
                                const statusDiv = document.getElementById('watchdog-status');
                                
                                updateWatchdogStatusIndicator(enabled);
                                
                                fetch('/admin/watchdog_toggle', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ enabled: enabled })
                                })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        statusDiv.innerHTML = '<span style="color: #22c55e;"> Watchdog ' + (enabled ? 'enabled' : 'disabled') + '</span>';
                                    } else {
                                        statusDiv.innerHTML = '<span style="color: #dc3545;"> ' + (data.message || 'Failed to update') + '</span>';
                                    }
                                    setTimeout(() => {
                                        statusDiv.innerHTML = 'Monitors server/client processes for hangs and auto-restarts them.';
                                    }, 3000);
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                    statusDiv.innerHTML = '<span style="color: #dc3545;"> Error updating setting</span>';
                                });
                            });
                            
                            document.getElementById('save-watchdog-interval').addEventListener('click', function() {
                                const interval = document.getElementById('watchdog_interval').value;
                                const statusDiv = document.getElementById('watchdog-status');
                                
                                fetch('/admin/watchdog_set_interval', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                    body: `watchdog_interval=${interval}`
                                })
                                .then(response => {
                                    if (response.ok) {
                                        statusDiv.innerHTML = '<span style="color: #22c55e;"> Interval updated successfully</span>';
                                    } else {
                                        statusDiv.innerHTML = '<span style="color: #dc3545;"> Failed to update interval</span>';
                                    }
                                    setTimeout(() => {
                                        statusDiv.innerHTML = 'Monitors server/client processes for hangs and auto-restarts them.';
                                    }, 3000);
                                })
                                .catch(error => {
                                    statusDiv.innerHTML = '<span style="color: #dc3545;"> Error: ' + error.message + '</span>';
                                });
                            });
                            
                            document.getElementById('run-watchdog-now').addEventListener('click', function() {
                                const btn = this;
                                const statusDiv = document.getElementById('watchdog-status');
                                
                                btn.disabled = true;
                                btn.innerHTML = 'Running...';
                                statusDiv.innerHTML = '<span style="color: #4a90e2;">Running watchdog check...</span>';
                                
                                fetch('/admin/watchdog_run_now', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' }
                                })
                                .then(response => response.json())
                                .then(data => {
                                    btn.disabled = false;
                                    btn.innerHTML = 'Run Now';
                                    
                                    if (data.error) {
                                        statusDiv.innerHTML = '<span style="color: #dc3545;"> Error: ' + data.error + '</span>';
                                    } else {
                                        const msg = 'Checked: ' + data.processes_checked + 
                                                   ', Restarted: ' + data.processes_restarted + 
                                                   ', Healthy: ' + data.processes_healthy;
                                        statusDiv.innerHTML = '<span style="color: #22c55e;"> ' + msg + '</span>';
                                        // Update last run time
                                        loadWatchdogStatus();
                                    }
                                })
                                .catch(error => {
                                    btn.disabled = false;
                                    btn.innerHTML = 'Run Now';
                                    statusDiv.innerHTML = '<span style="color: #dc3545;"> Error running watchdog</span>';
                                });
                            });
                            
                            // Initialize on page load using data attribute to avoid duplicate initialization
                            (function() {
                                const watchdogBox = document.getElementById('watchdog_interval');
                                if (watchdogBox && !watchdogBox.dataset.initialized) {
                                    watchdogBox.dataset.initialized = 'true';
                                    if (document.readyState === 'loading') {
                                        document.addEventListener('DOMContentLoaded', loadWatchdogStatus);
                                    } else {
                                        loadWatchdogStatus();
                                    }
                                }
                            })();
                        </script>
                    </div>

                    <!-- About System Settings -->
                    <div class="misc-compact-box">
                        <h3>About System Settings</h3>
                        <div class="help-block">
                            <p><strong>Telemetry:</strong> Anonymous usage data helps improve YSocial. No personal data is collected.</p>
                            <br>
                            <p><strong>Process Watchdog:</strong> Monitors running experiments and automatically restarts hung processes to ensure continuous operation.</p>
                            <br>
                            <p><strong>Log Synchronization:</strong> Prevents data loss during log rotation by periodically reading logs from active experiments.</p>
                            <br>
                            <p><strong>System Updates:</strong> Check for new YSocial releases to access the latest features and improvements.</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End System Settings Tab -->

            {% if llm_backend['backend'] is not none %}
            <!-- LLM Management Tab -->
            <div id="tab-llm-management" class="misc-tab-content">
                <div class="misc-section-description">
                    <strong>LLM Management:</strong> Manage your self-hosted Large Language Model server, view available models, and pull new models from the repository.
                </div>

                <div class="misc-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <!-- LLM Server Status -->
                    <div class="misc-compact-box">
                        <h3>Self-hosted LLM Server ({{ llm_backend['backend']|upper }})</h3>
                        <div class="box-content">
                            <div class="box-lines">
                                {% if llm_backend.get('url') %}
                                <div class="box-line">
                                    <span class="left">URL</span>
                                    <span class="right"><small><code>{{ llm_backend['url'] }}</code></small></span>
                                </div>
                                {% endif %}
                                <div class="box-line">
                                    <span class="left">Installed</span>
                                    <span class="right">  <i class="mdi mdi-checkbox-blank-circle {% if llm_backend['installed'] %} active {% endif %}" style="font-size: 20px;"></i> </span>
                                </div>
                                <div class="box-line">
                                    <span class="left">Running</span>
                                    <span class="right"> <i class="mdi mdi-checkbox-blank-circle {% if llm_backend['status'] %} active {% endif %}" style="font-size: 20px;"></i></span>
                                </div>
                                {% if llm_backend['backend'] == 'ollama' and not llm_backend['status'] %}
                                <div class="box-line">
                                    <span class="left">Start Ollama</span>
                                    <span class="right">
                                        <a class="link-tooltip" {% if not llm_backend['status'] %} href="/admin/start_ollama/" {% endif %} title="Run">
                                            <i class="mdi mdi-play-box-outline {% if not llm_backend['status'] %} active {% endif %}" style="font-size: 24px;"></i>
                                        </a>
                                    </span>
                                </div>
                                {% endif %}
                                {% if llm_backend['backend'] == 'vllm' and not llm_backend['status'] %}
                                <div class="box-line">
                                    <span class="left" style="font-size: 0.9em;">vLLM server not running. Start manually:<br>
                                    <small><code>vllm serve &lt;model&gt; --host 0.0.0.0 --port 8000</code></small>
                                    </span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    {% if llm_backend['backend'] == 'ollama' %}
                    <!-- Add LLM Model (Ollama only) -->
                    <div class="misc-compact-box">
                        <h3>Add LLM Model</h3>
                         <div class="box-content">
                            <div class="box-lines">
                                 <div class="box-line">
                                    <span class="left">
                                        If the model you want to use is not available, you can pull it from the Ollama server.
                                        For a list of available models refer to the <a href="https://ollama.com/search">Ollama directory</a>.
                                    </span>
                                 </div>
                            </div>
                         </div>

                        <hr>

                        <div class="box-content">
                            <form action="/admin/ollama_pull" enctype="multipart/form-data" method="POST">
                            <div class="box-lines">
                                <div class="box-line">
                                    <span class="left">Model Name</span>
                                    <span class="right">
                                        <input type="text" name="model_name" class="input" value="">
                                    </span>
                                </div>
                                 <div class="box-line">
                                    <span class="left"></span>
                                    <span class="right">

                                    <div class="button-wrap">
                                    <button class="button is-solid primary-button is-fullwidth">
                                        Download Model
                                    </button>
                                </div>
                                    </span>
                                </div>
                            </div>
                             <div class="box-lines">
                                {% for pull in active_pulls %}

                                {% if pull[1] < 1 %}
                                <div class="box-line">
                                <span class="left" id="model_pull_name_{{ pull[0] }}">
                                    {{ pull[0] }}
                                </span>
                                 <span class="right" style="height: 22px; width: 70%;">
                                <div class="progress" style="height: 22px; width: 100%;" >
                                    <div id="pull-progress-bar_{{ pull[0] }}" class="progress-bar progress-bar-striped progress_exp" role="progressbar"
                                         aria-valuenow="{{ pull[1] }}" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
                                        {{ pull[1] }}%
                                    </div>
                                </div>
                                 </span>
                                    <span class="right" style="height: 22px; width: 10%;">
                                        <a href="/admin/ollama_cancel_pull/{{ pull[0] }}" title="Delete">
                                        <i class="mdi mdi-delete" style="font-size: 20px;"></i>
                                    </a>
                                    </span>
                                </div>
                                {% endif %}

                                 <script>
                                        $(document).ready(function () {
                                                    // Start the background progress as soon as the page loads
                                                    $.ajax({
                                                        url: `/admin/pull_progress/{{ pull[0] }}`,
                                                        method: 'GET'
                                                    });

                                                    // Poll progress updates
                                                    function pullProgress() {
                                                        $.ajax({
                                                            url: '/admin/pull_progress/{{ pull[0] }}',
                                                            method: 'GET',
                                                            dataType: 'json',
                                                            success: function (data) {
                                                                const model_name  = data.model_name;
                                                                const percentage = data.progress;
                                                                const progressBar = $('#pull-progress-bar_{{ pull[0] }}');

                                                                progressBar.css('width', percentage + '%');
                                                                progressBar.attr('aria-valuenow', percentage);
                                                                progressBar.text(percentage + '%');

                                                                if (percentage >= 100) {
                                                                    setTimeout(function () {
                                                                        location.reload();
                                                                    }, 1000);
                                                                } else {
                                                                    setTimeout(pullProgress, 1000);
                                                                }
                                                            },
                                                            error: function () {
                                                                setTimeout(pullProgress, 1000);
                                                            }
                                                        });
                                                    }

                                                    pullProgress();
                                                });
                                </script>
                                {% endfor %}
                            </div>
                            </form>
                        </div>
                    </div>
                    {% endif %}
                </div>

                {% if llm_backend["status"] and llm_backend["installed"] %}
                {% if len(models) > 0 %}
                <!-- Available LLMs Table (full width) -->
                <div class="misc-grid" style="grid-template-columns: 1fr; margin-top: 20px;">
                    <div class="misc-compact-box">
                        <h3>Available LLMs</h3>

                        <div class="box-content">
                            <div id="llm-models-table"></div>

                            <script src="{{ url_for('static', filename='assets/vendor/js/gridjs.umd.js') }}"></script>

                            <style>
                              #llm-models-table td {
                                vertical-align: middle !important;
                              }
                            </style>

                            <script>
                                const llmModelsTableDiv = document.getElementById('llm-models-table');

                                const updateUrlLLM = (prev, query) => {
                                    return prev + (prev.indexOf('?') >= 0 ? '&' : '?') + new URLSearchParams(query).toString();
                                };

                                new gridjs.Grid({
                                    columns: [
                                        { id: 'model_name', name: 'Model Name', sort: true },
                                        {
                                            id: 'actions',
                                            name: 'Actions',
                                            sort: false,
                                            formatter: (cell, row) => {
                                                const modelName = row.cells[0].data;
                                                const backend = '{{ llm_backend["backend"] }}';

                                                // Only show delete button for Ollama backend
                                                if (backend === 'ollama') {
                                                    return gridjs.html(`
                                                        <div style="display: flex; gap: 8px; justify-content: center;">
                                                            <a href="/admin/delete_model/${encodeURIComponent(modelName)}"
                                                               style="background-color: #dc3545; color: white; padding: 6px 12px; border-radius: 4px; text-decoration: none; font-size: 0.85rem;">
                                                                Delete
                                                            </a>
                                                        </div>
                                                    `);
                                                } else {
                                                    return gridjs.html(`<div style="text-align: center;">-</div>`);
                                                }
                                            }
                                        },
                                    ],
                                    server: {
                                        url: '/admin/models_data',
                                        then: results => results.data,
                                        total: results => results.total,
                                    },
                                    search: {
                                        enabled: true,
                                        server: {
                                            url: (prev, search) => {
                                                return updateUrlLLM(prev, { search });
                                            },
                                        },
                                    },
                                    sort: {
                                        enabled: true,
                                        multiColumn: false,
                                        server: {
                                            url: (prev, columns) => {
                                                const columnIds = ['model_name'];
                                                const sort = columns.map(col => (col.direction === 1 ? '+' : '-') + columnIds[col.index]);
                                                return updateUrlLLM(prev, { sort });
                                            },
                                        },
                                    },
                                    pagination: {
                                        enabled: true,
                                        limit: 10,
                                        server: {
                                            url: (prev, page, limit) => {
                                                return updateUrlLLM(prev, { start: page * limit, length: limit });
                                            },
                                        },
                                    },
                                }).render(llmModelsTableDiv);
                            </script>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endif %}
            </div>
            <!-- End LLM Management Tab -->
            {% endif %}

            <script>
                function switchMiscTab(tabName) {
                    // Hide all tabs
                    document.querySelectorAll('.misc-tab-content').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    // Remove active from all buttons
                    document.querySelectorAll('.misc-tab').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    // Show selected tab
                    document.getElementById('tab-' + tabName).classList.add('active');
                    // Set button as active
                    event.target.classList.add('active');
                }
            </script>

        </div>
    </div>

</div>

{% include "admin/footer.html" %}