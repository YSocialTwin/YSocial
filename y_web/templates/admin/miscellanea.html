{% include "admin/head.html" %}

<div class="view-wrapper is-dashboard">
    <!--Dashboard container-->
    <div id="creator-dashboard" class="dashboard-container">
        <!--Toolbar-->
        {% include "admin/dash_head.html" %}

        <div class="dashboard-body">

            <style>
                .misc-tabs {
                    display: flex;
                    border-bottom: 2px solid #e5e7eb;
                    margin-bottom: 20px;
                    flex-wrap: wrap;
                }
                .misc-tab {
                    padding: 12px 24px;
                    cursor: pointer;
                    border: none;
                    background: transparent;
                    font-size: 0.95em;
                    font-weight: 500;
                    color: #666;
                    transition: all 0.2s;
                    border-bottom: 3px solid transparent;
                    margin-bottom: -2px;
                }
                .misc-tab:hover {
                    color: #22c55e;
                    background: rgba(34, 197, 94, 0.05);
                }
                .misc-tab.active {
                    color: #22c55e;
                    border-bottom-color: #22c55e;
                }
                .misc-tab-content {
                    display: none;
                }
                .misc-tab-content.active {
                    display: block;
                }
                .misc-section-description {
                    background: #f9fafb;
                    border-left: 3px solid #22c55e;
                    padding: 15px 20px;
                    margin-bottom: 20px;
                    border-radius: 4px;
                    font-size: 0.9em;
                    color: #666;
                    line-height: 1.6;
                }
            </style>

            <div class="misc-tabs">
                <button class="misc-tab active" onclick="switchMiscTab('agent-attributes')">Agent Attributes</button>
                <button class="misc-tab" onclick="switchMiscTab('demographics')">Demographics</button>
                <button class="misc-tab" onclick="switchMiscTab('content')">Content & Topics</button>
                <button class="misc-tab" onclick="switchMiscTab('behavior')">Behavior Profiles</button>
            </div>

            <!-- Agent Attributes Tab -->
            <div id="tab-agent-attributes" class="misc-tab-content active">
                <div class="misc-section-description">
                    <strong>Agent Attributes:</strong> Configure political leanings, education levels, and professions that define the social and professional characteristics of simulated agents in your experiments.
                </div>

                <div class="columns">
                    <div class="column is-6">
                        <div class="dashboard-box">
                            <h3 class="title is-5 is-thin">Available Political Leanings</h3>

                        <div class="box-content">


                            <div id="leaning_table"></div>

                            <script src="{{ url_for('static', filename='assets/vendor/js/gridjs.umd.js') }}"></script>
                            <script>
    const tableDiv = document.getElementById('leaning_table');

    const updateUrl = (prev, query) => {
        return prev + (prev.indexOf('?') >= 0 ? '&' : '?') + new URLSearchParams(query).toString();
    };

    const editableCellAttributes = (data, row, col) => {
        if (row) {
            return {
                contentEditable: 'true',
                'data-element-id': row.cells[0].data,
                'data-column-id': 'leaning'
            };
        } else {
            return {};
        }
    };

    const grid = new gridjs.Grid({
        columns: [
            { id: 'id', hidden: true },
            {
                id: 'leaning',
                name: 'Name',
                attributes: editableCellAttributes
            },
            {
                name: 'Actions',
                attributes: () => ({ style: 'text-align: center;' }),
                formatter: (cell, row) => {
                    return gridjs.h(
                        'div',
                        { style: 'display: flex; justify-content: center;' },
                        gridjs.h(
                            'button',
                            {
                                className: 'btn btn-sm btn-danger',
                                onClick: () => {
                                    const id = row.cells[0].data;
                                    fetch(`/admin/delete_leaning/${id}`, {
                                        method: 'DELETE',
                                    }).then(res => {
                                        if (res.ok) {
                                            grid.forceRender();
                                        } else {
                                            alert("Failed to delete leaning.");
                                        }
                                    });
                                }
                            },
                            'Delete'
                        )
                    );
                }
            }
        ],
        server: {
            url: '/admin/leanings_data',
            then: results => results.data,
            total: results => results.total,
        },
        search: {
            enabled: true,
            server: {
                url: (prev, search) => updateUrl(prev, { search }),
            },
        },
        sort: {
            enabled: true,
            multiColumn: true,
            server: {
                url: (prev, columns) => {
                    const columnIds = ['id', 'leaning'];
                    const sort = columns.map(col => (col.direction === 1 ? '+' : '-') + columnIds[col.index]);
                    return updateUrl(prev, { sort });
                },
            },
        },
        pagination: {
            enabled: true,
            server: {
                url: (prev, page, limit) => updateUrl(prev, { start: page * limit, length: limit }),
            },
        },
    });

    grid.render(tableDiv);

    // Inline edit tracking
    let savedValue;

    tableDiv.addEventListener('focusin', ev => {
        if (ev.target.tagName === 'TD') {
            savedValue = ev.target.textContent;
        }
    });

    tableDiv.addEventListener('focusout', ev => {
        if (ev.target.tagName === 'TD' && ev.target.dataset.elementId) {
            if (savedValue !== ev.target.textContent) {
                fetch('/admin/leanings_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: ev.target.dataset.elementId,
                        [ev.target.dataset.columnId]: ev.target.textContent
                    }),
                });
            }
            savedValue = undefined;
        }
    });

    tableDiv.addEventListener('keydown', ev => {
        if (ev.target.tagName === 'TD') {
            if (ev.key === 'Escape') {
                ev.target.textContent = savedValue;
                ev.target.blur();
            } else if (ev.key === 'Enter') {
                ev.preventDefault();
                ev.target.blur();
            }
        }
    });
</script>


                        </div>

                        <div class="box-content" style="margin-top: 30px;">
                            <h3 class="title is-5 is-thin">New Political Leaning</h3>
                            <form action="/admin/create_leaning" method="POST">
                                <div class="box-lines">
                                    <div class="box-line">
                                        <span class="left">Name</span>
                                        <span class="right" style="width: 70%;"><input type="text" name="leaning"
                                                                                       class="input"></span>
                                    </div>
                                </div>
                                <div class="button-wrap">
                                    <button class="button is-solid primary-button is-fullwidth">
                                        Create
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>


                    <div class="dashboard-box">
                        <h3 class="title is-5 is-thin">Available Education Levels</h3>

                        <div class="box-content">


                            <div id="edu_table"></div>

                            <script src="{{ url_for('static', filename='assets/vendor/js/gridjs.umd.js') }}"></script>
                            <script>
    const tableDiv5 = document.getElementById('edu_table');

    const updateUrl5 = (prev, query) => {
        return prev + (prev.indexOf('?') >= 0 ? '&' : '?') + new URLSearchParams(query).toString();
    };

    const editableCellAttributes5 = (data, row, col) => {
        if (row) {
            return {
                contentEditable: 'true',
                'data-element-id': row.cells[0].data,
                'data-column-id': 'education_level'
            };
        } else {
            return {};
        }
    };

    const grid5 = new gridjs.Grid({
        columns: [
            { id: 'id', hidden: true },
            {
                id: 'education_level',
                name: 'Name',
                attributes: editableCellAttributes5
            },
            {
                name: 'Actions',
                attributes: () => ({ style: 'text-align: center;' }),
                formatter: (cell, row) => {
                    return gridjs.h(
                        'div',
                        { style: 'display: flex; justify-content: center;' },
                        gridjs.h(
                            'button',
                            {
                                className: 'btn btn-sm btn-danger',
                                onClick: () => {
                                    const id = row.cells[0].data;
                                    fetch(`/admin/delete_education/${id}`, {
                                        method: 'DELETE',
                                    }).then(res => {
                                        if (res.ok) {
                                            grid5.forceRender();
                                        } else {
                                            alert("Failed to delete education level.");
                                        }
                                    });
                                }
                            },
                            'Delete'
                        )
                    );
                }
            }
        ],
        server: {
            url: '/admin/educations_data',
            then: results => results.data,
            total: results => results.total,
        },
        search: {
            enabled: true,
            server: {
                url: (prev, search) => updateUrl5(prev, { search }),
            },
        },
        sort: {
            enabled: true,
            multiColumn: true,
            server: {
                url: (prev, columns) => {
                    const columnIds = ['id', 'education_level'];
                    const sort = columns.map(col => (col.direction === 1 ? '+' : '-') + columnIds[col.index]);
                    return updateUrl5(prev, { sort });
                },
            },
        },
        pagination: {
            enabled: true,
            server: {
                url: (prev, page, limit) => updateUrl5(prev, { start: page * limit, length: limit }),
            },
        },
    });

    grid5.render(tableDiv5);

    // Inline editing
    let savedValue5;

    tableDiv5.addEventListener('focusin', ev => {
        if (ev.target.tagName === 'TD') {
            savedValue5 = ev.target.textContent;
        }
    });

    tableDiv5.addEventListener('focusout', ev => {
        if (ev.target.tagName === 'TD' && ev.target.dataset.elementId) {
            if (savedValue5 !== ev.target.textContent) {
                fetch('/admin/educations_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: ev.target.dataset.elementId,
                        [ev.target.dataset.columnId]: ev.target.textContent
                    }),
                });
            }
            savedValue5 = undefined;
        }
    });

    tableDiv5.addEventListener('keydown', ev => {
        if (ev.target.tagName === 'TD') {
            if (ev.key === 'Escape') {
                ev.target.textContent = savedValue5;
                ev.target.blur();
            } else if (ev.key === 'Enter') {
                ev.preventDefault();
                ev.target.blur();
            }
        }
    });
</script>


                        </div>

                        <div class="box-content" style="margin-top: 30px;">
                            <h3 class="title is-5 is-thin">New Education Level</h3>
                            <form action="/admin/create_education" method="POST">
                                <div class="box-lines">
                                    <div class="box-line">
                                        <span class="left">Name</span>
                                        <span class="right" style="width: 70%;"><input type="text" name="education_level"
                                                                                       class="input"></span>
                                    </div>
                                </div>
                                <div class="button-wrap">
                                    <button class="button is-solid primary-button is-fullwidth">
                                        Create
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>


                </div>

                <div class="column is-6">

                    <div class="dashboard-box">
                        <h3 class="title is-5 is-thin">Available Professions</h3>

                        <div class="box-content">
                            <div id="profession_table"></div>

                            <script src="{{ url_for('static', filename='assets/vendor/js/gridjs.umd.js') }}"></script>
                            <script>
    const tableDiv4 = document.getElementById('profession_table');

    const updateUrl4 = (prev, query) => {
        return prev + (prev.indexOf('?') >= 0 ? '&' : '?') + new URLSearchParams(query).toString();
    };

    const editableCellAttributes4 = (data, row, col) => {
        if (row) {
            const columnId = col.id;
            return {
                contentEditable: 'true',
                'data-element-id': row.cells[0].data,
                'data-column-id': columnId
            };
        } else {
            return {};
        }
    };

    const grid4 = new gridjs.Grid({
        columns: [
            { id: 'id', hidden: true },
            {
                id: 'profession',
                name: 'Name',
                attributes: editableCellAttributes4
            },
            {
                id: 'background',
                name: 'Category',
                attributes: editableCellAttributes4
            },
            {
                name: 'Actions',
                attributes: () => ({ style: 'text-align: center;' }),
                formatter: (cell, row) => {
                    return gridjs.h(
                        'div',
                        { style: 'display: flex; justify-content: center;' },
                        gridjs.h(
                            'button',
                            {
                                className: 'btn btn-sm btn-danger',
                                onClick: () => {
                                    const id = row.cells[0].data;
                                    fetch(`/admin/delete_profession/${id}`, {
                                        method: 'DELETE',
                                    }).then(res => {
                                        if (res.ok) {
                                            grid4.forceRender();
                                        } else {
                                            alert("Failed to delete profession.");
                                        }
                                    });
                                }
                            },
                            'Delete'
                        )
                    );
                }
            }
        ],
        server: {
            url: '/admin/professions_data',
            then: results => results.data,
            total: results => results.total,
        },
        search: {
            enabled: true,
            server: {
                url: (prev, search) => updateUrl4(prev, { search }),
            },
        },
        sort: {
            enabled: true,
            multiColumn: true,
            server: {
                url: (prev, columns) => {
                    const columnIds = ['id', 'profession', 'background'];
                    const sort = columns.map(col => (col.direction === 1 ? '+' : '-') + columnIds[col.index]);
                    return updateUrl4(prev, { sort });
                },
            },
        },
        pagination: {
            enabled: true,
            server: {
                url: (prev, page, limit) => updateUrl4(prev, { start: page * limit, length: limit }),
            },
        },
    });

    grid4.render(tableDiv4);

    let savedValue4;

    tableDiv4.addEventListener('focusin', ev => {
        if (ev.target.tagName === 'TD') {
            savedValue4 = ev.target.textContent;
        }
    });

    tableDiv4.addEventListener('focusout', ev => {
        if (ev.target.tagName === 'TD' && ev.target.dataset.elementId) {
            if (savedValue4 !== ev.target.textContent) {
                fetch('/admin/professions_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: ev.target.dataset.elementId,
                        [ev.target.dataset.columnId]: ev.target.textContent
                    }),
                });
            }
            savedValue4 = undefined;
        }
    });

    tableDiv4.addEventListener('keydown', ev => {
        if (ev.target.tagName === 'TD') {
            if (ev.key === 'Escape') {
                ev.target.textContent = savedValue4;
                ev.target.blur();
            } else if (ev.key === 'Enter') {
                ev.preventDefault();
                ev.target.blur();
            }
        }
    });
</script>

                        </div>

                        <div class="box-content" style="margin-top: 30px;">
                            <h3 class="title is-5 is-thin">New Profession</h3>
                            <form action="/admin/create_profession" method="POST">
                                <div class="box-lines">
                                    <div class="box-line">
                                        <span class="left">Name</span>
                                        <span class="right" style="width: 70%;"><input type="text" name="profession"
                                                                                       class="input"></span>
                                    </div>
                                    <div class="box-line">
                                        <span class="left">Category</span>
                                        <span class="right" style="width: 70%;"><input type="text" name="background"
                                                                                       class="input"></span>
                                    </div>
                                </div>
                                <div class="button-wrap">
                                    <button class="button is-solid primary-button is-fullwidth">
                                        Create
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            </div>
            <!-- End Agent Attributes Tab -->

            <!-- Content & Topics Tab -->
            <div id="tab-content" class="misc-tab-content">
                <div class="misc-section-description">
                    <strong>Content & Topics:</strong> Define content topics and categories that agents can engage with, helping to create realistic content interactions and discussions within your simulations.
                </div>

                <div class="columns">
                    <div class="column is-12">
                        <div class="dashboard-box">
                            <h3 class="title is-5 is-thin">Available Topics</h3>

                        <div class="box-content">
                            <div id="topics_table"></div>

                            <script src="{{ url_for('static', filename='assets/vendor/js/gridjs.umd.js') }}"></script>
                            <script>
    const tableDiv6 = document.getElementById('topics_table');

    const updateUrl6 = (prev, query) => {
        return prev + (prev.indexOf('?') >= 0 ? '&' : '?') + new URLSearchParams(query).toString();
    };

    const editableCellAttributes6 = (data, row, col) => {
        if (row) {
            return {
                contentEditable: 'true',
                'data-element-id': row.cells[0].data,
                'data-column-id': 'name'
            };
        } else {
            return {};
        }
    };

    const grid6 = new gridjs.Grid({
        columns: [
            { id: 'id', hidden: true },
            {
                id: 'name',
                name: 'Name',
                attributes: editableCellAttributes6
            },
            {
                name: 'Actions',
                attributes: () => ({ style: 'text-align: center;' }),
                formatter: (cell, row) => {
                    return gridjs.h(
                        'div',
                        { style: 'display: flex; justify-content: center;' },
                        gridjs.h(
                            'button',
                            {
                                className: 'btn btn-sm btn-danger',
                                onClick: () => {
                                    const id = row.cells[0].data;
                                    fetch(`/admin/delete_topic/${id}`, {
                                        method: 'DELETE',
                                    }).then(res => {
                                        if (res.ok) {
                                            grid6.forceRender(); // refresh table
                                        } else {
                                            alert("Failed to delete topic.");
                                        }
                                    });
                                }
                            },
                            'Delete'
                        )
                    );
                }
            }
        ],
        server: {
            url: '/admin/topic_data',
            then: results => results.data,
            total: results => results.total,
        },
        search: {
            enabled: true,
            server: {
                url: (prev, search) => updateUrl6(prev, { search }),
            },
        },
        sort: {
            enabled: true,
            multiColumn: true,
            server: {
                url: (prev, columns) => {
                    const columnIds = ['id', 'name'];
                    const sort = columns.map(col => (col.direction === 1 ? '+' : '-') + columnIds[col.index]);
                    return updateUrl6(prev, { sort });
                },
            },
        },
        pagination: {
            enabled: true,
            server: {
                url: (prev, page, limit) => updateUrl6(prev, { start: page * limit, length: limit }),
            },
        },
    });

    grid6.render(tableDiv6);

    // Handle inline editing
    let savedValue6;

    tableDiv6.addEventListener('focusin', ev => {
        if (ev.target.tagName === 'TD') {
            savedValue6 = ev.target.textContent;
        }
    });

    tableDiv6.addEventListener('focusout', ev => {
        if (ev.target.tagName === 'TD' && ev.target.dataset.elementId) {
            if (savedValue6 !== ev.target.textContent) {
                fetch('/admin/topic_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: ev.target.dataset.elementId,
                        [ev.target.dataset.columnId]: ev.target.textContent
                    }),
                });
            }
            savedValue6 = undefined;
        }
    });

    tableDiv6.addEventListener('keydown', ev => {
        if (ev.target.tagName === 'TD') {
            if (ev.key === 'Escape') {
                ev.target.textContent = savedValue6;
                ev.target.blur();
            } else if (ev.key === 'Enter') {
                ev.preventDefault();
                ev.target.blur();
            }
        }
    });
</script>


                        </div>

                        <div class="box-content" style="margin-top: 30px;">
                            <h3 class="title is-5 is-thin">New Topic</h3>
                            <form action="/admin/create_topic" method="POST">
                                <div class="box-lines">
                                    <div class="box-line">
                                        <span class="left">Name</span>
                                        <span class="right" style="width: 70%;"><input type="text" name="topic"
                                                                                       class="input"></span>
                                    </div>
                                </div>
                                <div class="button-wrap">
                                    <button class="button is-solid primary-button is-fullwidth">
                                        Create
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            </div>
            <!-- End Content & Topics Tab -->

            <!-- Demographics Tab -->
            <div id="tab-demographics" class="misc-tab-content">
                <div class="misc-section-description">
                    <strong>Demographics:</strong> Manage languages and nationalities to create diverse and realistic agent populations that reflect real-world demographic distributions.
                </div>

                <div class="columns">
                    <div class="column is-6">
                        <div class="dashboard-box">
                            <h3 class="title is-5 is-thin">Available Languages</h3>

                        <div class="box-content">


                            <div id="language_table"></div>
                            <script>
    const tableDiv1 = document.getElementById('language_table');

    const updateUrl1 = (prev, query) => {
        return prev + (prev.indexOf('?') >= 0 ? '&' : '?') + new URLSearchParams(query).toString();
    };

    const editableCellAttributes1 = (data, row, col) => {
        if (row) {
            const columnId = col.id;
            return {
                contentEditable: 'true',
                'data-element-id': row.cells[0].data,
                'data-column-id': columnId
            };
        } else {
            return {};
        }
    };

    const grid1 = new gridjs.Grid({
        columns: [
            { id: 'id', hidden: true },
            {
                id: 'language',
                name: 'Name',
                attributes: editableCellAttributes1
            },
            {
                name: 'Actions',
                attributes: () => ({ style: 'text-align: center;' }),
                formatter: (cell, row) => {
                    return gridjs.h(
                        'div',
                        { style: 'display: flex; justify-content: center;' },
                        gridjs.h(
                            'button',
                            {
                                className: 'btn btn-sm btn-danger',
                                onClick: () => {
                                    const id = row.cells[0].data;
                                    fetch(`/admin/delete_language/${id}`, {
                                        method: 'DELETE',
                                    }).then(res => {
                                        if (res.ok) {
                                            grid1.forceRender();
                                        } else {
                                            alert("Failed to delete language.");
                                        }
                                    });
                                }
                            },
                            'Delete'
                        )
                    );
                }
            }
        ],
        server: {
            url: '/admin/languages_data',
            then: results => results.data,
            total: results => results.total,
        },
        search: {
            enabled: true,
            server: {
                url: (prev, search) => updateUrl1(prev, { search }),
            },
        },
        sort: {
            enabled: true,
            multiColumn: true,
            server: {
                url: (prev, columns) => {
                    const columnIds = ['id', 'language'];
                    const sort = columns.map(col => (col.direction === 1 ? '+' : '-') + columnIds[col.index]);
                    return updateUrl1(prev, { sort });
                },
            },
        },
        pagination: {
            enabled: true,
            server: {
                url: (prev, page, limit) => updateUrl1(prev, { start: page * limit, length: limit }),
            },
        },
    });

    grid1.render(tableDiv1);

    let savedValue1;

    tableDiv1.addEventListener('focusin', ev => {
        if (ev.target.tagName === 'TD') {
            savedValue1 = ev.target.textContent;
        }
    });

    tableDiv1.addEventListener('focusout', ev => {
        if (ev.target.tagName === 'TD' && ev.target.dataset.elementId) {
            if (savedValue1 !== ev.target.textContent) {
                fetch('/admin/languages_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: ev.target.dataset.elementId,
                        [ev.target.dataset.columnId]: ev.target.textContent
                    }),
                });
            }
            savedValue1 = undefined;
        }
    });

    tableDiv1.addEventListener('keydown', ev => {
        if (ev.target.tagName === 'TD') {
            if (ev.key === 'Escape') {
                ev.target.textContent = savedValue1;
                ev.target.blur();
            } else if (ev.key === 'Enter') {
                ev.preventDefault();
                ev.target.blur();
            }
        }
    });
</script>


                        </div>


                        <div class="box-content" style="margin-top: 30px;">
                            <h3 class="title is-5 is-thin">New Language</h3>
                            <form action="/admin/create_language" method="POST">
                                <div class="box-lines">
                                    <div class="box-line">
                                        <span class="left">Name</span>
                                        <span class="right" style="width: 70%;"><input type="text" name="language"
                                                                                       class="input"></span>
                                    </div>
                                </div>
                                <div class="button-wrap">
                                    <button class="button is-solid primary-button is-fullwidth">
                                        Create
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                </div>

                <div class="column is-6">

                    <div class="dashboard-box">
                        <h3 class="title is-5 is-thin">Available Nationalities</h3>

                        <div class="box-content">
                            <div id="nationality_table"></div>
                           <script>
    const tableDiv2 = document.getElementById('nationality_table');

    const updateUrl2 = (prev, query) => {
        return prev + (prev.indexOf('?') >= 0 ? '&' : '?') + new URLSearchParams(query).toString();
    };

    const editableCellAttributes2 = (data, row, col) => {
        if (row) {
            const columnId = col.id;
            return {
                contentEditable: 'true',
                'data-element-id': row.cells[0].data,
                'data-column-id': columnId
            };
        } else {
            return {};
        }
    };

    const grid2 = new gridjs.Grid({
        columns: [
            { id: 'id', hidden: true },
            {
                id: 'nationality',
                name: 'Name',
                attributes: editableCellAttributes2
            },
            {
                name: 'Actions',
                attributes: () => ({ style: 'text-align: center;' }),
                formatter: (cell, row) => {
                    return gridjs.h(
                        'div',
                        { style: 'display: flex; justify-content: center;' },
                        gridjs.h(
                            'button',
                            {
                                className: 'btn btn-sm btn-danger',
                                onClick: () => {
                                    const id = row.cells[0].data;
                                    fetch(`/admin/delete_nationality/${id}`, {
                                        method: 'DELETE',
                                    }).then(res => {
                                        if (res.ok) {
                                            grid2.forceRender();
                                        } else {
                                            alert("Failed to delete nationality.");
                                        }
                                    });
                                }
                            },
                            'Delete'
                        )
                    );
                }
            }
        ],
        server: {
            url: '/admin/nationalities_data',
            then: results => results.data,
            total: results => results.total,
        },
        search: {
            enabled: true,
            server: {
                url: (prev, search) => updateUrl2(prev, { search }),
            },
        },
        sort: {
            enabled: true,
            multiColumn: true,
            server: {
                url: (prev, columns) => {
                    const columnIds = ['id', 'nationality'];
                    const sort = columns.map(col => (col.direction === 1 ? '+' : '-') + columnIds[col.index]);
                    return updateUrl2(prev, { sort });
                },
            },
        },
        pagination: {
            enabled: true,
            server: {
                url: (prev, page, limit) => updateUrl2(prev, { start: page * limit, length: limit }),
            },
        },
    });

    grid2.render(tableDiv2);

    let savedValue2;

    tableDiv2.addEventListener('focusin', ev => {
        if (ev.target.tagName === 'TD') {
            savedValue2 = ev.target.textContent;
        }
    });

    tableDiv2.addEventListener('focusout', ev => {
        if (ev.target.tagName === 'TD' && ev.target.dataset.elementId) {
            if (savedValue2 !== ev.target.textContent) {
                fetch('/admin/nationalities_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: ev.target.dataset.elementId,
                        [ev.target.dataset.columnId]: ev.target.textContent
                    }),
                });
            }
            savedValue2 = undefined;
        }
    });

    tableDiv2.addEventListener('keydown', ev => {
        if (ev.target.tagName === 'TD') {
            if (ev.key === 'Escape') {
                ev.target.textContent = savedValue2;
                ev.target.blur();
            } else if (ev.key === 'Enter') {
                ev.preventDefault();
                ev.target.blur();
            }
        }
    });
</script>

                        </div>


                        <div class="box-content" style="margin-top: 30px;">
                            <h3 class="title is-5 is-thin">New Nationality</h3>
                            <form action="/admin/create_nationality" method="POST">
                                <div class="box-lines">
                                    <div class="box-line">
                                        <span class="left">Name</span>
                                        <span class="right" style="width: 70%;"><input type="text" name="nationality"
                                                                                       class="input"></span>
                                    </div>
                                </div>
                                <div class="button-wrap">
                                    <button class="button is-solid primary-button is-fullwidth">
                                        Create
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                </div>

                <!-- Age Classes Section -->
                <div class="columns">
                    <div class="column is-12">
                        <div class="dashboard-box">
                            <h3 class="title is-5 is-thin">Available Age Classes</h3>

                        <div class="box-content">
                            <div id="age_classes_table"></div>
                           <script>
    const tableDivAgeClasses = document.getElementById('age_classes_table');

    const updateUrlAgeClasses = (prev, query) => {
        return prev + (prev.indexOf('?') >= 0 ? '&' : '?') + new URLSearchParams(query).toString();
    };

    const editableCellAttributesAgeClasses = (data, row, col) => {
        if (row) {
            const columnId = col.id;
            return {
                contentEditable: 'true',
                'data-element-id': row.cells[0].data,
                'data-column-id': columnId
            };
        } else {
            return {};
        }
    };

    const gridAgeClasses = new gridjs.Grid({
        columns: [
            { id: 'id', hidden: true },
            {
                id: 'name',
                name: 'Name',
                attributes: editableCellAttributesAgeClasses
            },
            {
                id: 'age_start',
                name: 'Age Start',
                attributes: editableCellAttributesAgeClasses
            },
            {
                id: 'age_end',
                name: 'Age End',
                attributes: editableCellAttributesAgeClasses
            },
            {
                name: 'Actions',
                attributes: () => ({ style: 'text-align: center;' }),
                formatter: (cell, row) => {
                    return gridjs.h(
                        'div',
                        { style: 'display: flex; justify-content: center;' },
                        gridjs.h(
                            'button',
                            {
                                className: 'btn btn-sm btn-danger',
                                onClick: () => {
                                    const id = row.cells[0].data;
                                    fetch(`/admin/delete_age_class/${id}`, {
                                        method: 'DELETE',
                                    }).then(res => {
                                        if (res.ok) {
                                            gridAgeClasses.forceRender();
                                        } else {
                                            alert("Failed to delete age class.");
                                        }
                                    });
                                }
                            },
                            'Delete'
                        )
                    );
                }
            }
        ],
        server: {
            url: '/admin/age_classes_data',
            then: results => results.data,
            total: results => results.total,
        },
        search: {
            enabled: true,
            server: {
                url: (prev, search) => updateUrlAgeClasses(prev, { search }),
            },
        },
        sort: {
            enabled: true,
            multiColumn: true,
            server: {
                url: (prev, columns) => {
                    const columnIds = ['id', 'name', 'age_start', 'age_end'];
                    const sort = columns.map(col => (col.direction === 1 ? '+' : '-') + columnIds[col.index]);
                    return updateUrlAgeClasses(prev, { sort });
                },
            },
        },
        pagination: {
            enabled: true,
            server: {
                url: (prev, page, limit) => updateUrlAgeClasses(prev, { start: page * limit, length: limit }),
            },
        },
    });

    gridAgeClasses.render(tableDivAgeClasses);

    let savedValueAgeClasses;

    tableDivAgeClasses.addEventListener('focusin', ev => {
        if (ev.target.tagName === 'TD') {
            savedValueAgeClasses = ev.target.textContent;
        }
    });

    tableDivAgeClasses.addEventListener('focusout', ev => {
        if (ev.target.tagName === 'TD' && ev.target.dataset.elementId) {
            if (savedValueAgeClasses !== ev.target.textContent) {
                fetch('/admin/age_classes_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: ev.target.dataset.elementId,
                        [ev.target.dataset.columnId]: ev.target.textContent
                    }),
                });
            }
            savedValueAgeClasses = undefined;
        }
    });

    tableDivAgeClasses.addEventListener('keydown', ev => {
        if (ev.target.tagName === 'TD') {
            if (ev.key === 'Escape') {
                ev.target.textContent = savedValueAgeClasses;
                ev.target.blur();
            } else if (ev.key === 'Enter') {
                ev.preventDefault();
                ev.target.blur();
            }
        }
    });
</script>


                        </div>


                        <div class="box-content" style="margin-top: 30px;">
                            <h3 class="title is-5 is-thin">New Age Class</h3>
                            <form action="/admin/create_age_class" method="POST">
                                <div class="box-lines">
                                    <div class="box-line">
                                        <span class="left">Name</span>
                                        <span class="right" style="width: 70%;"><input type="text" name="name"
                                                                                       class="input" required></span>
                                    </div>
                                    <div class="box-line">
                                        <span class="left">Age Start</span>
                                        <span class="right" style="width: 70%;"><input type="number" name="age_start"
                                                                                       class="input" min="0" max="100" required></span>
                                    </div>
                                    <div class="box-line">
                                        <span class="left">Age End</span>
                                        <span class="right" style="width: 70%;"><input type="number" name="age_end"
                                                                                       class="input" min="0" max="120" required></span>
                                    </div>
                                </div>
                                <div class="button-wrap">
                                    <button class="button is-solid primary-button is-fullwidth">
                                        Create
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                </div>
            </div>
            </div>
            </div>
            <!-- End Demographics Tab -->

            <!-- Behavior Profiles Tab -->
            <div id="tab-behavior" class="misc-tab-content">
                <div class="misc-section-description">
                    <strong>Behavior Profiles:</strong> Configure toxicity levels and hourly activity patterns to simulate realistic agent behaviors and interaction patterns throughout the day.
                </div>

                <div class="columns">
                    <div class="column is-12">
                        <div class="dashboard-box">
                            <h3 class="title is-5 is-thin">Available Toxicity Levels</h3>

                        <div class="box-content">
                            <div id="toxicity_table"></div>
                           <script>
    const tableDiv3 = document.getElementById('toxicity_table');

    const updateUrl3 = (prev, query) => {
        return prev + (prev.indexOf('?') >= 0 ? '&' : '?') + new URLSearchParams(query).toString();
    };

    const editableCellAttributes3 = (data, row, col) => {
        if (row) {
            const columnId = col.id;
            return {
                contentEditable: 'true',
                'data-element-id': row.cells[0].data,
                'data-column-id': columnId
            };
        } else {
            return {};
        }
    };

    const grid3 = new gridjs.Grid({
        columns: [
            { id: 'id', hidden: true },
            {
                id: 'toxicity_level',
                name: 'Name',
                attributes: editableCellAttributes3
            },
            {
                name: 'Actions',
                attributes: () => ({ style: 'text-align: center;' }),
                formatter: (cell, row) => {
                    return gridjs.h(
                        'div',
                        { style: 'display: flex; justify-content: center;' },
                        gridjs.h(
                            'button',
                            {
                                className: 'btn btn-sm btn-danger',
                                onClick: () => {
                                    const id = row.cells[0].data;
                                    fetch(`/admin/delete_toxicity_level/${id}`, {
                                        method: 'DELETE',
                                    }).then(res => {
                                        if (res.ok) {
                                            grid3.forceRender();
                                        } else {
                                            alert("Failed to delete toxicity level.");
                                        }
                                    });
                                }
                            },
                            'Delete'
                        )
                    );
                }
            }
        ],
        server: {
            url: '/admin/toxicity_levels_data',
            then: results => results.data,
            total: results => results.total,
        },
        search: {
            enabled: true,
            server: {
                url: (prev, search) => updateUrl3(prev, { search }),
            },
        },
        sort: {
            enabled: true,
            multiColumn: true,
            server: {
                url: (prev, columns) => {
                    const columnIds = ['id', 'toxicity_level'];
                    const sort = columns.map(col => (col.direction === 1 ? '+' : '-') + columnIds[col.index]);
                    return updateUrl3(prev, { sort });
                },
            },
        },
        pagination: {
            enabled: true,
            server: {
                url: (prev, page, limit) => updateUrl3(prev, { start: page * limit, length: limit }),
            },
        },
    });

    grid3.render(tableDiv3);

    let savedValue3;

    tableDiv3.addEventListener('focusin', ev => {
        if (ev.target.tagName === 'TD') {
            savedValue3 = ev.target.textContent;
        }
    });

    tableDiv3.addEventListener('focusout', ev => {
        if (ev.target.tagName === 'TD' && ev.target.dataset.elementId) {
            if (savedValue3 !== ev.target.textContent) {
                fetch('/admin/toxicity_levels_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: ev.target.dataset.elementId,
                        [ev.target.dataset.columnId]: ev.target.textContent
                    }),
                });
            }
            savedValue3 = undefined;
        }
    });

    tableDiv3.addEventListener('keydown', ev => {
        if (ev.target.tagName === 'TD') {
            if (ev.key === 'Escape') {
                ev.target.textContent = savedValue3;
                ev.target.blur();
            } else if (ev.key === 'Enter') {
                ev.preventDefault();
                ev.target.blur();
            }
        }
    });
</script>

                        </div>


                        <div class="box-content" style="margin-top: 30px;">
                            <h3 class="title is-5 is-thin">New Toxicity Level</h3>
                            <form action="/admin/create_toxicity_level" method="POST">
                                <div class="box-lines">
                                    <div class="box-line">
                                        <span class="left">Name</span>
                                        <span class="right" style="width: 70%;"><input type="text" name="toxicity_level"
                                                                                       class="input"></span>
                                    </div>
                                </div>
                                <div class="button-wrap">
                                    <button class="button is-solid primary-button is-fullwidth">
                                        Create
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div class="columns">
                <div class="column is-12">
                    <div class="dashboard-box">
                        <h3 class="title is-5 is-thin">Available Activity Profiles</h3>

                        <div class="box-content">
                            <div id="activity_profiles_table"></div>
                           <script>
    const tableDivActivity = document.getElementById('activity_profiles_table');

    const updateUrlActivity = (prev, query) => {
        return prev + (prev.indexOf('?') >= 0 ? '&' : '?') + new URLSearchParams(query).toString();
    };

    const editableCellAttributesActivity = (data, row, col) => {
        if (row && col.id === 'name') {
            return {
                contentEditable: 'true',
                'data-element-id': row.cells[0].data,
                'data-column-id': col.id
            };
        } else {
            return {};
        }
    };

    const gridActivity = new gridjs.Grid({
        columns: [
            { id: 'id', hidden: true },
            {
                id: 'name',
                name: 'Name',
                attributes: editableCellAttributesActivity,
                width: '200px'
            },
            {
                id: 'hours',
                name: 'Activity Hours',
                width: '500px',
                formatter: (cell) => {
                    const hours = cell ? cell.split(',').map(h => parseInt(h.trim())) : [];
                    const barHtml = Array.from({length: 24}, (_, i) => {
                        const isActive = hours.includes(i);
                        const intensity = isActive ? 1 : 0;
                        const bgColor = isActive ? 'rgba(34, 197, 94, 0.8)' : 'rgba(229, 231, 235, 0.5)';
                        return `<div style="display: inline-block; width: 4%; height: 20px; background-color: ${bgColor}; border: 1px solid #e5e7eb; margin: 0; title='Hour ${i}'" title="Hour ${i}"></div>`;
                    }).join('');
                    return gridjs.html(`<div style="display: flex; width: 100%; gap: 0;">${barHtml}</div>`);
                }
            },
            {
                name: 'Actions',
                attributes: () => ({ style: 'text-align: center;' }),
                width: '100px',
                formatter: (cell, row) => {
                    return gridjs.h(
                        'div',
                        { style: 'display: flex; justify-content: center;' },
                        gridjs.h(
                            'button',
                            {
                                className: 'btn btn-sm btn-danger',
                                onClick: () => {
                                    const id = row.cells[0].data;
                                    fetch(`/admin/delete_activity_profile/${id}`, {
                                        method: 'DELETE',
                                    }).then(res => {
                                        if (res.ok) {
                                            gridActivity.forceRender();
                                        } else {
                                            alert("Failed to delete activity profile.");
                                        }
                                    });
                                }
                            },
                            'Delete'
                        )
                    );
                }
            }
        ],
        server: {
            url: '/admin/activity_profiles_data',
            then: results => results.data,
            total: results => results.total,
        },
        search: {
            enabled: true,
            server: {
                url: (prev, search) => updateUrlActivity(prev, { search }),
            },
        },
        sort: {
            enabled: true,
            multiColumn: true,
            server: {
                url: (prev, columns) => {
                    const columnIds = ['id', 'name', 'hours'];
                    const sort = columns.map(col => (col.direction === 1 ? '+' : '-') + columnIds[col.index]);
                    return updateUrlActivity(prev, { sort });
                },
            },
        },
        pagination: {
            enabled: true,
            server: {
                url: (prev, page, limit) => updateUrlActivity(prev, { start: page * limit, length: limit }),
            },
        },
    });

    gridActivity.render(tableDivActivity);

    let savedValueActivity;

    tableDivActivity.addEventListener('focusin', ev => {
        if (ev.target.tagName === 'TD') {
            savedValueActivity = ev.target.textContent;
        }
    });

    tableDivActivity.addEventListener('focusout', ev => {
        if (ev.target.tagName === 'TD' && ev.target.dataset.elementId) {
            if (savedValueActivity !== ev.target.textContent) {
                fetch('/admin/activity_profiles_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: ev.target.dataset.elementId,
                        [ev.target.dataset.columnId]: ev.target.textContent
                    }),
                });
            }
            savedValueActivity = undefined;
        }
    });

    tableDivActivity.addEventListener('keydown', ev => {
        if (ev.target.tagName === 'TD') {
            if (ev.key === 'Escape') {
                ev.target.textContent = savedValueActivity;
                ev.target.blur();
            } else if (ev.key === 'Enter') {
                ev.preventDefault();
                ev.target.blur();
            }
        }
    });
</script>

                        </div>


                        <div class="box-content" style="margin-top: 30px;">
                            <h3 class="title is-5 is-thin">New Activity Profile</h3>
                            <form action="/admin/create_activity_profile" method="POST">
                                <div class="box-lines">
                                    <div class="box-line">
                                        <span class="left">Profile Name</span>
                                        <span class="right" style="width: 70%;"><input type="text" name="name" required
                                                                                       class="input" placeholder="e.g., Morning Active"></span>
                                    </div>
                                    <div class="box-line" style="display: block; padding: 15px 0;">
                                        <label style="display: block; margin-bottom: 12px; font-weight: 500;">Select Active Hours (0-23):</label>
                                        <style>
                                            .hour-selector {
                                                display: flex;
                                                flex-wrap: wrap;
                                                gap: 6px;
                                                max-width: 100%;
                                            }
                                            .hour-toggle {
                                                position: relative;
                                                display: inline-block;
                                            }
                                            .hour-toggle input[type="checkbox"] {
                                                position: absolute;
                                                opacity: 0;
                                                width: 0;
                                                height: 0;
                                            }
                                            .hour-toggle label {
                                                display: inline-block;
                                                min-width: 40px;
                                                padding: 6px 10px;
                                                text-align: center;
                                                font-size: 0.85em;
                                                font-weight: 500;
                                                border: 2px solid #e0e0e0;
                                                border-radius: 6px;
                                                background-color: #f8f9fa;
                                                color: #666;
                                                cursor: pointer;
                                                transition: all 0.2s ease;
                                                user-select: none;
                                            }
                                            .hour-toggle input[type="checkbox"]:checked + label {
                                                background-color: #22c55e;
                                                border-color: #16a34a;
                                                color: white;
                                                box-shadow: 0 2px 4px rgba(34, 197, 94, 0.3);
                                            }
                                            .hour-toggle label:hover {
                                                border-color: #22c55e;
                                                transform: translateY(-1px);
                                            }
                                            .hour-selector-controls {
                                                margin-top: 10px;
                                                display: flex;
                                                gap: 8px;
                                            }
                                            .hour-selector-controls button {
                                                padding: 4px 12px;
                                                font-size: 0.8em;
                                                border: 1px solid #ddd;
                                                background: white;
                                                border-radius: 4px;
                                                cursor: pointer;
                                                transition: all 0.2s ease;
                                            }
                                            .hour-selector-controls button:hover {
                                                background: #f0f0f0;
                                                border-color: #999;
                                            }
                                        </style>
                                        <div class="hour-selector">
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="0" id="hour_0"><label for="hour_0">0</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="1" id="hour_1"><label for="hour_1">1</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="2" id="hour_2"><label for="hour_2">2</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="3" id="hour_3"><label for="hour_3">3</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="4" id="hour_4"><label for="hour_4">4</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="5" id="hour_5"><label for="hour_5">5</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="6" id="hour_6"><label for="hour_6">6</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="7" id="hour_7"><label for="hour_7">7</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="8" id="hour_8"><label for="hour_8">8</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="9" id="hour_9"><label for="hour_9">9</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="10" id="hour_10"><label for="hour_10">10</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="11" id="hour_11"><label for="hour_11">11</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="12" id="hour_12"><label for="hour_12">12</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="13" id="hour_13"><label for="hour_13">13</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="14" id="hour_14"><label for="hour_14">14</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="15" id="hour_15"><label for="hour_15">15</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="16" id="hour_16"><label for="hour_16">16</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="17" id="hour_17"><label for="hour_17">17</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="18" id="hour_18"><label for="hour_18">18</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="19" id="hour_19"><label for="hour_19">19</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="20" id="hour_20"><label for="hour_20">20</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="21" id="hour_21"><label for="hour_21">21</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="22" id="hour_22"><label for="hour_22">22</label></div>
                                            <div class="hour-toggle"><input type="checkbox" name="hour" value="23" id="hour_23"><label for="hour_23">23</label></div>
                                        </div>
                                        <div class="hour-selector-controls">
                                            <button type="button" onclick="document.querySelectorAll('.hour-toggle input[type=checkbox]').forEach(cb => cb.checked = true)">Select All</button>
                                            <button type="button" onclick="document.querySelectorAll('.hour-toggle input[type=checkbox]').forEach(cb => cb.checked = false)">Clear All</button>
                                            <button type="button" onclick="document.querySelectorAll('.hour-toggle input[type=checkbox]').forEach((cb, i) => cb.checked = i >= 9 && i <= 17)">Business Hours (9-17)</button>
                                        </div>
                                        <input type="hidden" name="hours" id="hours_input" value="">
                                    </div>
                                </div>
                                <div class="button-wrap">
                                    <button type="submit" class="button is-solid primary-button is-fullwidth">
                                        Create Profile
                                    </button>
                                </div>
                            </form>
                            <script>
                                // Collect selected hours when form is submitted
                                document.querySelector('form[action="/admin/create_activity_profile"]').addEventListener('submit', function(e) {
                                    const checkboxes = document.querySelectorAll('input[name="hour"]:checked');
                                    const hours = Array.from(checkboxes).map(cb => cb.value);
                                    document.getElementById('hours_input').value = hours.join(',');
                                });
                            </script>
                        </div>
                    </div>
                </div>
            </div>
            </div>
            <!-- End Behavior Profiles Tab -->

            <script>
                function switchMiscTab(tabName) {
                    // Hide all tabs
                    document.querySelectorAll('.misc-tab-content').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    // Remove active from all buttons
                    document.querySelectorAll('.misc-tab').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    // Show selected tab
                    document.getElementById('tab-' + tabName).classList.add('active');
                    // Set button as active
                    event.target.classList.add('active');
                }
            </script>

        </div>
    </div>

</div>

{% include "admin/footer.html" %}