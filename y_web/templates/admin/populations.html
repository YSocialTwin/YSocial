{% include "admin/head.html" %}

 <div class="view-wrapper is-dashboard">
        <!--Dashboard container-->
        <div id="creator-dashboard" class="dashboard-container">
            <!--Toolbar-->
            {% include "admin/dash_head.html" %}

            <div class="dashboard-body">
                <div class="columns">
                    <div class="column is-12">
                        <div class="dashboard-box">
                            <h3 class="title is-5 is-thin">Available Populations</h3>

                            <div class="box-content">

                                <div id="table"></div>

                                <script src="{{ url_for('static', filename='assets/vendor/js/gridjs.umd.js') }}"></script>

                                <style>

                              #table td {
                                vertical-align: middle !important;
                              }
                            </style>


                                <script>
  const tableDiv = document.getElementById('table');

  const updateUrl = (prev, query) => {
    return prev + (prev.indexOf('?') >= 0 ? '&' : '?') + new URLSearchParams(query).toString();
  };

  const editableCellAttributes = (data, row, col) => {
    if (row) {
      return {
        contentEditable: 'true',
        'data-element-id': row.cells[0].data,
        'data-column-id': col.id
      };
    } else {
      return {};
    }
  };

  new gridjs.Grid({
    columns: [
      { id: 'id', hidden: true },
      { id: 'name', name: 'Name', attributes: editableCellAttributes },
      { id: 'descr', name: 'Description' },
        {id: "size", name: 'Number of Agents'},
      {
        id: 'actions',
        name: 'Actions',
        sort: false,
        formatter: (cell, row) => {
          const id = row.cells[0].data;
          return gridjs.html(`
            <div style="display: flex; gap: 8px; justify-content: center;">
              <a href="/admin/population_details/${id}"
                 style="background-color: #28a745; color: white; padding: 5px 10px; border-radius: 4px; text-decoration: none; font-size: 0.85rem;">
                Details
              </a>
              </a>
               <a href="/admin/delete_population/${id}"
                 style="background-color: #dc3545; color: white; padding: 5px 10px; border-radius: 4px; text-decoration: none; font-size: 0.85rem;">
                Delete
              </a>
            </div>
          `);
        }
      },
    ],
    server: {
      url: '/admin/populations_data',
      then: results => results.data,
      total: results => results.total,
    },
    search: {
      enabled: true,
      server: {
        url: (prev, search) => {
          return updateUrl(prev, { search });
        },
      },
    },
    sort: {
      enabled: true,
      multiColumn: true,
      server: {
        url: (prev, columns) => {
          const columnIds = ['id', 'name', 'descr', 'size'];
          const sort = columns.map(col => (col.direction === 1 ? '+' : '-') + columnIds[col.index]);
          return updateUrl(prev, { sort });
        },
      },
    },
    pagination: {
      enabled: true,
      server: {
        url: (prev, page, limit) => {
          return updateUrl(prev, { start: page * limit, length: limit });
        },
      },
    },
  }).render(tableDiv);

  let savedValue;

  // Handle inline edits
  tableDiv.addEventListener('focusin', ev => {
    if (ev.target.tagName === 'TD') {
      savedValue = ev.target.textContent;
    }
  });

  tableDiv.addEventListener('focusout', ev => {
    if (ev.target.tagName === 'TD') {
      if (savedValue !== ev.target.textContent) {
        fetch('/admin/populations_data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id: ev.target.dataset.elementId,
            [ev.target.dataset.columnId]: ev.target.textContent
          }),
        });
      }
      savedValue = undefined;
    }
  });

  tableDiv.addEventListener('keydown', ev => {
    if (ev.target.tagName === 'TD') {
      if (ev.key === 'Escape') {
        ev.target.textContent = savedValue;
        ev.target.blur();
      } else if (ev.key === 'Enter') {
        ev.preventDefault();
        ev.target.blur();
      }
    }
  });

  // Handle delete button clicks
  tableDiv.addEventListener('click', function (event) {
    const target = event.target;
    if (target.classList.contains('delete-button')) {
      const id = target.getAttribute('data-id');
      if (confirm('Are you sure you want to delete this population?')) {
        fetch(`/admin/delete_population/${id}`, {
          method: 'DELETE',
        })
        .then(response => {
          if (!response.ok) throw new Error('Failed to delete');
          location.reload(); // Refresh the table
        })
        .catch(err => {
          alert('Error deleting population.');
          console.error(err);
        });
      }
    }
  });
</script>



                            </div>
                        </div>
                    </div>
                </div>

                <div class="columns">
                    <!--Dashboard column-->
                    <div class="column is-8">

                        {% for message in get_flashed_messages() %}
                        <div class="alert alert-warning">
                            <button type="button" class="close" data-dismiss="alert">&times;</button>
                            {{ message }}
                        </div>
                        {% endfor %}

                        <!--Dashboard box-->
                        <div class="dashboard-box">
                        <h3 class="title is-5 is-thin">Load Population from file</h3>
                        <div class="box-content">
                            <form action="/admin/upload_population" enctype="multipart/form-data" method="POST">
                                <div class="box-lines">

                                    <div class="box-line">
                                        <span class="left">File (json)</span>
                                        <span class="right"><input type="file" id="population_file" name="population_file"
                                                                   class="input_file"></span>
                                    </div>
                                </div>
                                <div class="button-wrap">
                                    <button class="button is-solid primary-button is-fullwidth">
                                        Upload
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>


                        <div class="dashboard-box">
                            <h3 class="title is-5 is-thin">Create Empty Population</h3>
                            <div class="box-content">
                                <form action="/admin/create_population_empty" enctype="multipart/form-data" method="POST">
                                <div class="box-lines">

                                    <div class="box-line">
                                        <span class="left">Population Name</span>
                                        <span class="right" style="width: 70%;"><input type="text" name="empty_population_name"  class="input"></span>
                                    </div>
                                    <div class="box-line">
                                        <span class="left">Description</span>
                                        <span class="right" style="width: 70%;"><input type="text" name="empty_population_descr" class="input"></span>
                                    </div>
                                </div>
                                <div class="button-wrap">
                                    <button class="button is-solid primary-button is-fullwidth">
                                        Create
                                    </button>
                                </div>
                                </form>
                            </div>
                        </div>

                        <div class="dashboard-box">
                            <h3 class="title is-5 is-thin">Create Synthetic Population</h3>
                            <div class="box-content">
                                <form action="/admin/create_population" id="popcreate_form" enctype="multipart/form-data" method="POST">
                                <div class="box-lines">

                                    <div class="box-line">
                                        <span class="left">Population Name</span>
                                        <span class="right" style="width: 70%;"><input type="text" name="pop_name"  class="input"></span>
                                    </div>
                                    <div class="box-line">
                                        <span class="left">Description</span>
                                        <span class="right" style="width: 70%;"><input type="text" name="pop_descr" class="input"></span>
                                    </div>
                                    <div class="box-line">
                                        <span class="left">Population Size</span>
                                        <div class="slider-timeline">
                                            <input name="n_agents" type="text" value="100" class="input">
                                       <!-- <input name="n_agents" type="range" value="100" min="1" max="1000" oninput="this.nextElementSibling.value = this.value"> -->
                                        <!--<output>100</output>-->
                                        </div>
                                    </div>

                                    <div class="box-line">
                                        <span class="left">Content RecSys</span>
                                        <div class="select">
                                            <select name="recsys_type">
                                                {% for recsys in crecsys %}
                                                <option value="{{ recsys.name }}">{{ recsys.value }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="box-line">
                                        <span class="left">Friendship RecSys</span>
                                        <div class="select">
                                            <select name="frecsys_type">
                                                {% for recsys in frecsys %}
                                                <option value="{{ recsys.name }}">{{ recsys.value }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="box-line">
                                        <span class="left">Age Range</span>
                                        <div class="slider-timeline">
                                        <input name="age_min" type="range" value="18" min="1" max="100" oninput="this.nextElementSibling.value = this.value">
                                        <output>18</output>
                                            <input name="age_max" type="range" value="60" min="1" max="100" oninput="this.nextElementSibling.value = this.value">
                                        <output>60</output>
                                        </div>
                                    </div>
                                    <hr>
                                    <h4><b>Categorical Attributes</b></h4>
                                    <div class="box-line" style="height: 80px;">
                                        <span class="left">Education Levels</span>
                                            <span class="right" style="width: 70%;">
                                                <div class="select">
                                                    <select multiple size="2" name="education_levels">
                                                        {% for education_level in education_levels %}
                                                        <option value="{{ education_level.education_level }}">{{ education_level.education_level }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            </span>
                                        </span>
                                    </div>
                                    <div class="box-line" style="height: 80px;">
                                        <span class="left">Political Leanings</span>
                                        <span class="right" style="width: 70%;">
                                            <div class="select">
                                            <select multiple size="2" name="political_leanings">
                                                {% for political_leaning in leanings %}
                                                <option value="{{ political_leaning.leaning }}">{{ political_leaning.leaning }}</option>
                                                {% endfor %}
                                            </select>
                                            </div>
                                        </span>
                                    </div>
                                    <div class="box-line" style="height: 80px; margin-bottom: 20px;">
                                        <span class="left">Toxicity Levels</span>
                                        <span class="right" style="width: 70%;">
                                            <div class="select">
                                            <select multiple size="2" name="toxicity_levels">
                                                {% for toxicity_level in toxicity_levels %}
                                                <option value="{{ toxicity_level.toxicity_level }}">{{ toxicity_level.toxicity_level }}</option>
                                                {% endfor %}
                                            </select>
                                            </div>
                                        </span>
                                    </div>

                                    <div class="box-line">
                                        <span class="left">Nationalities</span>
                                        <span class="right" style="width: 70%;">
                                            <div class="select">
                                            <select name="nationalities">
                                                {% for nationality in nationalities %}
                                                <option value="{{ nationality.nationality }}">{{ nationality.nationality }}</option>
                                                {% endfor %}
                                            </select>
                                            </div>
                                        </span>
                                    </div>
                                     <div class="box-line">
                                        <span class="left">Spoken Language</span>
                                        <span class="right" style="width: 70%;">
                                            <div class="select">
                                            <select name="languages">
                                                {% for lang in languages %}
                                                <option value="{{ lang.language }}">{{ lang.language }}</option>
                                                {% endfor %}
                                            </select>
                                            </div>


                                        </span>
                                    </div>

                                    <hr style="margin: 30px 0;">
                                    <h4><b>Activity Profiles</b></h4>
                                    <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">
                                        Assign activity profiles to define when agents are active during the day. Drag profiles from the available list to assign them, then specify the percentage of agents for each profile.
                                    </p>

                                    <style>
                                        .activity-profiles-container {
                                            display: flex;
                                            gap: 20px;
                                            margin-bottom: 20px;
                                        }
                                        .profiles-list {
                                            flex: 1;
                                            min-height: 200px;
                                            border: 2px dashed #d0d0d0;
                                            border-radius: 8px;
                                            padding: 15px;
                                            background-color: #fafafa;
                                        }
                                        .profiles-list h5 {
                                            margin: 0 0 10px 0;
                                            font-size: 0.95em;
                                            font-weight: 600;
                                            color: #333;
                                        }
                                        .profile-item {
                                            background: white;
                                            border: 1px solid #ddd;
                                            border-radius: 6px;
                                            padding: 10px 12px;
                                            margin-bottom: 8px;
                                            cursor: move;
                                            transition: all 0.2s ease;
                                            display: flex;
                                            justify-content: space-between;
                                            align-items: center;
                                        }
                                        .profile-item:hover {
                                            border-color: #22c55e;
                                            box-shadow: 0 2px 4px rgba(34, 197, 94, 0.2);
                                            transform: translateY(-1px);
                                        }
                                        .profile-item.dragging {
                                            opacity: 0.5;
                                        }
                                        .profile-name {
                                            font-weight: 500;
                                            font-size: 0.9em;
                                        }
                                        .profile-hours {
                                            font-size: 0.75em;
                                            color: #666;
                                            margin-top: 3px;
                                        }
                                        .assigned-profile {
                                            background: white;
                                            border: 1px solid #22c55e;
                                            border-radius: 6px;
                                            padding: 12px;
                                            margin-bottom: 10px;
                                            display: flex;
                                            align-items: center;
                                            gap: 10px;
                                        }
                                        .assigned-profile-info {
                                            flex: 1;
                                        }
                                        .assigned-profile-name {
                                            font-weight: 500;
                                            font-size: 0.9em;
                                            color: #333;
                                        }
                                        .assigned-profile-hours {
                                            font-size: 0.75em;
                                            color: #666;
                                            margin-top: 2px;
                                        }
                                        .percentage-input {
                                            width: 80px;
                                            padding: 5px 8px;
                                            border: 1px solid #ddd;
                                            border-radius: 4px;
                                            text-align: center;
                                            font-size: 0.9em;
                                        }
                                        .remove-profile-btn {
                                            background: #dc3545;
                                            color: white;
                                            border: none;
                                            border-radius: 4px;
                                            padding: 5px 10px;
                                            cursor: pointer;
                                            font-size: 0.8em;
                                            transition: background 0.2s;
                                        }
                                        .remove-profile-btn:hover {
                                            background: #c82333;
                                        }
                                        .drag-over {
                                            background-color: #e8f5e9;
                                            border-color: #22c55e;
                                        }
                                        .percentage-validation {
                                            margin-top: 10px;
                                            padding: 10px;
                                            border-radius: 4px;
                                            font-size: 0.85em;
                                        }
                                        .percentage-validation.error {
                                            background: #fee;
                                            border: 1px solid #fcc;
                                            color: #c00;
                                        }
                                        .percentage-validation.success {
                                            background: #efe;
                                            border: 1px solid #cfc;
                                            color: #0a0;
                                        }
                                        .empty-state {
                                            text-align: center;
                                            color: #999;
                                            font-size: 0.85em;
                                            padding: 20px;
                                        }
                                    </style>

                                    <div class="activity-profiles-container">
                                        <div class="profiles-list">
                                            <h5>Available Profiles</h5>
                                            <div id="available-profiles">
                                                {% if activity_profiles %}
                                                    {% for profile in activity_profiles %}
                                                    <div class="profile-item" draggable="true" data-profile-id="{{ profile.id }}" data-profile-name="{{ profile.name }}" data-profile-hours="{{ profile.hours }}">
                                                        <div>
                                                            <div class="profile-name">{{ profile.name }}</div>
                                                            <div class="profile-hours">Hours: {{ profile.hours }}</div>
                                                        </div>
                                                        <span style="color: #999;">⋮⋮</span>
                                                    </div>
                                                    {% endfor %}
                                                {% else %}
                                                    <div class="empty-state">No activity profiles available. Create some in the Miscellanea page first.</div>
                                                {% endif %}
                                            </div>
                                        </div>

                                        <div class="profiles-list">
                                            <h5>Assigned Profiles (with Percentages)</h5>
                                            <div id="assigned-profiles">
                                                <div class="empty-state">Drag profiles here to assign them</div>
                                            </div>
                                            <div id="percentage-validation" class="percentage-validation" style="display: none;"></div>
                                        </div>
                                    </div>

                                    <input type="hidden" name="activity_profiles_data" id="activity_profiles_data" value="">

                                    <script>
                                        // Drag and drop functionality for activity profiles
                                        let assignedProfiles = [];

                                        function initDragAndDrop() {
                                            const availableContainer = document.getElementById('available-profiles');
                                            const assignedContainer = document.getElementById('assigned-profiles');

                                            // Make profile items draggable
                                            document.querySelectorAll('.profile-item').forEach(item => {
                                                item.addEventListener('dragstart', handleDragStart);
                                                item.addEventListener('dragend', handleDragEnd);
                                            });

                                            // Make assigned profiles area droppable
                                            assignedContainer.addEventListener('dragover', handleDragOver);
                                            assignedContainer.addEventListener('drop', handleDrop);
                                            assignedContainer.addEventListener('dragleave', handleDragLeave);
                                        }

                                        function handleDragStart(e) {
                                            e.currentTarget.classList.add('dragging');
                                            e.dataTransfer.effectAllowed = 'copy';
                                            e.dataTransfer.setData('text/plain', JSON.stringify({
                                                id: e.currentTarget.dataset.profileId,
                                                name: e.currentTarget.dataset.profileName,
                                                hours: e.currentTarget.dataset.profileHours
                                            }));
                                        }

                                        function handleDragEnd(e) {
                                            e.currentTarget.classList.remove('dragging');
                                        }

                                        function handleDragOver(e) {
                                            e.preventDefault();
                                            e.dataTransfer.dropEffect = 'copy';
                                            e.currentTarget.classList.add('drag-over');
                                        }

                                        function handleDragLeave(e) {
                                            if (e.currentTarget === e.target) {
                                                e.currentTarget.classList.remove('drag-over');
                                            }
                                        }

                                        function handleDrop(e) {
                                            e.preventDefault();
                                            e.currentTarget.classList.remove('drag-over');
                                            
                                            const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                                            
                                            // Check if profile is already assigned
                                            if (assignedProfiles.find(p => p.id === data.id)) {
                                                return; // Already assigned
                                            }

                                            // Add to assigned profiles
                                            assignedProfiles.push({
                                                id: data.id,
                                                name: data.name,
                                                hours: data.hours,
                                                percentage: 0
                                            });

                                            renderAssignedProfiles();
                                            validatePercentages();
                                        }

                                        function renderAssignedProfiles() {
                                            const container = document.getElementById('assigned-profiles');
                                            
                                            if (assignedProfiles.length === 0) {
                                                container.innerHTML = '<div class="empty-state">Drag profiles here to assign them</div>';
                                                return;
                                            }

                                            container.innerHTML = assignedProfiles.map(profile => `
                                                <div class="assigned-profile">
                                                    <div class="assigned-profile-info">
                                                        <div class="assigned-profile-name">${profile.name}</div>
                                                        <div class="assigned-profile-hours">Hours: ${profile.hours}</div>
                                                    </div>
                                                    <input type="number" 
                                                           class="percentage-input" 
                                                           min="0" 
                                                           max="100" 
                                                           step="0.01"
                                                           placeholder="%" 
                                                           value="${profile.percentage || ''}"
                                                           onchange="updatePercentage('${profile.id}', this.value)">
                                                    <span style="font-size: 0.9em; color: #666;">%</span>
                                                    <button type="button" class="remove-profile-btn" onclick="removeProfile('${profile.id}')">Remove</button>
                                                </div>
                                            `).join('');
                                        }

                                        function updatePercentage(profileId, percentage) {
                                            const profile = assignedProfiles.find(p => p.id === profileId);
                                            if (profile) {
                                                profile.percentage = parseFloat(percentage) || 0;
                                                validatePercentages();
                                                updateHiddenField();
                                            }
                                        }

                                        function removeProfile(profileId) {
                                            assignedProfiles = assignedProfiles.filter(p => p.id !== profileId);
                                            renderAssignedProfiles();
                                            validatePercentages();
                                            updateHiddenField();
                                        }

                                        function validatePercentages() {
                                            const validation = document.getElementById('percentage-validation');
                                            const total = assignedProfiles.reduce((sum, p) => sum + (p.percentage || 0), 0);
                                            
                                            if (assignedProfiles.length === 0) {
                                                validation.style.display = 'none';
                                                return true;
                                            }

                                            validation.style.display = 'block';
                                            
                                            if (Math.abs(total - 100) < 0.01) {
                                                validation.className = 'percentage-validation success';
                                                validation.textContent = `✓ Total: ${total.toFixed(2)}% - Perfect!`;
                                                return true;
                                            } else {
                                                validation.className = 'percentage-validation error';
                                                validation.textContent = `⚠ Total: ${total.toFixed(2)}% - Must equal 100%`;
                                                return false;
                                            }
                                        }

                                        function updateHiddenField() {
                                            const data = assignedProfiles.map(p => ({
                                                id: p.id,
                                                name: p.name,
                                                percentage: p.percentage || 0
                                            }));
                                            document.getElementById('activity_profiles_data').value = JSON.stringify(data);
                                        }

                                        // Initialize on page load
                                        document.addEventListener('DOMContentLoaded', function() {
                                            initDragAndDrop();
                                        });

                                        // Form validation before submit
                                        document.getElementById('popcreate_form').addEventListener('submit', function(e) {
                                            if (assignedProfiles.length > 0 && !validatePercentages()) {
                                                e.preventDefault();
                                                alert('Please ensure that the total percentage of assigned activity profiles equals 100%');
                                                return false;
                                            }
                                        });
                                    </script>

                                </div>
                                <div class="button-wrap">
                                    <button class="button is-solid primary-button is-fullwidth">
                                        Create
                                    </button>
                                </div>
                                </form>
                            </div>
                        </div>


                        <!--Dashboard box-->

                    </div>


                    <!--Dashboard column-->
                    <div class="column is-4">
                        <!--Box-->
                        <div class="dashboard-box is-compact">
                            <h3 class="title is-5 is-thin">Guide</h3>
                            <div class="help-block">

                                <p>
                                    <b>What is a Population?</b>
                                    A population is a group of agents/pages that are used in a simulation.
                                    Each simulation can have multiple populations.
                                </p>
                                <br>
                                    <p>
                                        <b>Empty Populations</b>
                                         are used to create populations from scratch.
                                        Once created, you can add agents to the them.
                                </p>
                                <br>
                                <p>
                                    <b>Synthetic Populations</b>
                                     are created using a a predefined set of parameters.
                                    Leveraging the parameters provided as input, agents are generated and added to the population.
                                </p>
                                <br>
                                <p>
                                    <b>LLM</b>
                                    Although for synthetic populations it is specified an LLM to simulate its agents it is always possible to add agents served by other LLMs.
                                </p>
                            </div>
                        </div>


                    </div>
                </div>
            </div>
        </div>

    </div>



{% include "admin/footer.html" %}