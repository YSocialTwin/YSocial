{% include "admin/head.html" %}

 <div class="view-wrapper is-dashboard">
        <!--Dashboard container-->
        <div id="creator-dashboard" class="dashboard-container">
            <!--Toolbar-->
            {% include "admin/dash_head.html" %}

            <div class="dashboard-body">
                <div class="columns">
                    <div class="column is-12">
                        <div class="dashboard-box">
                            <h3 class="title is-5 is-thin">Available Populations</h3>

                            <div class="box-content">

                                <div id="table"></div>

                                <script src="{{ url_for('static', filename='assets/vendor/js/gridjs.umd.js') }}"></script>

                                <style>

                              #table td {
                                vertical-align: middle !important;
                              }
                            </style>


                                <script>
  const tableDiv = document.getElementById('table');

  const updateUrl = (prev, query) => {
    return prev + (prev.indexOf('?') >= 0 ? '&' : '?') + new URLSearchParams(query).toString();
  };

  const editableCellAttributes = (data, row, col) => {
    if (row) {
      return {
        contentEditable: 'true',
        'data-element-id': row.cells[0].data,
        'data-column-id': col.id
      };
    } else {
      return {};
    }
  };

  new gridjs.Grid({
    columns: [
      { id: 'id', hidden: true },
      { id: 'name', name: 'Name', attributes: editableCellAttributes },
      { id: 'descr', name: 'Description' },
        {id: "size", name: 'Number of Agents'},
      {
        id: 'actions',
        name: 'Actions',
        sort: false,
        formatter: (cell, row) => {
          const id = row.cells[0].data;
          return gridjs.html(`
            <div style="display: flex; gap: 8px; justify-content: center;">
              <a href="/admin/population_details/${id}"
                 style="background-color: #28a745; color: white; padding: 5px 10px; border-radius: 4px; text-decoration: none; font-size: 0.85rem;">
                Details
              </a>
              </a>
               <a href="/admin/delete_population/${id}"
                 style="background-color: #dc3545; color: white; padding: 5px 10px; border-radius: 4px; text-decoration: none; font-size: 0.85rem;">
                Delete
              </a>
            </div>
          `);
        }
      },
    ],
    server: {
      url: '/admin/populations_data',
      then: results => results.data,
      total: results => results.total,
    },
    search: {
      enabled: true,
      server: {
        url: (prev, search) => {
          return updateUrl(prev, { search });
        },
      },
    },
    sort: {
      enabled: true,
      multiColumn: true,
      server: {
        url: (prev, columns) => {
          const columnIds = ['id', 'name', 'descr', 'size'];
          const sort = columns.map(col => (col.direction === 1 ? '+' : '-') + columnIds[col.index]);
          return updateUrl(prev, { sort });
        },
      },
    },
    pagination: {
      enabled: true,
      server: {
        url: (prev, page, limit) => {
          return updateUrl(prev, { start: page * limit, length: limit });
        },
      },
    },
  }).render(tableDiv);

  let savedValue;

  // Handle inline edits
  tableDiv.addEventListener('focusin', ev => {
    if (ev.target.tagName === 'TD') {
      savedValue = ev.target.textContent;
    }
  });

  tableDiv.addEventListener('focusout', ev => {
    if (ev.target.tagName === 'TD') {
      if (savedValue !== ev.target.textContent) {
        fetch('/admin/populations_data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id: ev.target.dataset.elementId,
            [ev.target.dataset.columnId]: ev.target.textContent
          }),
        });
      }
      savedValue = undefined;
    }
  });

  tableDiv.addEventListener('keydown', ev => {
    if (ev.target.tagName === 'TD') {
      if (ev.key === 'Escape') {
        ev.target.textContent = savedValue;
        ev.target.blur();
      } else if (ev.key === 'Enter') {
        ev.preventDefault();
        ev.target.blur();
      }
    }
  });

  // Handle delete button clicks
  tableDiv.addEventListener('click', function (event) {
    const target = event.target;
    if (target.classList.contains('delete-button')) {
      const id = target.getAttribute('data-id');
      if (confirm('Are you sure you want to delete this population?')) {
        fetch(`/admin/delete_population/${id}`, {
          method: 'DELETE',
        })
        .then(response => {
          if (!response.ok) throw new Error('Failed to delete');
          location.reload(); // Refresh the table
        })
        .catch(err => {
          alert('Error deleting population.');
          console.error(err);
        });
      }
    }
  });
</script>



                            </div>
                        </div>
                    </div>
                </div>

                <div class="columns">
                    <!--Dashboard column-->
                    <div class="column is-8">

                        {% for message in get_flashed_messages() %}
                        <div class="alert alert-warning">
                            <button type="button" class="close" data-dismiss="alert">&times;</button>
                            {{ message }}
                        </div>
                        {% endfor %}

                        <!--Dashboard box-->
                        <div class="dashboard-box">
                        <h3 class="title is-5 is-thin">Load Population from file</h3>
                        <div class="box-content">
                            <form action="/admin/upload_population" enctype="multipart/form-data" method="POST">
                                <div class="box-lines">

                                    <div class="box-line">
                                        <span class="left">File (json)</span>
                                        <span class="right"><input type="file" id="population_file" name="population_file"
                                                                   class="input_file"></span>
                                    </div>
                                </div>
                                <div class="button-wrap">
                                    <button class="button is-solid primary-button is-fullwidth">
                                        Upload
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>


                        <div class="dashboard-box">
                            <h3 class="title is-5 is-thin">Create Empty Population</h3>
                            <div class="box-content">
                                <form action="/admin/create_population_empty" enctype="multipart/form-data" method="POST">
                                <div class="box-lines">

                                    <div class="box-line">
                                        <span class="left">Population Name</span>
                                        <span class="right" style="width: 70%;"><input type="text" name="empty_population_name"  class="input"></span>
                                    </div>
                                    <div class="box-line">
                                        <span class="left">Description</span>
                                        <span class="right" style="width: 70%;"><input type="text" name="empty_population_descr" class="input"></span>
                                    </div>
                                </div>
                                <div class="button-wrap">
                                    <button class="button is-solid primary-button is-fullwidth">
                                        Create
                                    </button>
                                </div>
                                </form>
                            </div>
                        </div>

                        <div class="dashboard-box">
                            <h3 class="title is-5 is-thin">Create Synthetic Population</h3>
                            <div class="box-content">
                                <form action="/admin/create_population" id="popcreate_form" enctype="multipart/form-data" method="POST">
                                <div class="box-lines">

                                    <style>
                                        .form-section-header {
                                            font-size: 0.95em;
                                            font-weight: 600;
                                            color: #333;
                                            margin: 20px 0 8px 0;
                                            padding-bottom: 5px;
                                            border-bottom: 1px solid #e0e0e0;
                                        }
                                        .form-section-description {
                                            font-size: 0.85em;
                                            color: #666;
                                            margin-bottom: 15px;
                                            line-height: 1.4;
                                        }
                                        .multi-select-wrapper {
                                            position: relative;
                                        }
                                        .multi-select-display {
                                            min-height: 38px;
                                            padding: 6px 10px;
                                            border: 1px solid #ddd;
                                            border-radius: 4px;
                                            background: white;
                                            cursor: pointer;
                                            display: flex;
                                            flex-wrap: wrap;
                                            gap: 5px;
                                            align-items: center;
                                        }
                                        .multi-select-display:hover {
                                            border-color: #22c55e;
                                        }
                                        .multi-select-tag {
                                            background: #22c55e;
                                            color: white;
                                            padding: 3px 8px;
                                            border-radius: 3px;
                                            font-size: 0.85em;
                                            display: inline-flex;
                                            align-items: center;
                                            gap: 5px;
                                        }
                                        .multi-select-tag-remove {
                                            cursor: pointer;
                                            font-weight: bold;
                                        }
                                        .multi-select-placeholder {
                                            color: #999;
                                            font-size: 0.9em;
                                        }
                                        .multi-select-dropdown {
                                            position: absolute;
                                            top: 100%;
                                            left: 0;
                                            right: 0;
                                            max-height: 200px;
                                            overflow-y: auto;
                                            background: white;
                                            border: 1px solid #ddd;
                                            border-radius: 4px;
                                            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                                            z-index: 1000;
                                            display: none;
                                            margin-top: 2px;
                                        }
                                        .multi-select-dropdown.active {
                                            display: block;
                                        }
                                        .multi-select-option {
                                            padding: 8px 12px;
                                            cursor: pointer;
                                            font-size: 0.9em;
                                            transition: background 0.15s;
                                        }
                                        .multi-select-option:hover {
                                            background: #f0f0f0;
                                        }
                                        .multi-select-option.selected {
                                            background: #e8f5e9;
                                            color: #22c55e;
                                            font-weight: 500;
                                        }
                                    </style>

                                    <div class="form-section-header">Basic Information</div>
                                    <div class="form-section-description">
                                        Define the population name, description, and size. These settings identify the population and determine the number of synthetic agents to generate.
                                    </div>

                                    <div class="box-line">
                                        <span class="left">Population Name</span>
                                        <span class="right" style="width: 70%;"><input type="text" name="pop_name"  class="input"></span>
                                    </div>
                                    <div class="box-line">
                                        <span class="left">Description</span>
                                        <span class="right" style="width: 70%;"><input type="text" name="pop_descr" class="input"></span>
                                    </div>
                                    <div class="box-line">
                                        <span class="left">Population Size</span>
                                        <div class="slider-timeline">
                                            <input name="n_agents" type="text" value="100" class="input">
                                        </div>
                                    </div>

                                    <div class="form-section-header">Recommendation Systems</div>
                                    <div class="form-section-description">
                                        Select the recommendation algorithms for content and friendship suggestions that will influence agent interactions.
                                    </div>

                                    <div class="box-line">
                                        <span class="left">Content RecSys</span>
                                        <div class="select">
                                            <select name="recsys_type">
                                                {% for recsys in crecsys %}
                                                <option value="{{ recsys.name }}">{{ recsys.value }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="box-line">
                                        <span class="left">Friendship RecSys</span>
                                        <div class="select">
                                            <select name="frecsys_type">
                                                {% for recsys in frecsys %}
                                                <option value="{{ recsys.name }}">{{ recsys.value }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>

                                    <div class="form-section-header">Demographics</div>
                                    <div class="form-section-description">
                                        Configure demographic attributes including age range, nationality, and language to define the population's basic characteristics.
                                    </div>

                                    <div class="box-line">
                                        <span class="left">Age Range</span>
                                        <div class="slider-timeline">
                                        <input name="age_min" type="range" value="18" min="1" max="100" oninput="this.nextElementSibling.value = this.value">
                                        <output>18</output>
                                            <input name="age_max" type="range" value="60" min="1" max="100" oninput="this.nextElementSibling.value = this.value">
                                        <output>60</output>
                                        </div>
                                    </div>

                                    <div class="box-line">
                                        <span class="left">Nationalities</span>
                                        <span class="right" style="width: 70%;">
                                            <div class="select">
                                            <select name="nationalities">
                                                {% for nationality in nationalities %}
                                                <option value="{{ nationality.nationality }}">{{ nationality.nationality }}</option>
                                                {% endfor %}
                                            </select>
                                            </div>
                                        </span>
                                    </div>
                                     <div class="box-line">
                                        <span class="left">Spoken Language</span>
                                        <span class="right" style="width: 70%;">
                                            <div class="select">
                                            <select name="languages">
                                                {% for lang in languages %}
                                                <option value="{{ lang.language }}">{{ lang.language }}</option>
                                                {% endfor %}
                                            </select>
                                            </div>
                                        </span>
                                    </div>

                                    <div class="form-section-header">Social Attributes</div>
                                    <div class="form-section-description">
                                        Select diverse values for education, political leanings, and toxicity levels to create a varied and realistic population. Click to select multiple options.
                                    </div>

                                    <div class="box-line">
                                        <span class="left">Education Levels</span>
                                        <span class="right" style="width: 70%;">
                                            <div class="multi-select-wrapper">
                                                <div class="multi-select-display" onclick="toggleDropdown('education_levels')">
                                                    <span id="education_levels_display" class="multi-select-placeholder">Click to select education levels...</span>
                                                </div>
                                                <div class="multi-select-dropdown" id="education_levels_dropdown">
                                                    {% for education_level in education_levels %}
                                                    <div class="multi-select-option" onclick="toggleOption('education_levels', '{{ education_level.education_level }}')">
                                                        {{ education_level.education_level }}
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </span>
                                    </div>
                                    <div class="box-line">
                                        <span class="left">Political Leanings</span>
                                        <span class="right" style="width: 70%;">
                                            <div class="multi-select-wrapper">
                                                <div class="multi-select-display" onclick="toggleDropdown('political_leanings')">
                                                    <span id="political_leanings_display" class="multi-select-placeholder">Click to select political leanings...</span>
                                                </div>
                                                <div class="multi-select-dropdown" id="political_leanings_dropdown">
                                                    {% for political_leaning in leanings %}
                                                    <div class="multi-select-option" onclick="toggleOption('political_leanings', '{{ political_leaning.leaning }}')">
                                                        {{ political_leaning.leaning }}
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </span>
                                    </div>
                                    <div class="box-line">
                                        <span class="left">Toxicity Levels</span>
                                        <span class="right" style="width: 70%;">
                                            <div class="multi-select-wrapper">
                                                <div class="multi-select-display" onclick="toggleDropdown('toxicity_levels')">
                                                    <span id="toxicity_levels_display" class="multi-select-placeholder">Click to select toxicity levels...</span>
                                                </div>
                                                <div class="multi-select-dropdown" id="toxicity_levels_dropdown">
                                                    {% for toxicity_level in toxicity_levels %}
                                                    <div class="multi-select-option" onclick="toggleOption('toxicity_levels', '{{ toxicity_level.toxicity_level }}')">
                                                        {{ toxicity_level.toxicity_level }}
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </span>
                                    </div>

                                    <script>
                                        // Multi-select functionality
                                        const multiSelectData = {
                                            education_levels: [],
                                            political_leanings: [],
                                            toxicity_levels: []
                                        };

                                        function toggleDropdown(fieldName) {
                                            const dropdown = document.getElementById(fieldName + '_dropdown');
                                            dropdown.classList.toggle('active');
                                            
                                            // Close other dropdowns
                                            document.querySelectorAll('.multi-select-dropdown').forEach(dd => {
                                                if (dd.id !== fieldName + '_dropdown') {
                                                    dd.classList.remove('active');
                                                }
                                            });
                                        }

                                        function toggleOption(fieldName, value) {
                                            const data = multiSelectData[fieldName];
                                            const index = data.indexOf(value);
                                            
                                            if (index > -1) {
                                                data.splice(index, 1);
                                            } else {
                                                data.push(value);
                                            }
                                            
                                            updateDisplay(fieldName);
                                            updateOptionStyles(fieldName);
                                        }

                                        function removeTag(fieldName, value) {
                                            const data = multiSelectData[fieldName];
                                            const index = data.indexOf(value);
                                            if (index > -1) {
                                                data.splice(index, 1);
                                            }
                                            updateDisplay(fieldName);
                                            updateOptionStyles(fieldName);
                                        }

                                        function updateDisplay(fieldName) {
                                            const display = document.getElementById(fieldName + '_display');
                                            const data = multiSelectData[fieldName];
                                            
                                            if (data.length === 0) {
                                                display.innerHTML = '<span class="multi-select-placeholder">Click to select...</span>';
                                            } else {
                                                display.innerHTML = data.map(value => 
                                                    `<span class="multi-select-tag">
                                                        ${value}
                                                        <span class="multi-select-tag-remove" onclick="event.stopPropagation(); removeTag('${fieldName}', '${value}')">×</span>
                                                    </span>`
                                                ).join('');
                                            }
                                        }

                                        function updateOptionStyles(fieldName) {
                                            const dropdown = document.getElementById(fieldName + '_dropdown');
                                            const data = multiSelectData[fieldName];
                                            
                                            dropdown.querySelectorAll('.multi-select-option').forEach(option => {
                                                const value = option.textContent.trim();
                                                if (data.includes(value)) {
                                                    option.classList.add('selected');
                                                } else {
                                                    option.classList.remove('selected');
                                                }
                                            });
                                        }

                                        // Close dropdowns when clicking outside
                                        document.addEventListener('click', function(e) {
                                            if (!e.target.closest('.multi-select-wrapper')) {
                                                document.querySelectorAll('.multi-select-dropdown').forEach(dd => {
                                                    dd.classList.remove('active');
                                                });
                                            }
                                        });

                                        // Add hidden inputs before form submission
                                        document.getElementById('popcreate_form').addEventListener('submit', function(e) {
                                            // Remove old hidden inputs
                                            this.querySelectorAll('input[name="education_levels"], input[name="political_leanings"], input[name="toxicity_levels"]').forEach(input => input.remove());
                                            
                                            // Add new hidden inputs for multi-select values
                                            Object.keys(multiSelectData).forEach(fieldName => {
                                                multiSelectData[fieldName].forEach(value => {
                                                    const input = document.createElement('input');
                                                    input.type = 'hidden';
                                                    input.name = fieldName;
                                                    input.value = value;
                                                    this.appendChild(input);
                                                });
                                            });
                                        });
                                    </script>

                                    <div class="form-section-header" style="cursor: pointer; user-select: none;" onclick="toggleActivityProfiles()">
                                        <span id="activity-profiles-toggle">▼</span> Activity Profiles <span style="font-size: 0.85em; font-weight: normal; color: #999;">(Optional - Click to expand)</span>
                                    </div>
                                    <div class="form-section-description">
                                        Assign activity profiles to define when agents are active during the day. Drag profiles from the available list to assign them, then specify the percentage of agents for each profile. Total must equal 100%.
                                    </div>

                                    <style>
                                        .activity-profiles-section {
                                            max-height: 0;
                                            overflow: hidden;
                                            transition: max-height 0.3s ease-out;
                                        }
                                        .activity-profiles-section.expanded {
                                            max-height: 800px;
                                            transition: max-height 0.5s ease-in;
                                        }
                                        .activity-profiles-compact {
                                            display: flex;
                                            flex-direction: column;
                                            gap: 15px;
                                            margin-bottom: 20px;
                                        }
                                        .profiles-section {
                                            border: 1px solid #e0e0e0;
                                            border-radius: 6px;
                                            padding: 12px;
                                            background-color: #fafafa;
                                        }
                                        .profiles-section-title {
                                            font-size: 0.9em;
                                            font-weight: 600;
                                            color: #555;
                                            margin-bottom: 10px;
                                        }
                                        .profile-item-compact {
                                            background: white;
                                            border: 1px solid #ddd;
                                            border-radius: 4px;
                                            padding: 6px 10px;
                                            margin-bottom: 6px;
                                            cursor: move;
                                            transition: all 0.2s ease;
                                            display: flex;
                                            justify-content: space-between;
                                            align-items: center;
                                            font-size: 0.85em;
                                        }
                                        .profile-item-compact:hover {
                                            border-color: #22c55e;
                                            box-shadow: 0 1px 3px rgba(34, 197, 94, 0.2);
                                        }
                                        .profile-item-compact.dragging {
                                            opacity: 0.5;
                                        }
                                        .profile-name-compact {
                                            font-weight: 500;
                                        }
                                        .assigned-profile-compact {
                                            background: white;
                                            border: 1px solid #22c55e;
                                            border-radius: 4px;
                                            padding: 8px 10px;
                                            margin-bottom: 8px;
                                            display: flex;
                                            align-items: center;
                                            gap: 8px;
                                            font-size: 0.85em;
                                        }
                                        .assigned-profile-name-compact {
                                            flex: 1;
                                            font-weight: 500;
                                            color: #333;
                                        }
                                        .percentage-input-compact {
                                            width: 60px;
                                            padding: 4px 6px;
                                            border: 1px solid #ddd;
                                            border-radius: 3px;
                                            text-align: center;
                                            font-size: 0.85em;
                                        }
                                        .remove-profile-btn-compact {
                                            background: #dc3545;
                                            color: white;
                                            border: none;
                                            border-radius: 3px;
                                            padding: 3px 8px;
                                            cursor: pointer;
                                            font-size: 0.75em;
                                            transition: background 0.2s;
                                        }
                                        .remove-profile-btn-compact:hover {
                                            background: #c82333;
                                        }
                                        .drag-over-compact {
                                            background-color: #e8f5e9;
                                            border-color: #22c55e;
                                        }
                                        .percentage-validation-compact {
                                            margin-top: 8px;
                                            padding: 8px;
                                            border-radius: 4px;
                                            font-size: 0.8em;
                                        }
                                        .percentage-validation-compact.error {
                                            background: #fee;
                                            border: 1px solid #fcc;
                                            color: #c00;
                                        }
                                        .percentage-validation-compact.success {
                                            background: #efe;
                                            border: 1px solid #cfc;
                                            color: #0a0;
                                        }
                                        .empty-state-compact {
                                            text-align: center;
                                            color: #999;
                                            font-size: 0.8em;
                                            padding: 15px;
                                        }
                                    </style>

                                    <div class="activity-profiles-section" id="activity-profiles-section">
                                        <div class="activity-profiles-compact">
                                            <div class="profiles-section">
                                                <div class="profiles-section-title">Available Profiles (Drag to assign)</div>
                                                <div id="available-profiles">
                                                    {% if activity_profiles %}
                                                        {% for profile in activity_profiles %}
                                                        <div class="profile-item-compact" draggable="true" data-profile-id="{{ profile.id }}" data-profile-name="{{ profile.name }}" data-profile-hours="{{ profile.hours }}">
                                                            <div class="profile-name-compact">{{ profile.name }}</div>
                                                            <span style="color: #999; font-size: 0.9em;">⋮⋮</span>
                                                        </div>
                                                        {% endfor %}
                                                    {% else %}
                                                        <div class="empty-state-compact">No activity profiles available. Create some in the Miscellanea page first.</div>
                                                    {% endif %}
                                                </div>
                                            </div>

                                            <div class="profiles-section">
                                                <div class="profiles-section-title">Assigned Profiles & Percentages</div>
                                                <div id="assigned-profiles">
                                                    <div class="empty-state-compact">Drag profiles here to assign them</div>
                                                </div>
                                                <div id="percentage-validation" class="percentage-validation-compact" style="display: none;"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <input type="hidden" name="activity_profiles_data" id="activity_profiles_data" value="">

                                    <script>
                                        // Toggle activity profiles section
                                        function toggleActivityProfiles() {
                                            const section = document.getElementById('activity-profiles-section');
                                            const toggle = document.getElementById('activity-profiles-toggle');
                                            section.classList.toggle('expanded');
                                            toggle.textContent = section.classList.contains('expanded') ? '▲' : '▼';
                                        }

                                        // Drag and drop functionality for activity profiles
                                        let assignedProfiles = [];

                                        function initDragAndDrop() {
                                            const availableContainer = document.getElementById('available-profiles');
                                            const assignedContainer = document.getElementById('assigned-profiles');

                                            // Make profile items draggable
                                            document.querySelectorAll('.profile-item-compact').forEach(item => {
                                                item.addEventListener('dragstart', handleDragStart);
                                                item.addEventListener('dragend', handleDragEnd);
                                            });

                                            // Make assigned profiles area droppable
                                            assignedContainer.addEventListener('dragover', handleDragOver);
                                            assignedContainer.addEventListener('drop', handleDrop);
                                            assignedContainer.addEventListener('dragleave', handleDragLeave);
                                        }

                                        function handleDragStart(e) {
                                            e.currentTarget.classList.add('dragging');
                                            e.dataTransfer.effectAllowed = 'copy';
                                            e.dataTransfer.setData('text/plain', JSON.stringify({
                                                id: e.currentTarget.dataset.profileId,
                                                name: e.currentTarget.dataset.profileName,
                                                hours: e.currentTarget.dataset.profileHours
                                            }));
                                        }

                                        function handleDragEnd(e) {
                                            e.currentTarget.classList.remove('dragging');
                                        }

                                        function handleDragOver(e) {
                                            e.preventDefault();
                                            e.dataTransfer.dropEffect = 'copy';
                                            e.currentTarget.classList.add('drag-over-compact');
                                        }

                                        function handleDragLeave(e) {
                                            if (e.currentTarget === e.target) {
                                                e.currentTarget.classList.remove('drag-over-compact');
                                            }
                                        }

                                        function handleDrop(e) {
                                            e.preventDefault();
                                            e.currentTarget.classList.remove('drag-over-compact');
                                            
                                            const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                                            
                                            // Check if profile is already assigned
                                            if (assignedProfiles.find(p => p.id === data.id)) {
                                                return; // Already assigned
                                            }

                                            // Add to assigned profiles
                                            assignedProfiles.push({
                                                id: data.id,
                                                name: data.name,
                                                hours: data.hours,
                                                percentage: 0
                                            });

                                            renderAssignedProfiles();
                                            validatePercentages();
                                        }

                                        function renderAssignedProfiles() {
                                            const container = document.getElementById('assigned-profiles');
                                            
                                            if (assignedProfiles.length === 0) {
                                                container.innerHTML = '<div class="empty-state-compact">Drag profiles here to assign them</div>';
                                                return;
                                            }

                                            container.innerHTML = assignedProfiles.map(profile => `
                                                <div class="assigned-profile-compact">
                                                    <div class="assigned-profile-name-compact">${profile.name}</div>
                                                    <input type="number" 
                                                           class="percentage-input-compact" 
                                                           min="0" 
                                                           max="100" 
                                                           step="0.01"
                                                           placeholder="%" 
                                                           value="${profile.percentage || ''}"
                                                           onchange="updatePercentage('${profile.id}', this.value)">
                                                    <span style="font-size: 0.85em; color: #666;">%</span>
                                                    <button type="button" class="remove-profile-btn-compact" onclick="removeProfile('${profile.id}')">×</button>
                                                </div>
                                            `).join('');
                                        }

                                        function updatePercentage(profileId, percentage) {
                                            const profile = assignedProfiles.find(p => p.id === profileId);
                                            if (profile) {
                                                profile.percentage = parseFloat(percentage) || 0;
                                                validatePercentages();
                                                updateHiddenField();
                                            }
                                        }

                                        function removeProfile(profileId) {
                                            assignedProfiles = assignedProfiles.filter(p => p.id !== profileId);
                                            renderAssignedProfiles();
                                            validatePercentages();
                                            updateHiddenField();
                                        }

                                        function validatePercentages() {
                                            const validation = document.getElementById('percentage-validation');
                                            const total = assignedProfiles.reduce((sum, p) => sum + (p.percentage || 0), 0);
                                            
                                            if (assignedProfiles.length === 0) {
                                                validation.style.display = 'none';
                                                return true;
                                            }

                                            validation.style.display = 'block';
                                            
                                            if (Math.abs(total - 100) < 0.01) {
                                                validation.className = 'percentage-validation-compact success';
                                                validation.textContent = `✓ Total: ${total.toFixed(2)}% - Perfect!`;
                                                return true;
                                            } else {
                                                validation.className = 'percentage-validation-compact error';
                                                validation.textContent = `⚠ Total: ${total.toFixed(2)}% - Must equal 100%`;
                                                return false;
                                            }
                                        }

                                        function updateHiddenField() {
                                            const data = assignedProfiles.map(p => ({
                                                id: p.id,
                                                name: p.name,
                                                percentage: p.percentage || 0
                                            }));
                                            document.getElementById('activity_profiles_data').value = JSON.stringify(data);
                                        }

                                        // Initialize on page load
                                        document.addEventListener('DOMContentLoaded', function() {
                                            initDragAndDrop();
                                        });

                                        // Form validation before submit
                                        document.getElementById('popcreate_form').addEventListener('submit', function(e) {
                                            if (assignedProfiles.length > 0 && !validatePercentages()) {
                                                e.preventDefault();
                                                alert('Please ensure that the total percentage of assigned activity profiles equals 100%');
                                                return false;
                                            }
                                        });
                                    </script>

                                </div>
                                <div class="button-wrap">
                                    <button class="button is-solid primary-button is-fullwidth">
                                        Create
                                    </button>
                                </div>
                                </form>
                            </div>
                        </div>


                        <!--Dashboard box-->

                    </div>


                    <!--Dashboard column-->
                    <div class="column is-4">
                        <!--Box-->
                        <div class="dashboard-box is-compact">
                            <h3 class="title is-5 is-thin">Guide</h3>
                            <div class="help-block">

                                <p>
                                    <b>What is a Population?</b>
                                    A population is a group of agents/pages that are used in a simulation.
                                    Each simulation can have multiple populations.
                                </p>
                                <br>
                                    <p>
                                        <b>Empty Populations</b>
                                         are used to create populations from scratch.
                                        Once created, you can add agents to the them.
                                </p>
                                <br>
                                <p>
                                    <b>Synthetic Populations</b>
                                     are created using a a predefined set of parameters.
                                    Leveraging the parameters provided as input, agents are generated and added to the population.
                                </p>
                                <br>
                                <p>
                                    <b>LLM</b>
                                    Although for synthetic populations it is specified an LLM to simulate its agents it is always possible to add agents served by other LLMs.
                                </p>
                            </div>
                        </div>


                    </div>
                </div>
            </div>
        </div>

    </div>



{% include "admin/footer.html" %}