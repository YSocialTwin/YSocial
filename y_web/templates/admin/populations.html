{% include "admin/head.html" %}

 <div class="view-wrapper is-dashboard">
        <!--Dashboard container-->
        <div id="creator-dashboard" class="dashboard-container">
            <!--Toolbar-->
            {% include "admin/dash_head.html" %}

            <div class="dashboard-body">
                <div class="columns">
                    <div class="column is-12">
                        <div class="dashboard-box">
                            <h3 class="title is-5 is-thin">Available Populations</h3>

                            <div class="box-content">

                                <div id="table" class="gridjs-table-vertical-middle"></div>

                                <script src="{{ url_for('static', filename='assets/vendor/js/gridjs.umd.js') }}"></script>


                                <script>
  const tableDiv = document.getElementById('table');

  const updateUrl = (prev, query) => {
    return prev + (prev.indexOf('?') >= 0 ? '&' : '?') + new URLSearchParams(query).toString();
  };

  const editableCellAttributes = (data, row, col) => {
    if (row) {
      return {
        contentEditable: 'true',
        'data-element-id': row.cells[0].data,
        'data-column-id': col.id
      };
    } else {
      return {};
    }
  };

  new gridjs.Grid({
    columns: [
      { id: 'id', hidden: true },
      { id: 'name', name: 'Name', attributes: editableCellAttributes },
      { id: 'descr', name: 'Description' },
        {id: "size", name: 'Number of Agents'},
      {
        id: 'actions',
        name: 'Actions',
        sort: false,
        formatter: (cell, row) => {
          const id = row.cells[0].data;
          return gridjs.html(`
            <div class="action-button-group">
              <a href="/admin/population_details/${id}" class="action-button-green-small">
                Details
              </a>
              </a>
               <a href="/admin/delete_population/${id}" class="action-button-red-small">
                Delete
              </a>
            </div>
          `);
        }
      },
    ],
    server: {
      url: '/admin/populations_data',
      then: results => results.data,
      total: results => results.total,
    },
    search: {
      enabled: true,
      server: {
        url: (prev, search) => {
          return updateUrl(prev, { search });
        },
      },
    },
    sort: {
      enabled: true,
      multiColumn: true,
      server: {
        url: (prev, columns) => {
          const columnIds = ['id', 'name', 'descr', 'size'];
          const sort = columns.map(col => (col.direction === 1 ? '+' : '-') + columnIds[col.index]);
          return updateUrl(prev, { sort });
        },
      },
    },
    pagination: {
      enabled: true,
      server: {
        url: (prev, page, limit) => {
          return updateUrl(prev, { start: page * limit, length: limit });
        },
      },
    },
  }).render(tableDiv);

  let savedValue;

  // Handle inline edits
  tableDiv.addEventListener('focusin', ev => {
    if (ev.target.tagName === 'TD') {
      savedValue = ev.target.textContent;
    }
  });

  tableDiv.addEventListener('focusout', ev => {
    if (ev.target.tagName === 'TD') {
      if (savedValue !== ev.target.textContent) {
        fetch('/admin/populations_data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id: ev.target.dataset.elementId,
            [ev.target.dataset.columnId]: ev.target.textContent
          }),
        });
      }
      savedValue = undefined;
    }
  });

  tableDiv.addEventListener('keydown', ev => {
    if (ev.target.tagName === 'TD') {
      if (ev.key === 'Escape') {
        ev.target.textContent = savedValue;
        ev.target.blur();
      } else if (ev.key === 'Enter') {
        ev.preventDefault();
        ev.target.blur();
      }
    }
  });

  // Handle delete button clicks
  tableDiv.addEventListener('click', function (event) {
    const target = event.target;
    if (target.classList.contains('delete-button')) {
      const id = target.getAttribute('data-id');
      if (confirm('Are you sure you want to delete this population?')) {
        fetch(`/admin/delete_population/${id}`, {
          method: 'DELETE',
        })
        .then(response => {
          if (!response.ok) throw new Error('Failed to delete');
          location.reload(); // Refresh the table
        })
        .catch(err => {
          alert('Error deleting population.');
          console.error(err);
        });
      }
    }
  });
</script>



                            </div>
                        </div>
                    </div>
                </div>

                <div class="columns">
                    <!--Dashboard column-->
                    <div class="column is-8">

                        {% for message in get_flashed_messages() %}
                        <div class="alert alert-warning">
                            <button type="button" class="close" data-dismiss="alert">&times;</button>
                            {{ message }}
                        </div>
                        {% endfor %}

                        <!--Dashboard box-->
                        <div class="dashboard-box">
                        <h3 class="title is-5 is-thin">Load Population from file</h3>
                        <div class="box-content">
                            <form action="/admin/upload_population" enctype="multipart/form-data" method="POST">
                                <div class="box-lines">

                                    <div class="box-line">
                                        <span class="left">File (json)</span>
                                        <span class="right"><input type="file" id="population_file" name="population_file"
                                                                   class="input_file"></span>
                                    </div>
                                </div>
                                <div class="button-wrap">
                                    <button class="button is-solid primary-button is-fullwidth">
                                        Upload
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>


                        <div class="dashboard-box">
                            <h3 class="title is-5 is-thin">Create Empty Population</h3>
                            <div class="box-content">
                                <form action="/admin/create_population_empty" enctype="multipart/form-data" method="POST">
                                <div class="box-lines">

                                    <div class="box-line">
                                        <span class="left">Population Name</span>
                                        <span class="right" class="form-input-wide"><input type="text" name="empty_population_name"  class="input"></span>
                                    </div>
                                    <div class="box-line">
                                        <span class="left">Description</span>
                                        <span class="right" class="form-input-wide"><input type="text" name="empty_population_descr" class="input"></span>
                                    </div>
                                </div>
                                <div class="button-wrap">
                                    <button class="button is-solid primary-button is-fullwidth">
                                        Create
                                    </button>
                                </div>
                                </form>
                            </div>
                        </div>

                        <div class="dashboard-box">
                            <h3 class="title is-5 is-thin">Create Synthetic Population</h3>
                            <div class="box-content">
                                <form action="/admin/create_population" id="popcreate_form" enctype="multipart/form-data" method="POST">
                                <div class="box-lines">

                                    <div class="form-section-header">Basic Information</div>
                                    <div class="form-section-description">
                                        Define the population name, description, and size. These settings identify the population and determine the number of synthetic agents to generate.
                                    </div>

                                    <div class="box-line">
                                        <span class="left">Population Name</span>
                                        <span class="right form-input-wide"><input type="text" name="pop_name"  class="input"></span>
                                    </div>
                                    <div class="box-line">
                                        <span class="left">Description</span>
                                        <span class="right form-input-wide"><input type="text" name="pop_descr" class="input"></span>
                                    </div>
                                    <div class="box-line">
                                        <span class="left">Population Size</span>
                                        <div class="slider-timeline">
                                            <input name="n_agents" type="text" value="100" class="input">
                                        </div>
                                    </div>

                                    <div class="form-section-header">Recommendation Systems</div>
                                    <div class="form-section-description">
                                        Select the recommendation algorithms for content and friendship suggestions that will influence agent interactions.
                                    </div>

                                    <div class="box-line">
                                        <span class="left">Content RecSys</span>
                                        <div class="select">
                                            <select name="recsys_type">
                                                {% for recsys in crecsys %}
                                                <option value="{{ recsys.name }}">{{ recsys.value }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="box-line">
                                        <span class="left">Friendship RecSys</span>
                                        <div class="select">
                                            <select name="frecsys_type">
                                                {% for recsys in frecsys %}
                                                <option value="{{ recsys.name }}">{{ recsys.value }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>

                                    <div class="form-section-header">Demographics</div>
                                    <div class="form-section-description">
                                        Configure demographic attributes including age range, nationality, and language to define the population's basic characteristics.
                                    </div>

                                    <div class="box-line">
                                        <span class="left">Age Range</span>
                                        <div class="slider-timeline">
                                        <input name="age_min" type="range" value="18" min="1" max="100" oninput="this.nextElementSibling.value = this.value">
                                        <output>18</output>
                                            <input name="age_max" type="range" value="60" min="1" max="100" oninput="this.nextElementSibling.value = this.value">
                                        <output>60</output>
                                        </div>
                                    </div>

                                    <div class="box-line">
                                        <span class="left">Nationalities</span>

                                            <div class="select">
                                            <select name="nationalities">
                                                {% for nationality in nationalities %}
                                                <option value="{{ nationality.nationality }}">{{ nationality.nationality }}</option>
                                                {% endfor %}
                                            </select>
                                            </div>
                                        </span>
                                    </div>
                                     <div class="box-line">
                                        <span class="left">Spoken Language</span>

                                            <div class="select">
                                            <select name="languages">
                                                {% for lang in languages %}
                                                <option value="{{ lang.language }}">{{ lang.language }}</option>
                                                {% endfor %}
                                            </select>
                                            </div>
                                        </span>
                                    </div>

                                    <div class="form-section-header">Social Attributes</div>
                                    <div class="form-section-description">
                                        Select diverse values for education, political leanings, and toxicity levels to create a varied and realistic population. Click to select multiple options.
                                    </div>

                                    <div class="box-line">
                                        <span class="left">Education Levels</span>
                                        <span class="right" class="form-input-wide">
                                            <div class="multi-select-wrapper">
                                                <div class="multi-select-display" onclick="toggleDropdown('education_levels')">
                                                    <span id="education_levels_display" class="multi-select-placeholder">Click to select education levels...</span>
                                                </div>
                                                <div class="multi-select-dropdown" id="education_levels_dropdown">
                                                    {% for education_level in education_levels %}
                                                    <div class="multi-select-option" onclick="toggleOption('education_levels', '{{ education_level.education_level }}')">
                                                        {{ education_level.education_level }}
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </span>
                                    </div>
                                    <div class="box-line">
                                        <span class="left">Political Leanings</span>
                                        <span class="right" class="form-input-wide">
                                            <div class="multi-select-wrapper">
                                                <div class="multi-select-display" onclick="toggleDropdown('political_leanings')">
                                                    <span id="political_leanings_display" class="multi-select-placeholder">Click to select political leanings...</span>
                                                </div>
                                                <div class="multi-select-dropdown" id="political_leanings_dropdown">
                                                    {% for political_leaning in leanings %}
                                                    <div class="multi-select-option" onclick="toggleOption('political_leanings', '{{ political_leaning.leaning }}')">
                                                        {{ political_leaning.leaning }}
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </span>
                                    </div>
                                    <div class="box-line">
                                        <span class="left">Toxicity Levels</span>
                                        <span class="right" class="form-input-wide">
                                            <div class="multi-select-wrapper">
                                                <div class="multi-select-display" onclick="toggleDropdown('toxicity_levels')">
                                                    <span id="toxicity_levels_display" class="multi-select-placeholder">Click to select toxicity levels...</span>
                                                </div>
                                                <div class="multi-select-dropdown" id="toxicity_levels_dropdown">
                                                    {% for toxicity_level in toxicity_levels %}
                                                    <div class="multi-select-option" onclick="toggleOption('toxicity_levels', '{{ toxicity_level.toxicity_level }}')">
                                                        {{ toxicity_level.toxicity_level }}
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </span>
                                    </div>

                                    <script>
                                        // Multi-select functionality
                                        const multiSelectData = {
                                            education_levels: [],
                                            political_leanings: [],
                                            toxicity_levels: []
                                        };

                                        function toggleDropdown(fieldName) {
                                            const dropdown = document.getElementById(fieldName + '_dropdown');
                                            dropdown.classList.toggle('active');
                                            
                                            // Close other dropdowns
                                            document.querySelectorAll('.multi-select-dropdown').forEach(dd => {
                                                if (dd.id !== fieldName + '_dropdown') {
                                                    dd.classList.remove('active');
                                                }
                                            });
                                        }

                                        function toggleOption(fieldName, value) {
                                            const data = multiSelectData[fieldName];
                                            const index = data.indexOf(value);
                                            
                                            if (index > -1) {
                                                data.splice(index, 1);
                                            } else {
                                                data.push(value);
                                            }
                                            
                                            updateDisplay(fieldName);
                                            updateOptionStyles(fieldName);
                                        }

                                        function removeTag(fieldName, value) {
                                            const data = multiSelectData[fieldName];
                                            const index = data.indexOf(value);
                                            if (index > -1) {
                                                data.splice(index, 1);
                                            }
                                            updateDisplay(fieldName);
                                            updateOptionStyles(fieldName);
                                        }

                                        function updateDisplay(fieldName) {
                                            const display = document.getElementById(fieldName + '_display');
                                            const data = multiSelectData[fieldName];
                                            
                                            if (data.length === 0) {
                                                display.innerHTML = '<span class="multi-select-placeholder">Click to select...</span>';
                                            } else {
                                                display.innerHTML = data.map(value => 
                                                    `<span class="multi-select-tag">
                                                        ${value}
                                                        <span class="multi-select-tag-remove" onclick="event.stopPropagation(); removeTag('${fieldName}', '${value}')">×</span>
                                                    </span>`
                                                ).join('');
                                            }
                                        }

                                        function updateOptionStyles(fieldName) {
                                            const dropdown = document.getElementById(fieldName + '_dropdown');
                                            const data = multiSelectData[fieldName];
                                            
                                            dropdown.querySelectorAll('.multi-select-option').forEach(option => {
                                                const value = option.textContent.trim();
                                                if (data.includes(value)) {
                                                    option.classList.add('selected');
                                                } else {
                                                    option.classList.remove('selected');
                                                }
                                            });
                                        }

                                        // Close dropdowns when clicking outside
                                        document.addEventListener('click', function(e) {
                                            if (!e.target.closest('.multi-select-wrapper')) {
                                                document.querySelectorAll('.multi-select-dropdown').forEach(dd => {
                                                    dd.classList.remove('active');
                                                });
                                            }
                                        });

                                        // Add hidden inputs before form submission
                                        document.getElementById('popcreate_form').addEventListener('submit', function(e) {
                                            // Remove old hidden inputs
                                            this.querySelectorAll('input[name="education_levels"], input[name="political_leanings"], input[name="toxicity_levels"]').forEach(input => input.remove());
                                            
                                            // Add new hidden inputs for multi-select values
                                            Object.keys(multiSelectData).forEach(fieldName => {
                                                multiSelectData[fieldName].forEach(value => {
                                                    const input = document.createElement('input');
                                                    input.type = 'hidden';
                                                    input.name = fieldName;
                                                    input.value = value;
                                                    this.appendChild(input);
                                                });
                                            });
                                        });
                                    </script>

                                    <div class="form-section-header" style="cursor: pointer; user-select: none;" onclick="toggleActivityProfiles()">
                                        <span id="activity-profiles-toggle">▼</span> Activity Profiles <span style="font-size: 0.85em; font-weight: normal; color: #999;">(Optional - Click to expand)</span>
                                    </div>
                                    <div class="form-section-description">
                                        Assign activity profiles to define when agents are active during the day. Drag profiles from the available list to assign them, then specify the percentage of agents for each profile. Total must equal 100%.
                                    </div>


                                    <div class="activity-profiles-section" id="activity-profiles-section">
                                        <div class="activity-profiles-compact">
                                            <div class="profiles-section">
                                                <div class="profiles-section-title">Available Profiles (Drag to assign)</div>
                                                <div id="available-profiles">
                                                    {% if activity_profiles %}
                                                        {% for profile in activity_profiles %}
                                                        <div class="profile-item-compact" draggable="true" data-profile-id="{{ profile.id }}" data-profile-name="{{ profile.name }}" data-profile-hours="{{ profile.hours }}">
                                                            <div class="profile-name-compact">{{ profile.name }}</div>
                                                            <div class="profile-heatmap-compact">
                                                                {% set hours_list = profile.hours.split(',') %}
                                                                {% for hour in range(24) %}
                                                                    <div class="heatmap-hour {% if hour|string in hours_list %}active{% endif %}"></div>
                                                                {% endfor %}
                                                            </div>
                                                            <span style="color: #999; font-size: 0.9em;">⋮⋮</span>
                                                        </div>
                                                        {% endfor %}
                                                    {% else %}
                                                        <div class="empty-state-compact">No activity profiles available. Create some in the Miscellanea page first.</div>
                                                    {% endif %}
                                                </div>
                                            </div>

                                            <div class="profiles-section">
                                                <div class="profiles-section-title">Assigned Profiles & Percentages</div>
                                                <div id="assigned-profiles">
                                                    <div class="empty-state-compact">Drag profiles here to assign them</div>
                                                </div>
                                                <div id="percentage-validation" class="percentage-validation-compact" style="display: none;"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <input type="hidden" name="activity_profiles_data" id="activity_profiles_data" value="">

                                    <script>
                                        // Toggle activity profiles section
                                        function toggleActivityProfiles() {
                                            const section = document.getElementById('activity-profiles-section');
                                            const toggle = document.getElementById('activity-profiles-toggle');
                                            section.classList.toggle('expanded');
                                            toggle.textContent = section.classList.contains('expanded') ? '▲' : '▼';
                                        }

                                        // Drag and drop functionality for activity profiles
                                        let assignedProfiles = [];

                                        function initDragAndDrop() {
                                            const availableContainer = document.getElementById('available-profiles');
                                            const assignedContainer = document.getElementById('assigned-profiles');

                                            // Make profile items draggable
                                            document.querySelectorAll('.profile-item-compact').forEach(item => {
                                                item.addEventListener('dragstart', handleDragStart);
                                                item.addEventListener('dragend', handleDragEnd);
                                            });

                                            // Make assigned profiles area droppable
                                            assignedContainer.addEventListener('dragover', handleDragOver);
                                            assignedContainer.addEventListener('drop', handleDrop);
                                            assignedContainer.addEventListener('dragleave', handleDragLeave);
                                        }

                                        function handleDragStart(e) {
                                            e.currentTarget.classList.add('dragging');
                                            e.dataTransfer.effectAllowed = 'copy';
                                            e.dataTransfer.setData('text/plain', JSON.stringify({
                                                id: e.currentTarget.dataset.profileId,
                                                name: e.currentTarget.dataset.profileName,
                                                hours: e.currentTarget.dataset.profileHours
                                            }));
                                        }

                                        function handleDragEnd(e) {
                                            e.currentTarget.classList.remove('dragging');
                                        }

                                        function handleDragOver(e) {
                                            e.preventDefault();
                                            e.dataTransfer.dropEffect = 'copy';
                                            e.currentTarget.classList.add('drag-over-compact');
                                        }

                                        function handleDragLeave(e) {
                                            if (e.currentTarget === e.target) {
                                                e.currentTarget.classList.remove('drag-over-compact');
                                            }
                                        }

                                        function handleDrop(e) {
                                            e.preventDefault();
                                            e.currentTarget.classList.remove('drag-over-compact');
                                            
                                            const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                                            
                                            // Check if profile is already assigned
                                            if (assignedProfiles.find(p => p.id === data.id)) {
                                                return; // Already assigned
                                            }

                                            // Add to assigned profiles
                                            assignedProfiles.push({
                                                id: data.id,
                                                name: data.name,
                                                hours: data.hours,
                                                percentage: 0
                                            });

                                            renderAssignedProfiles();
                                            validatePercentages();
                                        }

                                        function renderAssignedProfiles() {
                                            const container = document.getElementById('assigned-profiles');
                                            
                                            if (assignedProfiles.length === 0) {
                                                container.innerHTML = '<div class="empty-state-compact">Drag profiles here to assign them</div>';
                                                return;
                                            }

                                            container.innerHTML = '<div class="assigned-profiles-grid">' + assignedProfiles.map(profile => `
                                                <div class="assigned-profile-compact">
                                                    <span class="assigned-profile-name-compact">${profile.name}</span>
                                                    <input type="number" 
                                                           class="percentage-input-compact" 
                                                           min="0" 
                                                           max="100" 
                                                           step="0.01"
                                                           placeholder="%" 
                                                           value="${profile.percentage || ''}"
                                                           onchange="updatePercentage('${profile.id}', this.value)">
                                                    <span style="font-size: 0.75em; color: #666;">%</span>
                                                    <button type="button" class="remove-profile-btn-compact" onclick="removeProfile('${profile.id}')">×</button>
                                                </div>
                                            `).join('') + '</div>';
                                        }

                                        function updatePercentage(profileId, percentage) {
                                            const profile = assignedProfiles.find(p => p.id === profileId);
                                            if (profile) {
                                                profile.percentage = parseFloat(percentage) || 0;
                                                validatePercentages();
                                                updateHiddenField();
                                            }
                                        }

                                        function removeProfile(profileId) {
                                            assignedProfiles = assignedProfiles.filter(p => p.id !== profileId);
                                            renderAssignedProfiles();
                                            validatePercentages();
                                            updateHiddenField();
                                        }

                                        function validatePercentages() {
                                            const validation = document.getElementById('percentage-validation');
                                            const total = assignedProfiles.reduce((sum, p) => sum + (p.percentage || 0), 0);
                                            
                                            if (assignedProfiles.length === 0) {
                                                validation.style.display = 'none';
                                                return true;
                                            }

                                            validation.style.display = 'block';
                                            
                                            if (Math.abs(total - 100) < 0.01) {
                                                validation.className = 'percentage-validation-compact success';
                                                validation.textContent = `✓ Total: ${total.toFixed(2)}% - Perfect!`;
                                                return true;
                                            } else {
                                                validation.className = 'percentage-validation-compact error';
                                                validation.textContent = `⚠ Total: ${total.toFixed(2)}% - Must equal 100%`;
                                                return false;
                                            }
                                        }

                                        function updateHiddenField() {
                                            const data = assignedProfiles.map(p => ({
                                                id: p.id,
                                                name: p.name,
                                                percentage: p.percentage || 0
                                            }));
                                            document.getElementById('activity_profiles_data').value = JSON.stringify(data);
                                        }

                                        // Initialize on page load
                                        document.addEventListener('DOMContentLoaded', function() {
                                            initDragAndDrop();
                                            
                                            // Set "Always On" as default with 100%
                                            {% if activity_profiles %}
                                                {% for profile in activity_profiles %}
                                                    {% if profile.name == 'Always On' %}
                                                        assignedProfiles.push({
                                                            id: '{{ profile.id }}',
                                                            name: '{{ profile.name }}',
                                                            hours: '{{ profile.hours }}',
                                                            percentage: 100
                                                        });
                                                        renderAssignedProfiles();
                                                        validatePercentages();
                                                        updateHiddenField();
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                        });

                                        // Form validation before submit
                                        document.getElementById('popcreate_form').addEventListener('submit', function(e) {
                                            if (assignedProfiles.length > 0 && !validatePercentages()) {
                                                e.preventDefault();
                                                alert('Please ensure that the total percentage of assigned activity profiles equals 100%');
                                                return false;
                                            }
                                        });
                                    </script>

                                </div>
                                <div class="button-wrap">
                                    <button class="button is-solid primary-button is-fullwidth">
                                        Create
                                    </button>
                                </div>
                                </form>
                            </div>
                        </div>


                        <!--Dashboard box-->

                    </div>


                    <!--Dashboard column-->
                    <div class="column is-4">
                        <!--Box-->
                        <div class="dashboard-box is-compact">
                            <h3 class="title is-5 is-thin">Guide</h3>
                            <div class="help-block">

                                <p>
                                    <b>What is a Population?</b>
                                    A population is a group of agents/pages that are used in a simulation.
                                    Each simulation can have multiple populations.
                                </p>
                                <br>
                                    <p>
                                        <b>Empty Populations</b>
                                         are used to create populations from scratch.
                                        Once created, you can add agents to the them.
                                </p>
                                <br>
                                <p>
                                    <b>Synthetic Populations</b>
                                     are created using a predefined set of parameters.
                                    Leveraging the parameters provided as input, agents are generated and added to the population.
                                </p>
                            </div>
                        </div>

                        <div class="dashboard-box is-compact">
                            <h3 class="title is-5 is-thin">Merge Populations</h3>
                            <div class="box-content">
                                <form action="/admin/merge_populations" method="POST" id="merge_populations_form">
                                    <div class="box-lines">
                                        <div class="box-line">
                                            <span class="left" style="width: 100%; font-size: 0.9em; color: #666; margin-bottom: 10px;">
                                                Create a new population by merging multiple existing populations. Agents and pages will be combined without duplicates.
                                            </span>
                                        </div>
                                        
                                        <div class="box-line">
                                            <span class="left">New Population Name</span>
                                            <span class="right" class="width-full"><input type="text" name="merged_population_name" class="input" required></span>
                                        </div>


                                        <div class="merge-populations-container">
                                            <div class="merge-section-title">Available Populations (Drag to select)</div>
                                            <div class="merge-available-populations" id="merge-available-populations">
                                                <div class="merge-empty-state">Loading populations...</div>
                                            </div>
                                        </div>

                                        <div class="merge-populations-container">
                                            <div class="merge-section-title">Selected Populations to Merge</div>
                                            <div class="merge-selected-populations" id="merge-selected-populations">
                                                <div class="merge-empty-state">Drag populations here</div>
                                            </div>
                                        </div>

                                        <input type="hidden" name="selected_population_ids" id="selected_population_ids" value="">
                                    </div>

                                    <div class="button-wrap">
                                        <button class="button is-solid primary-button is-fullwidth" type="submit">
                                            Merge Populations
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <script>
                            // Merge populations drag and drop functionality
                            let mergeAvailablePopulations = [];
                            let mergeSelectedPopulations = [];

                            // Load populations from the API
                            function loadMergePopulations() {
                                fetch('/admin/populations_data')
                                    .then(response => response.json())
                                    .then(data => {
                                        mergeAvailablePopulations = data.data.map(pop => ({
                                            id: pop.id,
                                            name: pop.name,
                                            size: pop.size || 0
                                        }));
                                        renderMergeAvailablePopulations();
                                    })
                                    .catch(error => {
                                        console.error('Error loading populations:', error);
                                        document.getElementById('merge-available-populations').innerHTML = 
                                            '<div class="merge-empty-state">Error loading populations</div>';
                                    });
                            }

                            function renderMergeAvailablePopulations() {
                                const container = document.getElementById('merge-available-populations');
                                
                                // Filter out already selected populations
                                const available = mergeAvailablePopulations.filter(pop => 
                                    !mergeSelectedPopulations.find(selected => selected.id === pop.id)
                                );

                                if (available.length === 0) {
                                    container.innerHTML = '<div class="merge-empty-state">No populations available</div>';
                                    return;
                                }

                                container.innerHTML = available.map(pop => `
                                    <div class="merge-population-item" 
                                         draggable="true" 
                                         data-pop-id="${pop.id}"
                                         data-pop-name="${pop.name}"
                                         data-pop-size="${pop.size}">
                                        <span class="merge-population-name">${pop.name}</span>
                                        <span class="merge-population-size">${pop.size} agents</span>
                                    </div>
                                `).join('');

                                // Add drag event listeners
                                container.querySelectorAll('.merge-population-item').forEach(item => {
                                    item.addEventListener('dragstart', handleMergeDragStart);
                                    item.addEventListener('dragend', handleMergeDragEnd);
                                });
                            }

                            function renderMergeSelectedPopulations() {
                                const container = document.getElementById('merge-selected-populations');
                                
                                if (mergeSelectedPopulations.length === 0) {
                                    container.innerHTML = '<div class="merge-empty-state">Drag populations here</div>';
                                    return;
                                }

                                container.innerHTML = mergeSelectedPopulations.map(pop => `
                                    <div class="merge-population-item">
                                        <span class="merge-population-name">${pop.name}</span>
                                        <span class="merge-population-size">${pop.size} agents</span>
                                        <button type="button" class="merge-remove-btn" onclick="removeMergePopulation(${pop.id})">×</button>
                                    </div>
                                `).join('');

                                // Update hidden field
                                document.getElementById('selected_population_ids').value = 
                                    mergeSelectedPopulations.map(p => p.id).join(',');
                            }

                            function handleMergeDragStart(e) {
                                e.currentTarget.classList.add('dragging');
                                e.dataTransfer.effectAllowed = 'move';
                                e.dataTransfer.setData('text/plain', JSON.stringify({
                                    id: e.currentTarget.dataset.popId,
                                    name: e.currentTarget.dataset.popName,
                                    size: e.currentTarget.dataset.popSize
                                }));
                            }

                            function handleMergeDragEnd(e) {
                                e.currentTarget.classList.remove('dragging');
                            }

                            function handleMergeDragOver(e) {
                                e.preventDefault();
                                e.dataTransfer.dropEffect = 'move';
                                e.currentTarget.classList.add('merge-drag-over');
                            }

                            function handleMergeDragLeave(e) {
                                if (e.currentTarget === e.target) {
                                    e.currentTarget.classList.remove('merge-drag-over');
                                }
                            }

                            function handleMergeDrop(e) {
                                e.preventDefault();
                                e.currentTarget.classList.remove('merge-drag-over');
                                
                                const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                                
                                // Add to selected if not already there
                                if (!mergeSelectedPopulations.find(p => p.id === data.id)) {
                                    mergeSelectedPopulations.push({
                                        id: data.id,
                                        name: data.name,
                                        size: data.size
                                    });
                                    renderMergeSelectedPopulations();
                                    renderMergeAvailablePopulations();
                                }
                            }

                            function removeMergePopulation(popId) {
                                mergeSelectedPopulations = mergeSelectedPopulations.filter(p => p.id !== popId);
                                renderMergeSelectedPopulations();
                                renderMergeAvailablePopulations();
                            }

                            // Initialize merge drag and drop
                            document.addEventListener('DOMContentLoaded', function() {
                                loadMergePopulations();
                                
                                const selectedContainer = document.getElementById('merge-selected-populations');
                                selectedContainer.addEventListener('dragover', handleMergeDragOver);
                                selectedContainer.addEventListener('drop', handleMergeDrop);
                                selectedContainer.addEventListener('dragleave', handleMergeDragLeave);
                            });

                            // Form validation
                            document.getElementById('merge_populations_form').addEventListener('submit', function(e) {
                                if (mergeSelectedPopulations.length < 2) {
                                    e.preventDefault();
                                    alert('Please select at least 2 populations to merge');
                                    return false;
                                }
                            });
                        </script>

                    </div>
                </div>
            </div>
        </div>

    </div>



{% include "admin/footer.html" %}