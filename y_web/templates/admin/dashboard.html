{% include "admin/head.html" %}

{# Macro for rendering an experiment box (full version with client details for running experiments) #}
{% macro render_experiment_box(experiments, section_color, show_run_buttons=true) %}
    {% for exp in experiments %}
    {# Check if any client in this experiment has infinite duration (days = -1) #}
    {% set ns = namespace(has_infinite_client=false) %}
    {% for client in experiments[exp]["clients"] %}
        {% if client[0].days == -1 %}
            {% set ns.has_infinite_client = true %}
        {% endif %}
    {% endfor %}
    <div class="box-content" style="background: #fafafa; border: 1px solid #e6e6e6; border-left: 4px solid {{ section_color }}; border-radius: 8px; padding-left: 15px; padding-right: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.06);">
        <div class="box-lines">
            <div class="box-line" style="padding-bottom: 5px; margin-bottom: 5px;">
                <span class="left" style="display: flex; align-items: center; gap: 10px;">
                    Experiment: <strong style="color: #0d95e8">{{ experiments[exp]['experiment'].exp_name }}</strong>
                    <span style="background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%); color: white; font-size: 0.7em; padding: 2px 6px; border-radius: 10px; font-weight: 600;" title="Experiment owner">{{ experiments[exp]['experiment'].owner }}</span>
                    {% if ns.has_infinite_client %}
                    <span style="background: linear-gradient(90deg, #22c55e 0%, #4ade80 100%); color: white; font-size: 0.7em; padding: 2px 6px; border-radius: 10px; font-weight: 600;" title="This experiment has at least one client set to run until manually stopped">∞ Infinite</span>
                    {% endif %}
                    <a href="/admin/experiment_details/{{ experiments[exp]['experiment'].idexp }}" class="link-tooltip" title="View Experiment Details">
                        <i class="mdi mdi-open-in-new" style="font-size: 16px; color: #039be5;"></i>
                    </a>
                </span>
                <span class="right" style="display: flex; gap: 8px; align-items: center;">
                    <div style="display: flex; gap: 3px; padding-right: 8px; border-right: 1px solid #ddd;">
                        {% if experiments[exp]['experiment'].running == 0 %}
                        <a class="link-tooltip" href="#" onclick="startExperimentServer('{{ experiments[exp]['experiment'].idexp }}'); return false;" title="Run Experiment">
                            <i class="mdi mdi-play-box-outline" style="font-size: 24px;"></i>
                        </a>
                        {% endif %}
                        {% if experiments[exp]['experiment'].running == 1 %}
                        <a class="link-tooltip" href="#" onclick="stopExperimentServer('{{ experiments[exp]['experiment'].idexp }}'); return false;" title="Stop Experiment">
                            <i class="mdi mdi-stop active" style="font-size: 24px;"></i>
                        </a>
                        {% endif %}
                        <a class="link-tooltip" href="#" onclick="selectExperiment('{{ experiments[exp]['experiment'].idexp }}'); return false;" title="Load Experiment">
                            <i class="mdi mdi-select-all {% if experiments[exp]['experiment'].status == 1 %}active{%endif%}" style="font-size: 24px;"></i>
                        </a>
                        {% if experiments[exp]['experiment'].status == 1 %}
                        <a class="link-tooltip" href="#" onclick="joinExperiment('{{ experiments[exp]['experiment'].idexp }}'); return false;" title="Join This Experiment">
                            <i class="mdi mdi-login" style="font-size: 24px;"></i>
                        </a>
                        {% endif %}
                        {% if experiments[exp]['experiment'].status == 0 %}
                        <a class="link-tooltip" href="javascript:void(0);" 
                           onclick="if(confirm('Are you sure you want to delete this experiment? This action cannot be undone.')) { window.location.href='/admin/delete_simulation/{{ experiments[exp]['experiment'].idexp }}'; }" 
                           title="Delete Experiment">
                            <i class="mdi mdi-delete" style="font-size: 24px;"></i>
                        </a>
                        {% endif %}
                    </div>
                    {% if jupyter_by_exp.get(experiments[exp]['experiment'].idexp) %}
                        {% if notebook %}
                        <div style="display: flex; gap: 3px;">
                            {% if jupyter_by_exp[experiments[exp]['experiment'].idexp]['running'] %}
                            <a class="link-tooltip" href="#" onclick="stopJupyterSession('{{ experiments[exp]['experiment'].idexp }}'); return false;" title="Stop JupyterLab">
                                <i class="mdi mdi-flask-empty-outline" style="font-size: 24px; color: #dc3545;"></i>
                            </a>
                            <a class="link-tooltip" href="/admin/lab/{{ experiments[exp]['experiment'].idexp }}" {% if not is_pyinstaller %}target="_blank"{% endif %} title="Open JupyterLab">
                                <i class="mdi mdi-open-in-new" style="font-size: 24px; color: #039be5;"></i>
                            </a>
                            {% else %}
                            <a class="link-tooltip" href="#" onclick="startJupyterSession('{{ experiments[exp]['experiment'].idexp }}'); return false;" title="Start JupyterLab">
                                <i class="mdi mdi-flask-outline" style="font-size: 24px; color: #039be5;"></i>
                            </a>
                            {% endif %}
                        </div>
                        {% endif %}
                    {% endif %}
                </span>
            </div>
            
            {% if len(experiments[exp]["clients"]) > 0 %}
            <hr style="border-top: 2px solid #e6e6e6; margin-top: 0px; padding-top: 0px; margin-bottom: 0px;">
            {% for client in experiments[exp]["clients"] %}
            <div class="box-line" style="padding-left: 20px; padding-top: 8px; padding-bottom: 8px;  ">
                <span class="left" style="font-size: 0.9em; display: flex; align-items: center; gap: 5px;">Client:
                    <i class="mdi mdi-account-cog" style="font-size: 16px; color: #7f8c8d;"></i>
                    <em style="color: #0d95e8">{{ client[0].name }}</em>
                    {% if client[1] != -1 and client[1].elapsed_time > 0 %}
                    <a href="/admin/client_details/{{client[0].id}}" class="link-tooltip" title="View Client Details">
                        <i class="mdi mdi-open-in-new" style="font-size: 16px; color: #039be5;"></i>
                    </a>
                    {% endif %}
                </span>
                <span class="right" style="width: 55%; display: flex; align-items: center; gap: 10px;">
                    <div class="sleek-progress-container" style="flex: 1; position: relative; background: linear-gradient(to right, #f5f5f5 0%, #e8e8e8 100%); border-radius: 20px; height: 24px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.08);">
                        <div id="progress-bar-{{client[0].id}}" class="sleek-progress-bar" 
                             style="position: absolute; left: 0; top: 0; height: 100%; width: 0%; background: linear-gradient(90deg, #039be5 0%, #4facfe 100%); border-radius: 20px; transition: width 0.4s ease-in-out, background 0.3s ease; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 6px rgba(3,155,229,0.3);">
                            <span style="font-size: 0.75em; font-weight: 600; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">0%</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 3px;">
                        {% if client[0].status == 0 and experiments[exp]['experiment'].running == 1 %}
                            {% if client[1] != -1 %}
                                {% if client[1].elapsed_time == 0 %}
                                <a class="link-tooltip" href="/admin/run_client/{{ client[0].id }}/{{ client[0].id_exp }}" title="Run Client">
                                    <i class="mdi mdi-play-box-outline" style="font-size: 20px;"></i>
                                </a>
                                {% elif client[1].expected_duration_rounds == -1 %}
                                {# Infinite client - always show resume button if started #}
                                <a class="link-tooltip" href="/admin/resume_client/{{ client[0].id }}/{{ client[0].id_exp }}" title="Resume Client">
                                    <i class="mdi mdi-play-box-outline" style="font-size: 20px;"></i>
                                </a>
                                {% elif client[1].elapsed_time > 0 and client[1].elapsed_time < client[1].expected_duration_rounds %}
                                <a class="link-tooltip" href="/admin/resume_client/{{ client[0].id }}/{{ client[0].id_exp }}" title="Resume Client">
                                    <i class="mdi mdi-play-box-outline" style="font-size: 20px;"></i>
                                </a>
                                {% endif %}
                            {% else %}
                            <a class="link-tooltip" href="/admin/run_client/{{ client[0].id }}/{{ client[0].id_exp }}" title="Run Client">
                                <i class="mdi mdi-play-box-outline" style="font-size: 20px;"></i>
                            </a>
                            {% endif %}
                        {% endif %}
                        {% if client[0].status == 1 %}
                        <a class="link-tooltip" href="/admin/pause_client/{{ client[0].id }}/{{ client[0].id_exp }}" title="Pause Client">
                            <i class="mdi mdi-pause active" style="font-size: 20px;"></i>
                        </a>
                        {% endif %}
                        {% if client[0].status == 0 %}
                        <a class="link-tooltip" href="javascript:void(0);" 
                           onclick="if(confirm('Are you sure you want to delete this client? This action cannot be undone.')) { window.location.href='/admin/delete_client/{{ client[0].id }}'; }" 
                           title="Delete Client">
                            <i class="mdi mdi-delete" style="font-size: 20px;"></i>
                        </a>
                        {% endif %}
                    </div>
                </span>
            </div>
            
            <script>
                $(document).ready(function () {
                    $.ajax({
                        url: `/admin/progress/{{client[0].id}}`,
                        method: 'GET'
                    });

                    function pollProgress() {
                        $.ajax({
                            url: '/admin/progress/{{client[0].id}}',
                            method: 'GET',
                            dataType: 'json',
                            success: function (data) {
                                const progressBar = $('#progress-bar-{{client[0].id}}');
                                
                                // Check if this is an infinite client
                                if (data.infinite) {
                                    // For infinite clients, show green bar with elapsed time
                                    progressBar.css('width', '100%');
                                    progressBar.css('background', 'linear-gradient(90deg, #22c55e 0%, #4ade80 100%)');
                                    progressBar.css('box-shadow', '0 2px 6px rgba(34,197,94,0.3)');
                                    
                                    // Format elapsed time display
                                    const days = data.elapsed_days || 0;
                                    const hours = data.elapsed_hours || 0;
                                    let timeText = '';
                                    if (days > 0) {
                                        timeText = days + 'd ' + hours + 'h';
                                    } else {
                                        timeText = hours + 'h elapsed';
                                    }
                                    progressBar.find('span').text('∞ ' + timeText);
                                    
                                    // Keep polling for infinite clients
                                    setTimeout(pollProgress, 1000);
                                } else {
                                    const percentage = data.progress;
                                    progressBar.css('width', percentage + '%');
                                    progressBar.find('span').text(percentage + '%');
                                    
                                    // Update gradient based on progress - aligned with template colors
                                    if (percentage >= 75) {
                                        progressBar.css('background', 'linear-gradient(90deg, #039be5 0%, #00d1b2 100%)');
                                        progressBar.css('box-shadow', '0 2px 6px rgba(0,209,178,0.3)');
                                    } else if (percentage >= 50) {
                                        progressBar.css('background', 'linear-gradient(90deg, #039be5 0%, #5596e6 100%)');
                                        progressBar.css('box-shadow', '0 2px 6px rgba(85,150,230,0.3)');
                                    }
                                    
                                    if (percentage < 100) {
                                        setTimeout(pollProgress, 500);
                                    }
                                }
                            }
                        });
                    }
                    pollProgress();
                });
            </script>
            {% endfor %}
            {% endif %}
        </div>
    </div>
    {% endfor %}
{% endmacro %}

{# Compact macro for rendering experiment boxes (without client details - for completed/stopped experiments) #}
{% macro render_compact_experiment_box(experiments, section_color) %}
    {% for exp in experiments %}
    {# Check if any client in this experiment has infinite duration (days = -1) #}
    {% set ns = namespace(has_infinite_client=false, client_count=0) %}
    {% for client in experiments[exp]["clients"] %}
        {% if client[0].days == -1 %}
            {% set ns.has_infinite_client = true %}
        {% endif %}
        {% set ns.client_count = ns.client_count + 1 %}
    {% endfor %}
    <div class="box-content" style="background: #fafafa; border: 1px solid #e6e6e6; border-left: 2px solid {{ section_color }}; border-radius: 4px; padding: 4px 8px; margin-bottom: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.03);">
        <div class="box-lines">
            <div class="box-line" style="padding: 0; display: flex; align-items: center; justify-content: space-between; gap: 4px;">
                <span class="left" style="display: flex; align-items: center; gap: 4px; flex: 1; min-width: 0; overflow: hidden;">
                    <strong style="color: #0d95e8; font-size: 0.85em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 120px;" title="{{ experiments[exp]['experiment'].exp_name }}">{{ experiments[exp]['experiment'].exp_name }}</strong>
                    {% if experiments[exp]['experiment'].owner %}
                    <span style="background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%); color: white; font-size: 0.6em; padding: 0 4px; border-radius: 6px; font-weight: 600; line-height: 1.4;" title="Owner">{{ experiments[exp]['experiment'].owner }}</span>
                    {% endif %}
                    {% if ns.client_count > 0 %}
                    <span style="background: #e0e0e0; color: #666; font-size: 0.6em; padding: 0 4px; border-radius: 6px; line-height: 1.4;" title="Clients">{{ ns.client_count }}</span>
                    {% endif %}
                    {% if ns.has_infinite_client %}
                    <span style="background: linear-gradient(90deg, #22c55e 0%, #4ade80 100%); color: white; font-size: 0.6em; padding: 0 4px; border-radius: 6px; font-weight: 600; line-height: 1.4;" title="Infinite">∞</span>
                    {% endif %}
                </span>
                <span class="right" style="display: flex; gap: 2px; align-items: center; flex-shrink: 0;">
                    {% if experiments[exp]['experiment'].running == 0 %}
                    <a class="link-tooltip" href="#" onclick="startExperimentServer('{{ experiments[exp]['experiment'].idexp }}'); return false;" title="Run">
                        <i class="mdi mdi-play-box-outline" style="font-size: 16px;"></i>
                    </a>
                    {% endif %}
                    {% if experiments[exp]['experiment'].running == 1 %}
                    <a class="link-tooltip" href="#" onclick="stopExperimentServer('{{ experiments[exp]['experiment'].idexp }}'); return false;" title="Stop">
                        <i class="mdi mdi-stop active" style="font-size: 16px;"></i>
                    </a>
                    {% endif %}
                    <a class="link-tooltip" href="#" onclick="selectExperiment('{{ experiments[exp]['experiment'].idexp }}'); return false;" title="Load">
                        <i class="mdi mdi-select-all {% if experiments[exp]['experiment'].status == 1 %}active{%endif%}" style="font-size: 16px;"></i>
                    </a>
                    <a href="/admin/experiment_details/{{ experiments[exp]['experiment'].idexp }}" class="link-tooltip" title="Details">
                        <i class="mdi mdi-open-in-new" style="font-size: 14px; color: #039be5;"></i>
                    </a>
                    {% if experiments[exp]['experiment'].status == 0 %}
                    <a class="link-tooltip" href="javascript:void(0);" 
                       onclick="if(confirm('Are you sure you want to delete this experiment? This action cannot be undone.')) { window.location.href='/admin/delete_simulation/{{ experiments[exp]['experiment'].idexp }}'; }" 
                       title="Delete">
                        <i class="mdi mdi-delete" style="font-size: 16px;"></i>
                    </a>
                    {% endif %}
                </span>
            </div>
        </div>
    </div>
    {% endfor %}
{% endmacro %}

<div class="view-wrapper is-dashboard">
    <!--Dashboard container-->

    <div id="creator-dashboard" class="dashboard-container">
        <!--Toolbar-->

        {% include "admin/dash_head.html" %}

        <div class="dashboard-body">
            <div class="columns">
                     <!--Dashboard column-->

                <div class="column is-8">

                    {% for message in get_flashed_messages() %}
                    <div class="alert alert-warning">
                        <button type="button" class="close" data-dismiss="alert">&times;</button>
                        {{ message }}
                    </div>
                    {% endfor %}

                    <!--Dashboard box-->
                    {% if total_experiments > 0 %}
                    
                    <!-- Currently Running Experiments (Active) - Full width -->
                    {% if len(running_experiments) > 0 %}
                    <div class="dashboard-box">
                         <h3 class="title is-5 is-thin" style="display: flex; align-items: center; gap: 10px;">
                            <span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background-color: #28a745;"></span>
                            Currently Running Experiments
                            <span style="font-size: 0.7em; color: #666; font-weight: normal;">({{ len(running_experiments) }} of {{ total_running }})</span>
                         </h3>
                         <p style="font-size: 0.9em; color: #666; margin-bottom: 1em;">
                            Active experiments with their running clients and real-time progress monitoring.
                        </p>
                        <div id="running-experiments-container">
                            {{ render_experiment_box(running_experiments, '#28a745') }}
                        </div>
                        {% if total_running > 5 %}
                        <div style="display: flex; justify-content: center; gap: 10px; margin-top: 10px;">
                            <button id="running-prev" class="button is-small is-light" disabled onclick="paginateRunning(-1)">
                                <i class="mdi mdi-chevron-left"></i> Prev
                            </button>
                            <span id="running-page-info" style="font-size: 0.85em; color: #666; align-self: center;">Page 1 of {{ ((total_running - 1) // 5) + 1 }}</span>
                            <button id="running-next" class="button is-small is-light" onclick="paginateRunning(1)">
                                Next <i class="mdi mdi-chevron-right"></i>
                            </button>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- Completed and Stopped/Scheduled on the same row -->
                    <div class="columns is-multiline" style="margin-bottom: 0; display: flex; align-items: stretch;">
                        <!-- Completed Experiments - Half width on desktop -->
                        {% if len(completed_experiments) > 0 %}
                        <div class="column is-6-desktop is-12-tablet is-12-mobile" style="display: flex;">
                            <div class="dashboard-box" style="flex: 1; margin-bottom: 0; display: flex; flex-direction: column;">
                                 <h3 class="title is-6 is-thin" style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <span style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background-color: #17a2b8;"></span>
                                    Completed
                                    <span style="font-size: 0.7em; color: #666; font-weight: normal;">({{ len(completed_experiments) }} of {{ total_completed }})</span>
                                 </h3>
                                 <p style="font-size: 0.8em; color: #666; margin-bottom: 0.8em;">
                                    All clients have reached completion.
                                </p>
                                <div id="completed-experiments-container" style="flex: 1;">
                                    {{ render_compact_experiment_box(completed_experiments, '#17a2b8') }}
                                </div>
                                {% if total_completed > 5 %}
                                <div style="display: flex; justify-content: center; gap: 8px; margin-top: 8px;">
                                    <button id="completed-prev" class="button is-small is-light" disabled onclick="paginateCompleted(-1)">
                                        <i class="mdi mdi-chevron-left"></i>
                                    </button>
                                    <span id="completed-page-info" style="font-size: 0.75em; color: #666; align-self: center;">1/{{ ((total_completed - 1) // 5) + 1 }}</span>
                                    <button id="completed-next" class="button is-small is-light" onclick="paginateCompleted(1)">
                                        <i class="mdi mdi-chevron-right"></i>
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Stopped/Scheduled Experiments - Half width on desktop -->
                        {% if len(stopped_experiments) > 0 %}
                        <div class="column is-6-desktop is-12-tablet is-12-mobile" style="display: flex;">
                            <div class="dashboard-box" style="flex: 1; margin-bottom: 0; display: flex; flex-direction: column;">
                                 <h3 class="title is-6 is-thin" style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <span style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background-color: #6c757d;"></span>
                                    Stopped / Scheduled
                                    <span style="font-size: 0.7em; color: #666; font-weight: normal;">({{ len(stopped_experiments) }} of {{ total_stopped }})</span>
                                 </h3>
                                 <p style="font-size: 0.8em; color: #666; margin-bottom: 0.8em;">
                                    Experiments stopped or scheduled to run.
                                </p>
                                <div id="stopped-experiments-container" style="flex: 1;">
                                    {{ render_compact_experiment_box(stopped_experiments, '#6c757d') }}
                                </div>
                                {% if total_stopped > 5 %}
                                <div style="display: flex; justify-content: center; gap: 8px; margin-top: 8px;">
                                    <button id="stopped-prev" class="button is-small is-light" disabled onclick="paginateStopped(-1)">
                                        <i class="mdi mdi-chevron-left"></i>
                                    </button>
                                    <span id="stopped-page-info" style="font-size: 0.75em; color: #666; align-self: center;">1/{{ ((total_stopped - 1) // 5) + 1 }}</span>
                                    <button id="stopped-next" class="button is-small is-light" onclick="paginateStopped(1)">
                                        <i class="mdi mdi-chevron-right"></i>
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    {% else %}

                    <div class="dashboard-box">
                        <div class="box-content">
                            <img src="{{ url_for('static', filename='assets/img/robots/header3.jpg') }}" style="border-radius: 10px; filter: saturate(1); opacity: 0.6;">

                        </div>
                    </div>
                    {% endif %}

                    {% if total_experiments > 0 %}
                    <script>
                        function startJupyterSession(expId) {
                            fetch(`/admin/lab_start/${expId}`)
                                .then(response => response.json())
                                .then(data => {
                                    location.reload();
                                })
                                .catch(error => {
                                    console.error('Error starting JupyterLab:', error);
                                    location.reload();
                                });
                        }

                        function stopJupyterSession(expId) {
                            fetch(`/admin/lab_stop/${expId}`)
                                .then(response => response.json())
                                .then(data => {
                                    location.reload();
                                })
                                .catch(error => {
                                    console.error('Error stopping JupyterLab:', error);
                                    location.reload();
                                });
                        }
                        
                        // Dynamic dashboard refresh - update experiment status every 30 seconds
                        const DASHBOARD_REFRESH_INTERVAL = 30000;
                        
                        // Track current counts to detect changes
                        let dashboardState = {
                            running: {{ total_running }},
                            completed: {{ total_completed }},
                            stopped: {{ total_stopped }}
                        };
                        
                        // Check if tutorial overlay is open
                        function isTutorialOpen() {
                            const overlay = document.getElementById('tutorial-overlay');
                            return overlay && overlay.style.display !== 'none';
                        }
                        
                        // Render a compact experiment box from JSON data (for completed/stopped)
                        function renderCompactExperimentBoxFromData(exp, sectionColor) {
                            const hasInfiniteClient = exp.clients.some(client => client.days === -1);
                            const clientCount = exp.clients.length;
                            
                            const infiniteBadge = hasInfiniteClient ? 
                                `<span style="background: linear-gradient(90deg, #22c55e 0%, #4ade80 100%); color: white; font-size: 0.6em; padding: 0 4px; border-radius: 6px; font-weight: 600; line-height: 1.4;" title="Infinite">∞</span>` : '';
                            
                            const clientCountBadge = clientCount > 0 ?
                                `<span style="background: #e0e0e0; color: #666; font-size: 0.6em; padding: 0 4px; border-radius: 6px; line-height: 1.4;" title="Clients">${clientCount}</span>` : '';
                            
                            const runButton = exp.running === 0 ?
                                `<a class="link-tooltip" href="#" onclick="startExperimentServer('${exp.idexp}'); return false;" title="Run">
                                    <i class="mdi mdi-play-box-outline" style="font-size: 16px;"></i>
                                </a>` :
                                `<a class="link-tooltip" href="#" onclick="stopExperimentServer('${exp.idexp}'); return false;" title="Stop">
                                    <i class="mdi mdi-stop active" style="font-size: 16px;"></i>
                                </a>`;
                            
                            const deleteExpButton = exp.status === 0 ?
                                `<a class="link-tooltip" href="javascript:void(0);" 
                                   onclick="if(confirm('Are you sure you want to delete this experiment? This action cannot be undone.')) { window.location.href='/admin/delete_simulation/${exp.idexp}'; }" 
                                   title="Delete">
                                    <i class="mdi mdi-delete" style="font-size: 16px;"></i>
                                </a>` : '';
                            
                            const ownerBadge = exp.owner ? 
                                `<span style="background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%); color: white; font-size: 0.6em; padding: 0 4px; border-radius: 6px; font-weight: 600; line-height: 1.4;" title="Owner">${exp.owner}</span>` : '';
                            
                            return `
                            <div class="box-content" style="background: #fafafa; border: 1px solid #e6e6e6; border-left: 2px solid ${sectionColor}; border-radius: 4px; padding: 4px 8px; margin-bottom: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.03);">
                                <div class="box-lines">
                                    <div class="box-line" style="padding: 0; display: flex; align-items: center; justify-content: space-between; gap: 4px;">
                                        <span class="left" style="display: flex; align-items: center; gap: 4px; flex: 1; min-width: 0; overflow: hidden;">
                                            <strong style="color: #0d95e8; font-size: 0.85em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 120px;" title="${exp.exp_name}">${exp.exp_name}</strong>
                                            ${ownerBadge}
                                            ${clientCountBadge}
                                            ${infiniteBadge}
                                        </span>
                                        <span class="right" style="display: flex; gap: 2px; align-items: center; flex-shrink: 0;">
                                            ${runButton}
                                            <a class="link-tooltip" href="#" onclick="selectExperiment('${exp.idexp}'); return false;" title="Load">
                                                <i class="mdi mdi-select-all ${exp.status === 1 ? 'active' : ''}" style="font-size: 16px;"></i>
                                            </a>
                                            <a href="/admin/experiment_details/${exp.idexp}" class="link-tooltip" title="Details">
                                                <i class="mdi mdi-open-in-new" style="font-size: 14px; color: #039be5;"></i>
                                            </a>
                                            ${deleteExpButton}
                                        </span>
                                    </div>
                                </div>
                            </div>`;
                        }
                        }
                        
                        // Render a single experiment box from JSON data (full version for running experiments)
                        function renderExperimentBoxFromData(exp, sectionColor, jupyterByExp, notebook, isPyinstaller) {
                            const hasInfiniteClient = exp.clients.some(client => client.days === -1);
                            const clientsHtml = exp.clients.map(client => {
                                let runButtonHtml = '';
                                if (client.status === 0 && exp.running === 1) {
                                    if (client.elapsed === 0) {
                                        runButtonHtml = `<a class="link-tooltip" href="/admin/run_client/${client.id}/${exp.idexp}" title="Run Client">
                                            <i class="mdi mdi-play-box-outline" style="font-size: 20px;"></i>
                                        </a>`;
                                    } else if (client.expected === -1 || (client.elapsed > 0 && client.elapsed < client.expected)) {
                                        runButtonHtml = `<a class="link-tooltip" href="/admin/resume_client/${client.id}/${exp.idexp}" title="Resume Client">
                                            <i class="mdi mdi-play-box-outline" style="font-size: 20px;"></i>
                                        </a>`;
                                    }
                                }
                                
                                const pauseButtonHtml = client.status === 1 ? 
                                    `<a class="link-tooltip" href="/admin/pause_client/${client.id}/${exp.idexp}" title="Pause Client">
                                        <i class="mdi mdi-pause active" style="font-size: 20px;"></i>
                                    </a>` : '';
                                
                                const deleteButtonHtml = client.status === 0 ?
                                    `<a class="link-tooltip" href="javascript:void(0);" 
                                       onclick="if(confirm('Are you sure you want to delete this client?')) { window.location.href='/admin/delete_client/${client.id}'; }" 
                                       title="Delete Client">
                                        <i class="mdi mdi-delete" style="font-size: 20px;"></i>
                                    </a>` : '';
                                
                                const detailsLink = client.elapsed > 0 ?
                                    `<a href="/admin/client_details/${client.id}" class="link-tooltip" title="View Client Details">
                                        <i class="mdi mdi-open-in-new" style="font-size: 16px; color: #039be5;"></i>
                                    </a>` : '';
                                
                                return `
                                <div class="box-line" style="padding-left: 20px; padding-top: 8px; padding-bottom: 8px;">
                                    <span class="left" style="font-size: 0.9em; display: flex; align-items: center; gap: 5px;">Client:
                                        <i class="mdi mdi-account-cog" style="font-size: 16px; color: #7f8c8d;"></i>
                                        <em style="color: #0d95e8">${client.name}</em>
                                        ${detailsLink}
                                    </span>
                                    <span class="right" style="width: 55%; display: flex; align-items: center; gap: 10px;">
                                        <div class="sleek-progress-container" style="flex: 1; position: relative; background: linear-gradient(to right, #f5f5f5 0%, #e8e8e8 100%); border-radius: 20px; height: 24px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.08);">
                                            <div id="progress-bar-${client.id}" class="sleek-progress-bar" 
                                                 style="position: absolute; left: 0; top: 0; height: 100%; width: ${client.progress}%; background: linear-gradient(90deg, #039be5 0%, #4facfe 100%); border-radius: 20px; transition: width 0.4s ease-in-out; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 6px rgba(3,155,229,0.3);">
                                                <span style="font-size: 0.75em; font-weight: 600; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">${client.progress}%</span>
                                            </div>
                                        </div>
                                        <div style="display: flex; gap: 3px;">
                                            ${runButtonHtml}
                                            ${pauseButtonHtml}
                                            ${deleteButtonHtml}
                                        </div>
                                    </span>
                                </div>`;
                            }).join('');
                            
                            const infiniteBadge = hasInfiniteClient ? 
                                `<span style="background: linear-gradient(90deg, #22c55e 0%, #4ade80 100%); color: white; font-size: 0.7em; padding: 2px 6px; border-radius: 10px; font-weight: 600;" title="This experiment has at least one client set to run until manually stopped">∞ Infinite</span>` : '';
                            
                            const runButton = exp.running === 0 ?
                                `<a class="link-tooltip" href="#" onclick="startExperimentServer('${exp.idexp}'); return false;" title="Run Experiment">
                                    <i class="mdi mdi-play-box-outline" style="font-size: 24px;"></i>
                                </a>` :
                                `<a class="link-tooltip" href="#" onclick="stopExperimentServer('${exp.idexp}'); return false;" title="Stop Experiment">
                                    <i class="mdi mdi-stop active" style="font-size: 24px;"></i>
                                </a>`;
                            
                            const joinButton = exp.status === 1 ?
                                `<a class="link-tooltip" href="#" onclick="joinExperiment('${exp.idexp}'); return false;" title="Join This Experiment">
                                    <i class="mdi mdi-login" style="font-size: 24px;"></i>
                                </a>` : '';
                            
                            const deleteExpButton = exp.status === 0 ?
                                `<a class="link-tooltip" href="javascript:void(0);" 
                                   onclick="if(confirm('Are you sure you want to delete this experiment? This action cannot be undone.')) { window.location.href='/admin/delete_simulation/${exp.idexp}'; }" 
                                   title="Delete Experiment">
                                    <i class="mdi mdi-delete" style="font-size: 24px;"></i>
                                </a>` : '';
                            
                            const clientsSeparator = exp.clients.length > 0 ? 
                                '<hr style="border-top: 2px solid #e6e6e6; margin-top: 0px; padding-top: 0px; margin-bottom: 0px;">' : '';
                            
                            const ownerBadgeFull = exp.owner ?
                                `<span style="background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%); color: white; font-size: 0.7em; padding: 2px 6px; border-radius: 10px; font-weight: 600;" title="Experiment owner">${exp.owner}</span>` : '';
                            
                            return `
                            <div class="box-content" style="background: #fafafa; border: 1px solid #e6e6e6; border-left: 4px solid ${sectionColor}; border-radius: 8px; padding-left: 15px; padding-right: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.06);">
                                <div class="box-lines">
                                    <div class="box-line" style="padding-bottom: 5px; margin-bottom: 5px;">
                                        <span class="left" style="display: flex; align-items: center; gap: 10px;">
                                            Experiment: <strong style="color: #0d95e8">${exp.exp_name}</strong>
                                            ${ownerBadgeFull}
                                            ${infiniteBadge}
                                            <a href="/admin/experiment_details/${exp.idexp}" class="link-tooltip" title="View Experiment Details">
                                                <i class="mdi mdi-open-in-new" style="font-size: 16px; color: #039be5;"></i>
                                            </a>
                                        </span>
                                        <span class="right" style="display: flex; gap: 8px; align-items: center;">
                                            <div style="display: flex; gap: 3px; padding-right: 8px; border-right: 1px solid #ddd;">
                                                ${runButton}
                                                <a class="link-tooltip" href="#" onclick="selectExperiment('${exp.idexp}'); return false;" title="Load Experiment">
                                                    <i class="mdi mdi-select-all ${exp.status === 1 ? 'active' : ''}" style="font-size: 24px;"></i>
                                                </a>
                                                ${joinButton}
                                                ${deleteExpButton}
                                            </div>
                                        </span>
                                    </div>
                                    ${clientsSeparator}
                                    ${clientsHtml}
                                </div>
                            </div>`;
                        }
                        
                        // Async refresh of experiment containers
                        async function refreshDashboardAsync() {
                            // Don't refresh if tutorial is open
                            if (isTutorialOpen()) {
                                console.log('Tutorial is open, skipping dashboard refresh');
                                return;
                            }
                            
                            try {
                                // Fetch current status
                                const statusResponse = await fetch('/admin/dashboard/status');
                                const statusData = await statusResponse.json();
                                
                                // Update counts in headers if they changed
                                if (statusData.running !== dashboardState.running ||
                                    statusData.completed !== dashboardState.completed ||
                                    statusData.stopped !== dashboardState.stopped) {
                                    
                                    // Update state
                                    dashboardState.running = statusData.running;
                                    dashboardState.completed = statusData.completed;
                                    dashboardState.stopped = statusData.stopped;
                                    
                                    // Fetch updated experiment data for each section
                                    await Promise.all([
                                        refreshExperimentSection('running', '#28a745'),
                                        refreshExperimentSection('completed', '#17a2b8'),
                                        refreshExperimentSection('stopped', '#6c757d')
                                    ]);
                                }
                            } catch (error) {
                                console.error('Error refreshing dashboard:', error);
                            }
                        }
                        
                        async function refreshExperimentSection(status, sectionColor) {
                            try {
                                const response = await fetch(`/admin/dashboard/experiments/${status}?page=1&per_page=5`);
                                const data = await response.json();
                                
                                const containerId = `${status === 'running' ? 'running' : status}-experiments-container`;
                                const container = document.getElementById(containerId);
                                
                                if (container && data.experiments) {
                                    // Use compact rendering for completed/stopped, full for running
                                    const renderFunc = status === 'running' 
                                        ? (exp) => renderExperimentBoxFromData(exp, sectionColor, {}, false, false)
                                        : (exp) => renderCompactExperimentBoxFromData(exp, sectionColor);
                                    const html = data.experiments.map(renderFunc).join('');
                                    container.innerHTML = html || '<p style="color: #666; text-align: center;">No experiments in this category</p>';
                                }
                            } catch (error) {
                                console.error(`Error refreshing ${status} experiments:`, error);
                            }
                        }
                        
                        // Pagination state
                        let paginationState = {
                            running: { page: 1, totalPages: {{ ((total_running - 1) // 5) + 1 if total_running > 0 else 1 }} },
                            completed: { page: 1, totalPages: {{ ((total_completed - 1) // 5) + 1 if total_completed > 0 else 1 }} },
                            stopped: { page: 1, totalPages: {{ ((total_stopped - 1) // 5) + 1 if total_stopped > 0 else 1 }} }
                        };
                        
                        // Async pagination for running experiments
                        async function paginateRunning(direction) {
                            const newPage = paginationState.running.page + direction;
                            if (newPage < 1 || newPage > paginationState.running.totalPages) return;
                            
                            try {
                                const response = await fetch(`/admin/dashboard/experiments/running?page=${newPage}&per_page=5`);
                                const data = await response.json();
                                
                                if (data.experiments) {
                                    paginationState.running.page = newPage;
                                    paginationState.running.totalPages = data.total_pages;
                                    
                                    const container = document.getElementById('running-experiments-container');
                                    const html = data.experiments.map(exp => renderExperimentBoxFromData(exp, '#28a745', {}, false, false)).join('');
                                    container.innerHTML = html || '<p style="color: #666; text-align: center;">No experiments</p>';
                                    
                                    // Update pagination buttons
                                    document.getElementById('running-prev').disabled = newPage <= 1;
                                    document.getElementById('running-next').disabled = newPage >= data.total_pages;
                                    document.getElementById('running-page-info').textContent = `Page ${newPage} of ${data.total_pages}`;
                                }
                            } catch (error) {
                                console.error('Error paginating running experiments:', error);
                            }
                        }
                        
                        // Async pagination for completed experiments
                        async function paginateCompleted(direction) {
                            const newPage = paginationState.completed.page + direction;
                            if (newPage < 1 || newPage > paginationState.completed.totalPages) return;
                            
                            try {
                                const response = await fetch(`/admin/dashboard/experiments/completed?page=${newPage}&per_page=5`);
                                const data = await response.json();
                                
                                if (data.experiments) {
                                    paginationState.completed.page = newPage;
                                    paginationState.completed.totalPages = data.total_pages;
                                    
                                    const container = document.getElementById('completed-experiments-container');
                                    const html = data.experiments.map(exp => renderCompactExperimentBoxFromData(exp, '#17a2b8')).join('');
                                    container.innerHTML = html || '<p style="color: #666; text-align: center;">No experiments</p>';
                                    
                                    // Update pagination buttons
                                    document.getElementById('completed-prev').disabled = newPage <= 1;
                                    document.getElementById('completed-next').disabled = newPage >= data.total_pages;
                                    document.getElementById('completed-page-info').textContent = `${newPage}/${data.total_pages}`;
                                }
                            } catch (error) {
                                console.error('Error paginating completed experiments:', error);
                            }
                        }
                        
                        // Async pagination for stopped experiments
                        async function paginateStopped(direction) {
                            const newPage = paginationState.stopped.page + direction;
                            if (newPage < 1 || newPage > paginationState.stopped.totalPages) return;
                            
                            try {
                                const response = await fetch(`/admin/dashboard/experiments/stopped?page=${newPage}&per_page=5`);
                                const data = await response.json();
                                
                                if (data.experiments) {
                                    paginationState.stopped.page = newPage;
                                    paginationState.stopped.totalPages = data.total_pages;
                                    
                                    const container = document.getElementById('stopped-experiments-container');
                                    const html = data.experiments.map(exp => renderCompactExperimentBoxFromData(exp, '#6c757d')).join('');
                                    container.innerHTML = html || '<p style="color: #666; text-align: center;">No experiments</p>';
                                    
                                    // Update pagination buttons
                                    document.getElementById('stopped-prev').disabled = newPage <= 1;
                                    document.getElementById('stopped-next').disabled = newPage >= data.total_pages;
                                    document.getElementById('stopped-page-info').textContent = `${newPage}/${data.total_pages}`;
                                }
                            } catch (error) {
                                console.error('Error paginating stopped experiments:', error);
                            }
                        }
                        
                        // Start periodic async refresh
                        setInterval(refreshDashboardAsync, DASHBOARD_REFRESH_INTERVAL);
                    </script>
                    {% endif %}


                </div>


                <!--Dashboard column-->
                <div class="column is-4">
                    <!--Dashboard box-->

                    <div class="dashboard-box is-compact">
                        <h3 class="title is-5 is-thin">Quick Reference Guide</h3>
                        <div class="help-block">
                            <p>
                                <b>Running a YSocial Experiment</b><br>
                                Follow these steps to set up and run a simulation:
                            </p>
                            <hr>
                            <p>
                                <b>1. Create one or more Agent Populations</b><br>
                                Define one or more <a href="/admin/populations">Agent Populations</a>.
                            </p>
                            <hr>
                            <p>
                                <b>2. Add Agents/Pages to an existing population</b><br>
                                Create ad-hoc synthetic <a href="/admin/agents">agents</a> or <a href="/admin/pages">pages</a> and add them to an existing population.
                            </p>
                            <hr>
                            <p>
                                <b>3. Create an Experiment</b><br>
                                Describe your simulation with an <a href="/admin/experiments">Experiment</a>.
                            </p>
                            <hr>
                            <p>
                                <b>4. Configure one or more Clients</b><br>
                                Create and configure one or more clients for the experiment. Each client manages a population.
                            </p>
                            <hr>
                            <p>
                                <b>5. Run the Simulation</b><br>
                                Start the experiment and run the clients to begin your simulation.
                            </p>
                            <hr>
                            <div style="text-align: center; padding-top: 5px;">
                                <button onclick="showTutorialWizard()" style="
                                    background: linear-gradient(135deg, #039be5 0%, #00bcd4 100%);
                                    border: none;
                                    color: white;
                                    padding: 10px 20px;
                                    border-radius: 8px;
                                    font-size: 0.9em;
                                    font-weight: 500;
                                    cursor: pointer;
                                    transition: transform 0.2s, box-shadow 0.2s;
                                    box-shadow: 0 4px 12px rgba(3, 155, 229, 0.3);
                                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(3, 155, 229, 0.4)';"
                                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(3, 155, 229, 0.3)';">
                                    <i class="mdi mdi-school"></i> Show Tutorial
                                </button>
                            </div>
                        </div>
                    </div>

                </div>

            </div>

            <div class="columns">
                    {% if llm_backend['backend'] is not none %}
                    <div class="column is-4">
                        <div class="dashboard-box" style="height: 100%;">
                        <h3 class="title is-5 is-thin">Services</h3>
                        <hr>
                        <div class="box-content">
                            <div class="box-lines">
                                <h4 class="title is-6 is-thin">Self-hosted LLM instance ({{ llm_backend['backend']|upper }})</h4>
                                {% if llm_backend.get('url') %}
                                <div class="box-line">
                                    <span class="left">URL</span>
                                    <span class="right"><small><code>{{ llm_backend['url'] }}</code></small></span>
                                </div>
                                {% endif %}
                                <div class="box-line">
                                    <span class="left">Installed</span>
                                    <span class="right">  <i class="mdi mdi-checkbox-blank-circle {% if llm_backend['installed'] %} active {% endif %}" style="font-size: 20px;"></i> </span>
                                </div>
                                <div class="box-line">
                                    <span class="left">Running</span>
                                    <span class="right"> <i class="mdi mdi-checkbox-blank-circle {% if llm_backend['status'] %} active {% endif %}" style="font-size: 20px;"></i></span>
                                </div>
                                {% if llm_backend['backend'] == 'ollama' and not llm_backend['status'] %}
                                <div class="box-line">
                                    <span class="left">Start Ollama</span>
                                    <span class="right">
                                        <a class="link-tooltip" {% if not llm_backend['status'] %} href="/admin/start_ollama/" {% endif %} title="Run">
                                            <i class="mdi mdi-play-box-outline {% if not llm_backend['status'] %} active {% endif %}" style="font-size: 24px;"></i>
                                        </a>
                                    </span>
                                </div>
                                {% endif %}
                                {% if llm_backend['backend'] == 'vllm' and not llm_backend['status'] %}
                                <div class="box-line">
                                    <span class="left" style="font-size: 0.9em;">vLLM server not running. Start manually:<br>
                                    <small><code>vllm serve &lt;model&gt; --host 0.0.0.0 --port 8000</code></small>
                                    </span>
                                </div>
                                {% endif %}
                            </div>


                        </div>
                        <hr>
                        <div class="box-content">
                            <div class="box-lines">
                                <h4 class="title is-6 is-thin">Database Management System</h4>
                                <div class="box-line">
                                    <span class="left">{{ dbtype }} {%if db_server %} <small>({{ db_server }}:{{dbport}})</small> {% endif %}</span>
                                    <span class="right">  <i class="mdi mdi-checkbox-blank-circle {% if db_conn %} active {% endif %}" style="font-size: 20px;"></i> </span>
                                </div>
                            </div>


                        </div>
                    </div>
                    </div>
                    {% endif %}

                    {% if llm_backend["status"] and llm_backend["installed"] %}
                    <div class="column is-4">
                        {% if len(models) > 0 %}
                        <div class="dashboard-box" style="height: 100%;">
                            <h3 class="title is-5 is-thin">Available LLMs</h3>

                            <div class="box-content">
                                <div id="models-table"></div>

                                <script src="{{ url_for('static', filename='assets/vendor/js/gridjs.umd.js') }}"></script>

                                <style>
                                  #models-table td {
                                    vertical-align: middle !important;
                                  }
                                </style>

                                <script>
                                    const modelsTableDiv = document.getElementById('models-table');

                                    const updateUrl = (prev, query) => {
                                        return prev + (prev.indexOf('?') >= 0 ? '&' : '?') + new URLSearchParams(query).toString();
                                    };

                                    new gridjs.Grid({
                                        columns: [
                                            { id: 'model_name', name: 'Model Name', sort: true },
                                            {
                                                id: 'actions',
                                                name: 'Actions',
                                                sort: false,
                                                formatter: (cell, row) => {
                                                    const modelName = row.cells[0].data;
                                                    const backend = '{{ llm_backend["backend"] }}';

                                                    // Only show delete button for Ollama backend
                                                    if (backend === 'ollama') {
                                                        return gridjs.html(`
                                                            <div style="display: flex; gap: 8px; justify-content: center;">
                                                                <a href="/admin/delete_model/${encodeURIComponent(modelName)}"
                                                                   style="background-color: #dc3545; color: white; padding: 6px 12px; border-radius: 4px; text-decoration: none; font-size: 0.85rem;">
                                                                    Delete
                                                                </a>
                                                            </div>
                                                        `);
                                                    } else {
                                                        return gridjs.html(`<div style="text-align: center;">-</div>`);
                                                    }
                                                }
                                            },
                                        ],
                                        server: {
                                            url: '/admin/models_data',
                                            then: results => results.data,
                                            total: results => results.total,
                                        },
                                        search: {
                                            enabled: true,
                                            server: {
                                                url: (prev, search) => {
                                                    return updateUrl(prev, { search });
                                                },
                                            },
                                        },
                                        sort: {
                                            enabled: true,
                                            multiColumn: false,
                                            server: {
                                                url: (prev, columns) => {
                                                    const columnIds = ['model_name'];
                                                    const sort = columns.map(col => (col.direction === 1 ? '+' : '-') + columnIds[col.index]);
                                                    return updateUrl(prev, { sort });
                                                },
                                            },
                                        },
                                        pagination: {
                                            enabled: true,
                                            limit: 4,
                                            server: {
                                                url: (prev, page, limit) => {
                                                    return updateUrl(prev, { start: page * limit, length: limit });
                                                },
                                            },
                                        },
                                    }).render(modelsTableDiv);
                                </script>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <div class="column is-4">
                         {% if llm_backend['backend'] == 'ollama' %}
                        <div class="dashboard-box" style="height: 100%;">
                            <h3 class="title is-5 is-thin">Add LLM Model</h3>
                             <div class="box-content">
                                <div class="box-lines">
                                     <div class="box-line">
                                        <span class="left">
                                            If the model you want to use is not available, you can pull it from the Ollama server.
                                            For a list of available models refer to the <a href="https://ollama.com/search">Ollama directory</a>.
                                        </span>
                                     </div>
                                </div>
                             </div>

                            <hr>

                            <div class="box-content">
                                <form action="/admin/ollama_pull" enctype="multipart/form-data" method="POST">
                                <div class="box-lines">
                                    <div class="box-line">
                                        <span class="left">Model Name</span>
                                        <span class="right">
                                            <input type="text" name="model_name" class="input" value="">
                                        </span>
                                    </div>
                                     <div class="box-line">
                                        <span class="left"></span>
                                        <span class="right">

                                        <div class="button-wrap">
                                        <button class="button is-solid primary-button is-fullwidth">
                                            Download Model
                                        </button>
                                    </div>
                                        </span>
                                    </div>
                                </div>
                                 <div class="box-lines">
                                    {% for pull in active_pulls %}

                                    {% if pull[1] < 1 %}
                                    <div class="box-line">
                                    <span class="left" id="model_pull_name_{{ pull[0] }}">
                                        {{ pull[0] }}
                                    </span>
                                     <span class="right" style="height: 22px; width: 70%;">
                                    <div class="progress" style="height: 22px; width: 100%;" >
                                        <div id="pull-progress-bar_{{ pull[0] }}" class="progress-bar progress-bar-striped progress_exp" role="progressbar"
                                             aria-valuenow="{{ pull[1] }}" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
                                            {{ pull[1] }}%
                                        </div>
                                    </div>
                                     </span>
                                        <span class="right" style="height: 22px; width: 10%;">
                                            <a href="/admin/ollama_cancel_pull/{{ pull[0] }}" title="Delete">
                                            <i class="mdi mdi-delete" style="font-size: 20px;"></i>
                                        </a>
                                        </span>
                                    </div>
                                    {% endif %}

                                     <script>
                                            $(document).ready(function () {
                                                        // Start the background progress as soon as the page loads
                                                        $.ajax({
                                                            url: `/admin/pull_progress/{{ pull[0] }}`,
                                                            method: 'GET'
                                                        });

                                                        // Poll progress updates
                                                        function pullProgress() {
                                                            $.ajax({
                                                                url: '/admin/pull_progress/{{ pull[0] }}',
                                                                method: 'GET',
                                                                dataType: 'json',
                                                                success: function (data) {
                                                                    const model_name  = data.model_name;
                                                                    const percentage = data.progress;
                                                                    const progressBar = $('#pull-progress-bar_{{ pull[0] }}');

                                                                    const textContainer = document.getElementById('model_pull_name_{{ pull[0] }}');
                                                                    textContainer.textContent = model_name;

                                                                    // Update the progress bar width and text
                                                                    progressBar.css('width', percentage + '%');
                                                                    progressBar.text(percentage + '%');

                                                                    // If progress is less than 100, keep polling
                                                                    if (percentage < 100) {
                                                                        setTimeout(pullProgress, 500);
                                                                    }
                                                                }
                                                            });
                                                        }

                                                        // Start polling immediately
                                                        pullProgress();
                                                    });

                                        </script>

                                    {% endfor %}

                                </div>
                                </form>



                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
            </div>
        </div>
    </div>

</div>

<!-- Floating Database Status Indicator (only shown when no LLM backend is configured) -->
{% if llm_backend['backend'] is none %}
<div style="position: fixed; bottom: 20px; right: 20px; z-index: 1000; background: rgba(255, 255, 255, 0.95); border-radius: 8px; padding: 10px 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); backdrop-filter: blur(10px); border: 1px solid rgba(0,0,0,0.1);">
    <div style="display: flex; align-items: center; gap: 10px;">
        <i class="mdi mdi-database" style="font-size: 18px; color: #555;"></i>
        <span style="font-size: 0.9em; color: #333; font-weight: 500;">{{ dbtype }}</span>
        {% if db_server %}
        <span style="font-size: 0.8em; color: #666;">({{ db_server }}:{{ dbport }})</span>
        {% endif %}
        <i class="mdi mdi-checkbox-blank-circle {% if db_conn %} active {% endif %}" style="font-size: 16px;"></i>
    </div>
</div>
{% endif %}

<script>
    // Experiment server control functions
    function startExperimentServer(expId) {
        showLoading('Starting experiment server...');
        window.location.href = `/admin/start_experiment/${expId}`;
    }

    function stopExperimentServer(expId) {
        showLoading('Stopping experiment server...');
        window.location.href = `/admin/stop_experiment/${expId}`;
    }

    function selectExperiment(expId) {
        showLoading('Loading experiment interface...');
        window.location.href = `/admin/select_experiment/${expId}`;
    }

    function joinExperiment(expId) {
        showLoading('Joining experiment...');
        window.location.href = `/admin/join_experiment/${expId}`;
    }
</script>

{% if show_telemetry_notice %}
<!-- Telemetry Information Overlay -->
<div id="telemetry-overlay" style="
    position: fixed;
    bottom: 15px;
    left: 50%;
    transform: translateX(-50%);
    max-width: 600px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 6px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.12);
    z-index: 10000;
    padding: 12px 16px;
    font-family: 'Roboto', sans-serif;
">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
        <h4 style="margin: 0; font-size: 0.85em; color: #666; font-weight: 600;">
            <i class="mdi mdi-information" style="color: #039be5; font-size: 1em;"></i> 
            Telemetry Information
        </h4>
        <button onclick="dismissTelemetryNotice()" style="
            background: none;
            border: none;
            font-size: 1.3em;
            color: #999;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            margin-left: 10px;
        ">&times;</button>
    </div>
    
    <div style="color: #777; font-size: 0.8em; line-height: 1.4;">
        <p style="margin: 0 0 6px 0;">
            YSocial collects anonymous usage data to improve the platform. This includes feature usage patterns and error reports, but <strong>never</strong> your experiment data, personal information, or sensitive content.
        </p>
        
        <p style="margin: 0 0 6px 0;">
            All telemetry data is GDPR compliant. You can disable it anytime from the application
            <a href="/admin/miscellanea" style="color: #039be5; text-decoration: none; border-bottom: 1px solid #039be5;">settings</a>.
        </p>
        
        <div style="margin-top: 8px; text-align: right;">
            <button onclick="dismissTelemetryNotice()" style="
                background: #039be5;
                color: white;
                border: none;
                padding: 5px 14px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 0.8em;
                font-weight: 500;
            ">Got it</button>
        </div>
    </div>
</div>

<script>
function dismissTelemetryNotice() {
    fetch('/admin/dismiss_telemetry_notice', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    }).then(() => {
        document.getElementById('telemetry-overlay').style.display = 'none';
    });
}
</script>
{% endif %}

{% include "admin/tutorial_overlay.html" %}

{% include "admin/footer.html" %}
