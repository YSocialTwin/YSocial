{% include "admin/head.html" %}

<div class="view-wrapper is-dashboard">
    <!--Dashboard container-->

    <div id="creator-dashboard" class="dashboard-container">
        <!--Toolbar-->

        {% include "admin/dash_head.html" %}

        <div class="dashboard-body">
            <div class="columns">
                     <!--Dashboard column-->

                <div class="column is-8">

                    {% for message in get_flashed_messages() %}
                    <div class="alert alert-warning">
                        <button type="button" class="close" data-dismiss="alert">&times;</button>
                        {{ message }}
                    </div>
                    {% endfor %}

                    <!--Dashboard box-->
                    {% if len(experiments) > 0 and (llm_backend["status"] and llm_backend["installed"]) %}
                    <div class="dashboard-box">
                         <h3 class="title is-5 is-thin">Experiment Dashboard</h3>
                         <p style="font-size: 0.9em; color: #666; margin-bottom: 1em;">
                            Active experiments and their running clients with real-time progress monitoring.
                        </p>
                        
                        {% for exp in experiments %}
                        <div class="box-content" style="background: #fafafa; border: 1px solid #e6e6e6; border-radius: 8px; padding-left: 15px; padding-right: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.06);">
                            <div class="box-lines">
                                <div class="box-line" style="padding-bottom: 5px; margin-bottom: 5px;">
                                    <span class="left" style="display: flex; align-items: center; gap: 10px;">
                                        Experiment: <a href="/admin/experiment_details/{{ experiments[exp]['experiment'].idexp }}" style="font-size: 1.1em; color: #039be5; text-decoration: none;">{{ experiments[exp]['experiment'].exp_name }}</a>
                                       <!-- {% if jupyter_by_exp.get(experiments[exp]['experiment'].idexp) %}
                                        <span style="display: inline-flex; align-items: center; gap: 5px; font-size: 0.85em; color: #666;">
                                            <i class="mdi mdi-flask" style="font-size: 16px;"></i>
                                            {% if jupyter_by_exp[experiments[exp]['experiment'].idexp]['running'] %}
                                            <span style="color: #28a745; font-weight: 500;">Lab Active</span>
                                            {% else %}
                                            <span style="color: #dc3545; font-weight: 500;">Lab Inactive</span>
                                            {% endif %}
                                        </span>
                                        {% endif %} -->
                                    </span>
                                    <span class="right" style="display: flex; gap: 8px; align-items: center;">
                                        <div style="display: flex; gap: 3px; padding-right: 8px; border-right: 1px solid #ddd;">
                                            {% if experiments[exp]['experiment'].running == 0 %}
                                            <a class="link-tooltip" href="/admin/start_experiment/{{ experiments[exp]['experiment'].idexp }}" title="Run Experiment">
                                                <i class="mdi mdi-play-box-outline" style="font-size: 24px;"></i>
                                            </a>
                                            {% endif %}
                                            {% if experiments[exp]['experiment'].running == 1 %}
                                            <a class="link-tooltip" href="/admin/stop_experiment/{{ experiments[exp]['experiment'].idexp }}" title="Stop Experiment">
                                                <i class="mdi mdi-stop active" style="font-size: 24px;"></i>
                                            </a>
                                            {% endif %}
                                            <a class="link-tooltip" href="/admin/select_experiment/{{ experiments[exp]['experiment'].idexp }}" title="Load Experiment">
                                                <i class="mdi mdi-select-all {% if experiments[exp]['experiment'].status == 1 %}active{%endif%}" style="font-size: 24px;"></i>
                                            </a>
                                            {% if experiments[exp]['experiment'].status == 1 %}
                                            <a class="link-tooltip" href="/admin/join_simulation" title="Join Simulation">
                                                <i class="mdi mdi-plus-box" style="font-size: 24px;"></i>
                                            </a>
                                            {% endif %}
                                            {% if experiments[exp]['experiment'].status == 0 %}
                                            <a class="link-tooltip" href="/admin/delete_simulation/{{ experiments[exp]['experiment'].idexp }}" title="Delete Experiment">
                                                <i class="mdi mdi-delete" style="font-size: 24px;"></i>
                                            </a>
                                            {% endif %}
                                        </div>
                                        {% if jupyter_by_exp.get(experiments[exp]['experiment'].idexp) %}
                                        <div style="display: flex; gap: 3px;">
                                            {% if jupyter_by_exp[experiments[exp]['experiment'].idexp]['running'] %}
                                            <a class="link-tooltip" href="#" onclick="stopJupyterSession('{{ experiments[exp]['experiment'].idexp }}'); return false;" title="Stop JupyterLab">
                                                <i class="mdi mdi-flask-empty-outline" style="font-size: 24px; color: #dc3545;"></i>
                                            </a>
                                            <a class="link-tooltip" href="/admin/lab/{{ experiments[exp]['experiment'].idexp }}" target="_blank" title="Open JupyterLab">
                                                <i class="mdi mdi-open-in-new" style="font-size: 24px; color: #039be5;"></i>
                                            </a>
                                            {% else %}
                                            <a class="link-tooltip" href="#" onclick="startJupyterSession('{{ experiments[exp]['experiment'].idexp }}'); return false;" title="Start JupyterLab">
                                                <i class="mdi mdi-flask-outline" style="font-size: 24px; color: #039be5;"></i>
                                            </a>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                    </span>
                                </div>
                                
                                {% if len(experiments[exp]["clients"]) > 0 %}
                                <hr style="border-top: 2px solid #e6e6e6; margin-top: 0px; padding-top: 0px; margin-bottom: 0px;">
                                {% for client in experiments[exp]["clients"] %}
                                <div class="box-line" style="padding-left: 20px; padding-top: 8px; padding-bottom: 8px;  ">
                                    <span class="left" style="font-size: 0.9em; display: flex; align-items: center; gap: 5px;">Client:
                                        <i class="mdi mdi-account-cog" style="font-size: 16px; color: #7f8c8d;"></i>
                                        <a href="/admin/client_details/{{client[0].id}}">{{ client[0].name }}</a>
                                    </span>
                                    <span class="right" style="width: 55%; display: flex; align-items: center; gap: 10px;">
                                        <div class="sleek-progress-container" style="flex: 1; position: relative; background: linear-gradient(to right, #f5f5f5 0%, #e8e8e8 100%); border-radius: 20px; height: 24px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.08);">
                                            <div id="progress-bar-{{client[0].id}}" class="sleek-progress-bar" 
                                                 style="position: absolute; left: 0; top: 0; height: 100%; width: 0%; background: linear-gradient(90deg, #039be5 0%, #4facfe 100%); border-radius: 20px; transition: width 0.4s ease-in-out, background 0.3s ease; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 6px rgba(3,155,229,0.3);">
                                                <span style="font-size: 0.75em; font-weight: 600; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">0%</span>
                                            </div>
                                        </div>
                                        <div style="display: flex; gap: 3px;">
                                            {% if client[0].status == 0 and experiments[exp]['experiment'].running == 1 %}
                                                {% if client[1] != -1 %}
                                                    {% if client[1].elapsed_time == 0 %}
                                                    <a class="link-tooltip" href="/admin/run_client/{{ client[0].id }}/{{ client[0].id_exp }}" title="Run Client">
                                                        <i class="mdi mdi-play-box-outline" style="font-size: 20px;"></i>
                                                    </a>
                                                    {% elif client[1].elapsed_time > 0 and client[1].elapsed_time < client[1].expected_duration_rounds %}
                                                    <a class="link-tooltip" href="/admin/resume_client/{{ client[0].id }}/{{ client[0].id_exp }}" title="Resume Client">
                                                        <i class="mdi mdi-play-box-outline" style="font-size: 20px;"></i>
                                                    </a>
                                                    {% endif %}
                                                {% else %}
                                                <a class="link-tooltip" href="/admin/run_client/{{ client[0].id }}/{{ client[0].id_exp }}" title="Run Client">
                                                    <i class="mdi mdi-play-box-outline" style="font-size: 20px;"></i>
                                                </a>
                                                {% endif %}
                                            {% endif %}
                                            {% if client[0].status == 1 %}
                                            <a class="link-tooltip" href="/admin/pause_client/{{ client[0].id }}/{{ client[0].id_exp }}" title="Pause Client">
                                                <i class="mdi mdi-pause active" style="font-size: 20px;"></i>
                                            </a>
                                            {% endif %}
                                            {% if client[0].status == 0 %}
                                            <a class="link-tooltip" href="/admin/delete_client/{{ client[0].id }}" title="Delete Client">
                                                <i class="mdi mdi-delete" style="font-size: 20px;"></i>
                                            </a>
                                            {% endif %}
                                        </div>
                                    </span>
                                </div>
                                
                                <script>
                                    $(document).ready(function () {
                                        $.ajax({
                                            url: `/admin/progress/{{client[0].id}}`,
                                            method: 'GET'
                                        });

                                        function pollProgress() {
                                            $.ajax({
                                                url: '/admin/progress/{{client[0].id}}',
                                                method: 'GET',
                                                dataType: 'json',
                                                success: function (data) {
                                                    const percentage = data.progress;
                                                    const progressBar = $('#progress-bar-{{client[0].id}}');
                                                    progressBar.css('width', percentage + '%');
                                                    progressBar.find('span').text(percentage + '%');
                                                    
                                                    // Update gradient based on progress - aligned with template colors
                                                    if (percentage >= 75) {
                                                        progressBar.css('background', 'linear-gradient(90deg, #039be5 0%, #00d1b2 100%)');
                                                        progressBar.css('box-shadow', '0 2px 6px rgba(0,209,178,0.3)');
                                                    } else if (percentage >= 50) {
                                                        progressBar.css('background', 'linear-gradient(90deg, #039be5 0%, #5596e6 100%)');
                                                        progressBar.css('box-shadow', '0 2px 6px rgba(85,150,230,0.3)');
                                                    }
                                                    
                                                    if (percentage < 100) {
                                                        setTimeout(pollProgress, 500);
                                                    }
                                                }
                                            });
                                        }
                                        pollProgress();
                                    });
                                </script>
                                {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}

                    </div>
                     {% else %}

                    <div class="dashboard-box">
                        <div class="box-content">
                            <img src="{{ url_for('static', filename='assets/img/robots/header3.jpg') }}" style="border-radius: 10px; filter: saturate(1); opacity: 0.6;">

                        </div>
                    </div>
                    {% endif %}

                    {% if len(experiments) > 0 and (llm_backend["status"] and llm_backend["installed"]) %}
                    <script>
                        function startJupyterSession(expId) {
                            fetch(`/admin/lab_start/${expId}`)
                                .then(response => response.json())
                                .then(data => {
                                    location.reload();
                                })
                                .catch(error => {
                                    console.error('Error starting JupyterLab:', error);
                                    location.reload();
                                });
                        }

                        function stopJupyterSession(expId) {
                            fetch(`/admin/lab_stop/${expId}`)
                                .then(response => response.json())
                                .then(data => {
                                    location.reload();
                                })
                                .catch(error => {
                                    console.error('Error stopping JupyterLab:', error);
                                    location.reload();
                                });
                        }
                    </script>
                    {% endif %}

                    <div class="dashboard-box">
                        <div class="box-content">
                            <h3 class="title is-5 is-thin">Guide</h3>
                            <div class="box-lines">
                                <div class="box-line">
                                    <span class="left" style="width: 75%">
                                        <h4 class="title is-6 is-thin">Running an Y Social Experiment requires a few steps:</h4>

                                        Start the Ollama server
                                        <hr>
                                         Create an <a href="http://localhost:8080/admin/experiments">Experiment</a>
                                        <hr>
                                        Create one or more <a href="http://localhost:8080/admin/populations">Agent Populations</a> and assign them to the experiment
                                        <hr>
                                        Create one or more ad-hoc synthetic <a href="http://localhost:8080/admin/agents">agents</a>/<a href="http://localhost:8080/admin/pages">pages</a> and add them to an existing population <small>(optional)</small>
                                        <hr>
                                        Create and configure one or more clients for the experiment <small>(each managing a population)</small>
                                        <hr>
                                        Start the experiment server and run the clients

                                        </ul>
                                    </span>
                                    <span class="right" style="width: 25%; padding-left: 10px;">
                                        <img src="{{ url_for('static', filename='assets/img/robots/robot_v.png') }}" style="border-radius: 10px; filter: saturate(1); opacity: 0.6;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>



                <!--Dashboard column-->
                <div class="column is-4">
                    <!--Dashboard box-->
                    <div class="dashboard-box">
                        <h3 class="title is-5 is-thin">Services</h3>
                        <hr>
                        <div class="box-content">
                            <div class="box-lines">
                                <h4 class="title is-6 is-thin">Self-hosted LLM instance ({{ llm_backend['backend']|upper }})</h4>
                                {% if llm_backend.get('url') %}
                                <div class="box-line">
                                    <span class="left">URL</span>
                                    <span class="right"><small><code>{{ llm_backend['url'] }}</code></small></span>
                                </div>
                                {% endif %}
                                <div class="box-line">
                                    <span class="left">Installed</span>
                                    <span class="right">  <i class="mdi mdi-checkbox-blank-circle {% if llm_backend['installed'] %} active {% endif %}" style="font-size: 20px;"></i> </span>
                                </div>
                                <div class="box-line">
                                    <span class="left">Running</span>
                                    <span class="right"> <i class="mdi mdi-checkbox-blank-circle {% if llm_backend['status'] %} active {% endif %}" style="font-size: 20px;"></i></span>
                                </div>
                                {% if llm_backend['backend'] == 'ollama' and not llm_backend['status'] %}
                                <div class="box-line">
                                    <span class="left">Start Ollama</span>
                                    <span class="right">
                                        <a class="link-tooltip" {% if not llm_backend['status'] %} href="/admin/start_ollama/" {% endif %} title="Run">
                                            <i class="mdi mdi-play-box-outline {% if not llm_backend['status'] %} active {% endif %}" style="font-size: 24px;"></i>
                                        </a>
                                    </span>
                                </div>
                                {% endif %}
                                {% if llm_backend['backend'] == 'vllm' and not llm_backend['status'] %}
                                <div class="box-line">
                                    <span class="left" style="font-size: 0.9em;">vLLM server not running. Start manually:<br>
                                    <small><code>vllm serve &lt;model&gt; --host 0.0.0.0 --port 8000</code></small>
                                    </span>
                                </div>
                                {% endif %}
                            </div>


                        </div>
                        <hr>
                        <div class="box-content">
                            <div class="box-lines">
                                <h4 class="title is-6 is-thin">Database Management System</h4>
                                <div class="box-line">
                                    <span class="left">{{ dbtype }} {%if db_server %} <small>({{ db_server }}:{{dbport}})</small> {% endif %}</span>
                                    <span class="right">  <i class="mdi mdi-checkbox-blank-circle {% if db_conn %} active {% endif %}" style="font-size: 20px;"></i> </span>
                                </div>
                            </div>


                        </div>
                    </div>

                    {% if llm_backend["status"] and llm_backend["installed"] %}


                    {% if len(models) > 0 %}
                    <div class="dashboard-box">
                        <h3 class="title is-5 is-thin">Available LLMs</h3>

                        <div class="box-content">
                            <div id="models-table"></div>

                            <script src="{{ url_for('static', filename='assets/vendor/js/gridjs.umd.js') }}"></script>

                            <style>
                              #models-table td {
                                vertical-align: middle !important;
                              }
                            </style>

                            <script>
                                const modelsTableDiv = document.getElementById('models-table');

                                const updateUrl = (prev, query) => {
                                    return prev + (prev.indexOf('?') >= 0 ? '&' : '?') + new URLSearchParams(query).toString();
                                };

                                new gridjs.Grid({
                                    columns: [
                                        { id: 'model_name', name: 'Model Name', sort: true },
                                        {
                                            id: 'actions',
                                            name: 'Actions',
                                            sort: false,
                                            formatter: (cell, row) => {
                                                const modelName = row.cells[0].data;
                                                const backend = '{{ llm_backend["backend"] }}';
                                                
                                                // Only show delete button for Ollama backend
                                                if (backend === 'ollama') {
                                                    return gridjs.html(`
                                                        <div style="display: flex; gap: 8px; justify-content: center;">
                                                            <a href="/admin/delete_model/${encodeURIComponent(modelName)}"
                                                               style="background-color: #dc3545; color: white; padding: 6px 12px; border-radius: 4px; text-decoration: none; font-size: 0.85rem;">
                                                                Delete
                                                            </a>
                                                        </div>
                                                    `);
                                                } else {
                                                    return gridjs.html(`<div style="text-align: center;">-</div>`);
                                                }
                                            }
                                        },
                                    ],
                                    server: {
                                        url: '/admin/models_data',
                                        then: results => results.data,
                                        total: results => results.total,
                                    },
                                    search: {
                                        enabled: true,
                                        server: {
                                            url: (prev, search) => {
                                                return updateUrl(prev, { search });
                                            },
                                        },
                                    },
                                    sort: {
                                        enabled: true,
                                        multiColumn: false,
                                        server: {
                                            url: (prev, columns) => {
                                                const columnIds = ['model_name'];
                                                const sort = columns.map(col => (col.direction === 1 ? '+' : '-') + columnIds[col.index]);
                                                return updateUrl(prev, { sort });
                                            },
                                        },
                                    },
                                    pagination: {
                                        enabled: true,
                                        limit: 4,
                                        server: {
                                            url: (prev, page, limit) => {
                                                return updateUrl(prev, { start: page * limit, length: limit });
                                            },
                                        },
                                    },
                                }).render(modelsTableDiv);
                            </script>
                        </div>
                    </div>
                    {% endif %}

                    {% if llm_backend['backend'] == 'ollama' %}
                    <div class="dashboard-box">
                        <h3 class="title is-5 is-thin">Add LLM Model</h3>
                         <div class="box-content">
                            <div class="box-lines">
                                 <div class="box-line">
                                    <span class="left">
                                        If the model you want to use is not available, you can pull it from the Ollama server.
                                        For a list of available models refer to the <a href="https://ollama.com/search">Ollama directory</a>.
                                    </span>
                                 </div>
                            </div>
                         </div>

                        <hr>

                        <div class="box-content">
                            <form action="/admin/ollama_pull" enctype="multipart/form-data" method="POST">
                            <div class="box-lines">
                                <div class="box-line">
                                    <span class="left">Model Name</span>
                                    <span class="right">
                                        <input type="text" name="model_name" class="input" value="">
                                    </span>
                                </div>
                                 <div class="box-line">
                                    <span class="left"></span>
                                    <span class="right">

                                    <div class="button-wrap">
                                    <button class="button is-solid primary-button is-fullwidth">
                                        Download Model
                                    </button>
                                </div>
                                    </span>
                                </div>
                            </div>
                             <div class="box-lines">
                                {% for pull in active_pulls %}

                                {% if pull[1] < 1 %}
                                <div class="box-line">
                                <span class="left" id="model_pull_name_{{ pull[0] }}">
                                    {{ pull[0] }}
                                </span>
                                 <span class="right" style="height: 22px; width: 70%;">
                                <div class="progress" style="height: 22px; width: 100%;" >
                                    <div id="pull-progress-bar_{{ pull[0] }}" class="progress-bar progress-bar-striped progress_exp" role="progressbar"
                                         aria-valuenow="{{ pull[1] }}" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
                                        {{ pull[1] }}%
                                    </div>
                                </div>
                                 </span>
                                    <span class="right" style="height: 22px; width: 10%;">
                                        <a href="/admin/ollama_cancel_pull/{{ pull[0] }}" title="Delete">
                                        <i class="mdi mdi-delete" style="font-size: 20px;"></i>
                                    </a>
                                    </span>
                                </div>
                                {% endif %}

                                 <script>
                                        $(document).ready(function () {
                                                    // Start the background progress as soon as the page loads
                                                    $.ajax({
                                                        url: `/admin/pull_progress/{{ pull[0] }}`,
                                                        method: 'GET'
                                                    });

                                                    // Poll progress updates
                                                    function pullProgress() {
                                                        $.ajax({
                                                            url: '/admin/pull_progress/{{ pull[0] }}',
                                                            method: 'GET',
                                                            dataType: 'json',
                                                            success: function (data) {
                                                                const model_name  = data.model_name;
                                                                const percentage = data.progress;
                                                                const progressBar = $('#pull-progress-bar_{{ pull[0] }}');

                                                                const textContainer = document.getElementById('model_pull_name_{{ pull[0] }}');
                                                                textContainer.textContent = model_name;

                                                                // Update the progress bar width and text
                                                                progressBar.css('width', percentage + '%');
                                                                progressBar.text(percentage + '%');

                                                                // If progress is less than 100, keep polling
                                                                if (percentage < 100) {
                                                                    setTimeout(pullProgress, 500);
                                                                }
                                                            }
                                                        });
                                                    }

                                                    // Start polling immediately
                                                    pullProgress();
                                                });

                                    </script>

                                {% endfor %}

                            </div>
                            </form>



                        </div>
                    </div>
                    {% endif %}
                    
                    {% endif %}
                </div>

            </div>
        </div>
    </div>

</div>

{% include "admin/footer.html" %}