{% include "admin/head.html" %}

{# Macro for rendering an experiment box #}
{% macro render_experiment_box(experiments, section_color, show_run_buttons=true) %}
    {% for exp in experiments %}
    <div class="box-content" style="background: #fafafa; border: 1px solid #e6e6e6; border-left: 4px solid {{ section_color }}; border-radius: 8px; padding-left: 15px; padding-right: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.06);">
        <div class="box-lines">
            <div class="box-line" style="padding-bottom: 5px; margin-bottom: 5px;">
                <span class="left" style="display: flex; align-items: center; gap: 10px;">
                    Experiment: <strong style="color: #0d95e8">{{ experiments[exp]['experiment'].exp_name }}</strong><a href="/admin/experiment_details/{{ experiments[exp]['experiment'].idexp }}" class="link-tooltip" title="View Experiment Details">
                        <i class="mdi mdi-open-in-new" style="font-size: 16px; color: #039be5;"></i>
                    </a>
                </span>
                <span class="right" style="display: flex; gap: 8px; align-items: center;">
                    <div style="display: flex; gap: 3px; padding-right: 8px; border-right: 1px solid #ddd;">
                        {% if experiments[exp]['experiment'].running == 0 %}
                        <a class="link-tooltip" href="#" onclick="startExperimentServer('{{ experiments[exp]['experiment'].idexp }}'); return false;" title="Run Experiment">
                            <i class="mdi mdi-play-box-outline" style="font-size: 24px;"></i>
                        </a>
                        {% endif %}
                        {% if experiments[exp]['experiment'].running == 1 %}
                        <a class="link-tooltip" href="#" onclick="stopExperimentServer('{{ experiments[exp]['experiment'].idexp }}'); return false;" title="Stop Experiment">
                            <i class="mdi mdi-stop active" style="font-size: 24px;"></i>
                        </a>
                        {% endif %}
                        <a class="link-tooltip" href="#" onclick="selectExperiment('{{ experiments[exp]['experiment'].idexp }}'); return false;" title="Load Experiment">
                            <i class="mdi mdi-select-all {% if experiments[exp]['experiment'].status == 1 %}active{%endif%}" style="font-size: 24px;"></i>
                        </a>
                        {% if experiments[exp]['experiment'].status == 1 %}
                        <a class="link-tooltip" href="#" onclick="joinExperiment('{{ experiments[exp]['experiment'].idexp }}'); return false;" title="Join This Experiment">
                            <i class="mdi mdi-login" style="font-size: 24px;"></i>
                        </a>
                        {% endif %}
                        {% if experiments[exp]['experiment'].status == 0 %}
                        <a class="link-tooltip" href="javascript:void(0);" 
                           onclick="if(confirm('Are you sure you want to delete this experiment? This action cannot be undone.')) { window.location.href='/admin/delete_simulation/{{ experiments[exp]['experiment'].idexp }}'; }" 
                           title="Delete Experiment">
                            <i class="mdi mdi-delete" style="font-size: 24px;"></i>
                        </a>
                        {% endif %}
                    </div>
                    {% if jupyter_by_exp.get(experiments[exp]['experiment'].idexp) %}
                        {% if notebook %}
                        <div style="display: flex; gap: 3px;">
                            {% if jupyter_by_exp[experiments[exp]['experiment'].idexp]['running'] %}
                            <a class="link-tooltip" href="#" onclick="stopJupyterSession('{{ experiments[exp]['experiment'].idexp }}'); return false;" title="Stop JupyterLab">
                                <i class="mdi mdi-flask-empty-outline" style="font-size: 24px; color: #dc3545;"></i>
                            </a>
                            <a class="link-tooltip" href="/admin/lab/{{ experiments[exp]['experiment'].idexp }}" {% if not is_pyinstaller %}target="_blank"{% endif %} title="Open JupyterLab">
                                <i class="mdi mdi-open-in-new" style="font-size: 24px; color: #039be5;"></i>
                            </a>
                            {% else %}
                            <a class="link-tooltip" href="#" onclick="startJupyterSession('{{ experiments[exp]['experiment'].idexp }}'); return false;" title="Start JupyterLab">
                                <i class="mdi mdi-flask-outline" style="font-size: 24px; color: #039be5;"></i>
                            </a>
                            {% endif %}
                        </div>
                        {% endif %}
                    {% endif %}
                </span>
            </div>
            
            {% if len(experiments[exp]["clients"]) > 0 %}
            <hr style="border-top: 2px solid #e6e6e6; margin-top: 0px; padding-top: 0px; margin-bottom: 0px;">
            {% for client in experiments[exp]["clients"] %}
            <div class="box-line" style="padding-left: 20px; padding-top: 8px; padding-bottom: 8px;  ">
                <span class="left" style="font-size: 0.9em; display: flex; align-items: center; gap: 5px;">Client:
                    <i class="mdi mdi-account-cog" style="font-size: 16px; color: #7f8c8d;"></i>
                    <em style="color: #0d95e8">{{ client[0].name }}</em>
                    {% if client[1] != -1 and client[1].elapsed_time > 0 %}
                    <a href="/admin/client_details/{{client[0].id}}" class="link-tooltip" title="View Client Details">
                        <i class="mdi mdi-open-in-new" style="font-size: 16px; color: #039be5;"></i>
                    </a>
                    {% endif %}
                </span>
                <span class="right" style="width: 55%; display: flex; align-items: center; gap: 10px;">
                    <div class="sleek-progress-container" style="flex: 1; position: relative; background: linear-gradient(to right, #f5f5f5 0%, #e8e8e8 100%); border-radius: 20px; height: 24px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.08);">
                        <div id="progress-bar-{{client[0].id}}" class="sleek-progress-bar" 
                             style="position: absolute; left: 0; top: 0; height: 100%; width: 0%; background: linear-gradient(90deg, #039be5 0%, #4facfe 100%); border-radius: 20px; transition: width 0.4s ease-in-out, background 0.3s ease; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 6px rgba(3,155,229,0.3);">
                            <span style="font-size: 0.75em; font-weight: 600; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">0%</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 3px;">
                        {% if client[0].status == 0 and experiments[exp]['experiment'].running == 1 %}
                            {% if client[1] != -1 %}
                                {% if client[1].elapsed_time == 0 %}
                                <a class="link-tooltip" href="/admin/run_client/{{ client[0].id }}/{{ client[0].id_exp }}" title="Run Client">
                                    <i class="mdi mdi-play-box-outline" style="font-size: 20px;"></i>
                                </a>
                                {% elif client[1].elapsed_time > 0 and client[1].elapsed_time < client[1].expected_duration_rounds %}
                                <a class="link-tooltip" href="/admin/resume_client/{{ client[0].id }}/{{ client[0].id_exp }}" title="Resume Client">
                                    <i class="mdi mdi-play-box-outline" style="font-size: 20px;"></i>
                                </a>
                                {% endif %}
                            {% else %}
                            <a class="link-tooltip" href="/admin/run_client/{{ client[0].id }}/{{ client[0].id_exp }}" title="Run Client">
                                <i class="mdi mdi-play-box-outline" style="font-size: 20px;"></i>
                            </a>
                            {% endif %}
                        {% endif %}
                        {% if client[0].status == 1 %}
                        <a class="link-tooltip" href="/admin/pause_client/{{ client[0].id }}/{{ client[0].id_exp }}" title="Pause Client">
                            <i class="mdi mdi-pause active" style="font-size: 20px;"></i>
                        </a>
                        {% endif %}
                        {% if client[0].status == 0 %}
                        <a class="link-tooltip" href="javascript:void(0);" 
                           onclick="if(confirm('Are you sure you want to delete this client? This action cannot be undone.')) { window.location.href='/admin/delete_client/{{ client[0].id }}'; }" 
                           title="Delete Client">
                            <i class="mdi mdi-delete" style="font-size: 20px;"></i>
                        </a>
                        {% endif %}
                    </div>
                </span>
            </div>
            
            <script>
                $(document).ready(function () {
                    $.ajax({
                        url: `/admin/progress/{{client[0].id}}`,
                        method: 'GET'
                    });

                    function pollProgress() {
                        $.ajax({
                            url: '/admin/progress/{{client[0].id}}',
                            method: 'GET',
                            dataType: 'json',
                            success: function (data) {
                                const percentage = data.progress;
                                const progressBar = $('#progress-bar-{{client[0].id}}');
                                progressBar.css('width', percentage + '%');
                                progressBar.find('span').text(percentage + '%');
                                
                                // Update gradient based on progress - aligned with template colors
                                if (percentage >= 75) {
                                    progressBar.css('background', 'linear-gradient(90deg, #039be5 0%, #00d1b2 100%)');
                                    progressBar.css('box-shadow', '0 2px 6px rgba(0,209,178,0.3)');
                                } else if (percentage >= 50) {
                                    progressBar.css('background', 'linear-gradient(90deg, #039be5 0%, #5596e6 100%)');
                                    progressBar.css('box-shadow', '0 2px 6px rgba(85,150,230,0.3)');
                                }
                                
                                if (percentage < 100) {
                                    setTimeout(pollProgress, 500);
                                }
                            }
                        });
                    }
                    pollProgress();
                });
            </script>
            {% endfor %}
            {% endif %}
        </div>
    </div>
    {% endfor %}
{% endmacro %}

<div class="view-wrapper is-dashboard">
    <!--Dashboard container-->

    <div id="creator-dashboard" class="dashboard-container">
        <!--Toolbar-->

        {% include "admin/dash_head.html" %}

        <div class="dashboard-body">
            <div class="columns">
                     <!--Dashboard column-->

                <div class="column is-8">

                    {% for message in get_flashed_messages() %}
                    <div class="alert alert-warning">
                        <button type="button" class="close" data-dismiss="alert">&times;</button>
                        {{ message }}
                    </div>
                    {% endfor %}

                    <!--Dashboard box-->
                    {% if total_experiments > 0 %}
                    
                    <!-- Currently Running Experiments (Active) - Full width -->
                    {% if len(running_experiments) > 0 %}
                    <div class="dashboard-box">
                         <h3 class="title is-5 is-thin" style="display: flex; align-items: center; gap: 10px;">
                            <span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background-color: #28a745;"></span>
                            Currently Running Experiments
                            <span style="font-size: 0.7em; color: #666; font-weight: normal;">({{ len(running_experiments) }} of {{ total_running }})</span>
                         </h3>
                         <p style="font-size: 0.9em; color: #666; margin-bottom: 1em;">
                            Active experiments with their running clients and real-time progress monitoring.
                        </p>
                        <div id="running-experiments-container">
                            {{ render_experiment_box(running_experiments, '#28a745') }}
                        </div>
                        {% if total_running > 5 %}
                        <div style="display: flex; justify-content: center; gap: 10px; margin-top: 10px;">
                            <button id="running-prev" class="button is-small is-light" disabled onclick="paginateRunning(-1)">
                                <i class="mdi mdi-chevron-left"></i> Prev
                            </button>
                            <span id="running-page-info" style="font-size: 0.85em; color: #666; align-self: center;">Page 1 of {{ ((total_running - 1) // 5) + 1 }}</span>
                            <button id="running-next" class="button is-small is-light" onclick="paginateRunning(1)">
                                Next <i class="mdi mdi-chevron-right"></i>
                            </button>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- Completed and Stopped/Scheduled on the same row -->
                    <div class="columns is-multiline" style="margin-bottom: 0;">
                        <!-- Completed Experiments - Half width on desktop -->
                        {% if len(completed_experiments) > 0 %}
                        <div class="column is-6-desktop is-12-tablet is-12-mobile">
                            <div class="dashboard-box" style="height: 100%; margin-bottom: 0;">
                                 <h3 class="title is-6 is-thin" style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <span style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background-color: #17a2b8;"></span>
                                    Completed
                                    <span style="font-size: 0.7em; color: #666; font-weight: normal;">({{ len(completed_experiments) }} of {{ total_completed }})</span>
                                 </h3>
                                 <p style="font-size: 0.8em; color: #666; margin-bottom: 0.8em;">
                                    All clients have reached completion.
                                </p>
                                <div id="completed-experiments-container" style="max-height: 300px; overflow-y: auto;">
                                    {{ render_experiment_box(completed_experiments, '#17a2b8') }}
                                </div>
                                {% if total_completed > 5 %}
                                <div style="display: flex; justify-content: center; gap: 8px; margin-top: 8px;">
                                    <button id="completed-prev" class="button is-small is-light" disabled onclick="paginateCompleted(-1)">
                                        <i class="mdi mdi-chevron-left"></i>
                                    </button>
                                    <span id="completed-page-info" style="font-size: 0.75em; color: #666; align-self: center;">1/{{ ((total_completed - 1) // 5) + 1 }}</span>
                                    <button id="completed-next" class="button is-small is-light" onclick="paginateCompleted(1)">
                                        <i class="mdi mdi-chevron-right"></i>
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Stopped/Scheduled Experiments - Half width on desktop -->
                        {% if len(stopped_experiments) > 0 %}
                        <div class="column is-6-desktop is-12-tablet is-12-mobile">
                            <div class="dashboard-box" style="height: 100%; margin-bottom: 0;">
                                 <h3 class="title is-6 is-thin" style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <span style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background-color: #6c757d;"></span>
                                    Stopped / Scheduled
                                    <span style="font-size: 0.7em; color: #666; font-weight: normal;">({{ len(stopped_experiments) }} of {{ total_stopped }})</span>
                                 </h3>
                                 <p style="font-size: 0.8em; color: #666; margin-bottom: 0.8em;">
                                    Experiments stopped or scheduled to run.
                                </p>
                                <div id="stopped-experiments-container" style="max-height: 300px; overflow-y: auto;">
                                    {{ render_experiment_box(stopped_experiments, '#6c757d') }}
                                </div>
                                {% if total_stopped > 5 %}
                                <div style="display: flex; justify-content: center; gap: 8px; margin-top: 8px;">
                                    <button id="stopped-prev" class="button is-small is-light" disabled onclick="paginateStopped(-1)">
                                        <i class="mdi mdi-chevron-left"></i>
                                    </button>
                                    <span id="stopped-page-info" style="font-size: 0.75em; color: #666; align-self: center;">1/{{ ((total_stopped - 1) // 5) + 1 }}</span>
                                    <button id="stopped-next" class="button is-small is-light" onclick="paginateStopped(1)">
                                        <i class="mdi mdi-chevron-right"></i>
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    {% else %}

                    <div class="dashboard-box">
                        <div class="box-content">
                            <img src="{{ url_for('static', filename='assets/img/robots/header3.jpg') }}" style="border-radius: 10px; filter: saturate(1); opacity: 0.6;">

                        </div>
                    </div>
                    {% endif %}

                    {% if total_experiments > 0 %}
                    <script>
                        function startJupyterSession(expId) {
                            fetch(`/admin/lab_start/${expId}`)
                                .then(response => response.json())
                                .then(data => {
                                    location.reload();
                                })
                                .catch(error => {
                                    console.error('Error starting JupyterLab:', error);
                                    location.reload();
                                });
                        }

                        function stopJupyterSession(expId) {
                            fetch(`/admin/lab_stop/${expId}`)
                                .then(response => response.json())
                                .then(data => {
                                    location.reload();
                                })
                                .catch(error => {
                                    console.error('Error stopping JupyterLab:', error);
                                    location.reload();
                                });
                        }
                        
                        // Dynamic dashboard refresh - update experiment status every 30 seconds
                        const DASHBOARD_REFRESH_INTERVAL = 30000;
                        
                        function refreshDashboard() {
                            // Fetch current experiment counts and update if changed
                            fetch('/admin/dashboard/status')
                                .then(response => response.json())
                                .then(data => {
                                    // Check if counts have changed
                                    const currentRunning = {{ len(running_experiments) }};
                                    const currentCompleted = {{ len(completed_experiments) }};
                                    const currentStopped = {{ len(stopped_experiments) }};
                                    
                                    if (data.running !== currentRunning || 
                                        data.completed !== currentCompleted || 
                                        data.stopped !== currentStopped) {
                                        // Counts changed, reload the page to get fresh data
                                        location.reload();
                                    }
                                })
                                .catch(error => {
                                    console.error('Error refreshing dashboard:', error);
                                });
                        }
                        
                        // Start periodic refresh
                        setInterval(refreshDashboard, DASHBOARD_REFRESH_INTERVAL);
                    </script>
                    {% endif %}


                </div>


                <!--Dashboard column-->
                <div class="column is-4">
                    <!--Dashboard box-->

                    <div class="dashboard-box is-compact">
                        <h3 class="title is-5 is-thin">Quick Reference Guide</h3>
                        <div class="help-block">
                            <p>
                                <b>Running a YSocial Experiment</b><br>
                                Follow these steps to set up and run a simulation:
                            </p>
                            <hr>
                            <p>
                                <b>1. Create one or more Agent Populations</b><br>
                                Define one or more <a href="/admin/populations">Agent Populations</a>.
                            </p>
                            <hr>
                            <p>
                                <b>2. Add Agents/Pages to an existing population</b><br>
                                Create ad-hoc synthetic <a href="/admin/agents">agents</a> or <a href="/admin/pages">pages</a> and add them to an existing population.
                            </p>
                            <hr>
                            <p>
                                <b>3. Create an Experiment</b><br>
                                Describe your simulation with an <a href="/admin/experiments">Experiment</a>.
                            </p>
                            <hr>
                            <p>
                                <b>4. Configure one or more Clients</b><br>
                                Create and configure one or more clients for the experiment. Each client manages a population.
                            </p>
                            <hr>
                            <p>
                                <b>5. Run the Simulation</b><br>
                                Start the experiment and run the clients to begin your simulation.
                            </p>
                        </div>
                    </div>

                </div>

            </div>

            <div class="columns">
                    {% if llm_backend['backend'] is not none %}
                    <div class="column is-4">
                        <div class="dashboard-box" style="height: 100%;">
                        <h3 class="title is-5 is-thin">Services</h3>
                        <hr>
                        <div class="box-content">
                            <div class="box-lines">
                                <h4 class="title is-6 is-thin">Self-hosted LLM instance ({{ llm_backend['backend']|upper }})</h4>
                                {% if llm_backend.get('url') %}
                                <div class="box-line">
                                    <span class="left">URL</span>
                                    <span class="right"><small><code>{{ llm_backend['url'] }}</code></small></span>
                                </div>
                                {% endif %}
                                <div class="box-line">
                                    <span class="left">Installed</span>
                                    <span class="right">  <i class="mdi mdi-checkbox-blank-circle {% if llm_backend['installed'] %} active {% endif %}" style="font-size: 20px;"></i> </span>
                                </div>
                                <div class="box-line">
                                    <span class="left">Running</span>
                                    <span class="right"> <i class="mdi mdi-checkbox-blank-circle {% if llm_backend['status'] %} active {% endif %}" style="font-size: 20px;"></i></span>
                                </div>
                                {% if llm_backend['backend'] == 'ollama' and not llm_backend['status'] %}
                                <div class="box-line">
                                    <span class="left">Start Ollama</span>
                                    <span class="right">
                                        <a class="link-tooltip" {% if not llm_backend['status'] %} href="/admin/start_ollama/" {% endif %} title="Run">
                                            <i class="mdi mdi-play-box-outline {% if not llm_backend['status'] %} active {% endif %}" style="font-size: 24px;"></i>
                                        </a>
                                    </span>
                                </div>
                                {% endif %}
                                {% if llm_backend['backend'] == 'vllm' and not llm_backend['status'] %}
                                <div class="box-line">
                                    <span class="left" style="font-size: 0.9em;">vLLM server not running. Start manually:<br>
                                    <small><code>vllm serve &lt;model&gt; --host 0.0.0.0 --port 8000</code></small>
                                    </span>
                                </div>
                                {% endif %}
                            </div>


                        </div>
                        <hr>
                        <div class="box-content">
                            <div class="box-lines">
                                <h4 class="title is-6 is-thin">Database Management System</h4>
                                <div class="box-line">
                                    <span class="left">{{ dbtype }} {%if db_server %} <small>({{ db_server }}:{{dbport}})</small> {% endif %}</span>
                                    <span class="right">  <i class="mdi mdi-checkbox-blank-circle {% if db_conn %} active {% endif %}" style="font-size: 20px;"></i> </span>
                                </div>
                            </div>


                        </div>
                    </div>
                    </div>
                    {% endif %}

                    {% if llm_backend["status"] and llm_backend["installed"] %}
                    <div class="column is-4">
                        {% if len(models) > 0 %}
                        <div class="dashboard-box" style="height: 100%;">
                            <h3 class="title is-5 is-thin">Available LLMs</h3>

                            <div class="box-content">
                                <div id="models-table"></div>

                                <script src="{{ url_for('static', filename='assets/vendor/js/gridjs.umd.js') }}"></script>

                                <style>
                                  #models-table td {
                                    vertical-align: middle !important;
                                  }
                                </style>

                                <script>
                                    const modelsTableDiv = document.getElementById('models-table');

                                    const updateUrl = (prev, query) => {
                                        return prev + (prev.indexOf('?') >= 0 ? '&' : '?') + new URLSearchParams(query).toString();
                                    };

                                    new gridjs.Grid({
                                        columns: [
                                            { id: 'model_name', name: 'Model Name', sort: true },
                                            {
                                                id: 'actions',
                                                name: 'Actions',
                                                sort: false,
                                                formatter: (cell, row) => {
                                                    const modelName = row.cells[0].data;
                                                    const backend = '{{ llm_backend["backend"] }}';

                                                    // Only show delete button for Ollama backend
                                                    if (backend === 'ollama') {
                                                        return gridjs.html(`
                                                            <div style="display: flex; gap: 8px; justify-content: center;">
                                                                <a href="/admin/delete_model/${encodeURIComponent(modelName)}"
                                                                   style="background-color: #dc3545; color: white; padding: 6px 12px; border-radius: 4px; text-decoration: none; font-size: 0.85rem;">
                                                                    Delete
                                                                </a>
                                                            </div>
                                                        `);
                                                    } else {
                                                        return gridjs.html(`<div style="text-align: center;">-</div>`);
                                                    }
                                                }
                                            },
                                        ],
                                        server: {
                                            url: '/admin/models_data',
                                            then: results => results.data,
                                            total: results => results.total,
                                        },
                                        search: {
                                            enabled: true,
                                            server: {
                                                url: (prev, search) => {
                                                    return updateUrl(prev, { search });
                                                },
                                            },
                                        },
                                        sort: {
                                            enabled: true,
                                            multiColumn: false,
                                            server: {
                                                url: (prev, columns) => {
                                                    const columnIds = ['model_name'];
                                                    const sort = columns.map(col => (col.direction === 1 ? '+' : '-') + columnIds[col.index]);
                                                    return updateUrl(prev, { sort });
                                                },
                                            },
                                        },
                                        pagination: {
                                            enabled: true,
                                            limit: 4,
                                            server: {
                                                url: (prev, page, limit) => {
                                                    return updateUrl(prev, { start: page * limit, length: limit });
                                                },
                                            },
                                        },
                                    }).render(modelsTableDiv);
                                </script>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <div class="column is-4">
                         {% if llm_backend['backend'] == 'ollama' %}
                        <div class="dashboard-box" style="height: 100%;">
                            <h3 class="title is-5 is-thin">Add LLM Model</h3>
                             <div class="box-content">
                                <div class="box-lines">
                                     <div class="box-line">
                                        <span class="left">
                                            If the model you want to use is not available, you can pull it from the Ollama server.
                                            For a list of available models refer to the <a href="https://ollama.com/search">Ollama directory</a>.
                                        </span>
                                     </div>
                                </div>
                             </div>

                            <hr>

                            <div class="box-content">
                                <form action="/admin/ollama_pull" enctype="multipart/form-data" method="POST">
                                <div class="box-lines">
                                    <div class="box-line">
                                        <span class="left">Model Name</span>
                                        <span class="right">
                                            <input type="text" name="model_name" class="input" value="">
                                        </span>
                                    </div>
                                     <div class="box-line">
                                        <span class="left"></span>
                                        <span class="right">

                                        <div class="button-wrap">
                                        <button class="button is-solid primary-button is-fullwidth">
                                            Download Model
                                        </button>
                                    </div>
                                        </span>
                                    </div>
                                </div>
                                 <div class="box-lines">
                                    {% for pull in active_pulls %}

                                    {% if pull[1] < 1 %}
                                    <div class="box-line">
                                    <span class="left" id="model_pull_name_{{ pull[0] }}">
                                        {{ pull[0] }}
                                    </span>
                                     <span class="right" style="height: 22px; width: 70%;">
                                    <div class="progress" style="height: 22px; width: 100%;" >
                                        <div id="pull-progress-bar_{{ pull[0] }}" class="progress-bar progress-bar-striped progress_exp" role="progressbar"
                                             aria-valuenow="{{ pull[1] }}" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
                                            {{ pull[1] }}%
                                        </div>
                                    </div>
                                     </span>
                                        <span class="right" style="height: 22px; width: 10%;">
                                            <a href="/admin/ollama_cancel_pull/{{ pull[0] }}" title="Delete">
                                            <i class="mdi mdi-delete" style="font-size: 20px;"></i>
                                        </a>
                                        </span>
                                    </div>
                                    {% endif %}

                                     <script>
                                            $(document).ready(function () {
                                                        // Start the background progress as soon as the page loads
                                                        $.ajax({
                                                            url: `/admin/pull_progress/{{ pull[0] }}`,
                                                            method: 'GET'
                                                        });

                                                        // Poll progress updates
                                                        function pullProgress() {
                                                            $.ajax({
                                                                url: '/admin/pull_progress/{{ pull[0] }}',
                                                                method: 'GET',
                                                                dataType: 'json',
                                                                success: function (data) {
                                                                    const model_name  = data.model_name;
                                                                    const percentage = data.progress;
                                                                    const progressBar = $('#pull-progress-bar_{{ pull[0] }}');

                                                                    const textContainer = document.getElementById('model_pull_name_{{ pull[0] }}');
                                                                    textContainer.textContent = model_name;

                                                                    // Update the progress bar width and text
                                                                    progressBar.css('width', percentage + '%');
                                                                    progressBar.text(percentage + '%');

                                                                    // If progress is less than 100, keep polling
                                                                    if (percentage < 100) {
                                                                        setTimeout(pullProgress, 500);
                                                                    }
                                                                }
                                                            });
                                                        }

                                                        // Start polling immediately
                                                        pullProgress();
                                                    });

                                        </script>

                                    {% endfor %}

                                </div>
                                </form>



                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
            </div>
        </div>
    </div>

</div>

<!-- Floating Database Status Indicator (only shown when no LLM backend is configured) -->
{% if llm_backend['backend'] is none %}
<div style="position: fixed; bottom: 20px; right: 20px; z-index: 1000; background: rgba(255, 255, 255, 0.95); border-radius: 8px; padding: 10px 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); backdrop-filter: blur(10px); border: 1px solid rgba(0,0,0,0.1);">
    <div style="display: flex; align-items: center; gap: 10px;">
        <i class="mdi mdi-database" style="font-size: 18px; color: #555;"></i>
        <span style="font-size: 0.9em; color: #333; font-weight: 500;">{{ dbtype }}</span>
        {% if db_server %}
        <span style="font-size: 0.8em; color: #666;">({{ db_server }}:{{ dbport }})</span>
        {% endif %}
        <i class="mdi mdi-checkbox-blank-circle {% if db_conn %} active {% endif %}" style="font-size: 16px;"></i>
    </div>
</div>
{% endif %}

<script>
    // Experiment server control functions
    function startExperimentServer(expId) {
        showLoading('Starting experiment server...');
        window.location.href = `/admin/start_experiment/${expId}`;
    }

    function stopExperimentServer(expId) {
        showLoading('Stopping experiment server...');
        window.location.href = `/admin/stop_experiment/${expId}`;
    }

    function selectExperiment(expId) {
        showLoading('Loading experiment interface...');
        window.location.href = `/admin/select_experiment/${expId}`;
    }

    function joinExperiment(expId) {
        showLoading('Joining experiment...');
        window.location.href = `/admin/join_experiment/${expId}`;
    }
</script>

{% if show_telemetry_notice %}
<!-- Telemetry Information Overlay -->
<div id="telemetry-overlay" style="
    position: fixed;
    bottom: 15px;
    left: 50%;
    transform: translateX(-50%);
    max-width: 600px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 6px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.12);
    z-index: 10000;
    padding: 12px 16px;
    font-family: 'Roboto', sans-serif;
">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
        <h4 style="margin: 0; font-size: 0.85em; color: #666; font-weight: 600;">
            <i class="mdi mdi-information" style="color: #039be5; font-size: 1em;"></i> 
            Telemetry Information
        </h4>
        <button onclick="dismissTelemetryNotice()" style="
            background: none;
            border: none;
            font-size: 1.3em;
            color: #999;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            margin-left: 10px;
        ">&times;</button>
    </div>
    
    <div style="color: #777; font-size: 0.8em; line-height: 1.4;">
        <p style="margin: 0 0 6px 0;">
            YSocial collects anonymous usage data to improve the platform. This includes feature usage patterns and error reports, but <strong>never</strong> your experiment data, personal information, or sensitive content.
        </p>
        
        <p style="margin: 0 0 6px 0;">
            All telemetry data is GDPR compliant. You can disable it anytime from your
            <a href="/admin/user_details/{{ current_user.id }}" style="color: #039be5; text-decoration: none; border-bottom: 1px solid #039be5;">user settings</a>.
        </p>
        
        <div style="margin-top: 8px; text-align: right;">
            <button onclick="dismissTelemetryNotice()" style="
                background: #039be5;
                color: white;
                border: none;
                padding: 5px 14px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 0.8em;
                font-weight: 500;
            ">Got it</button>
        </div>
    </div>
</div>

<script>
function dismissTelemetryNotice() {
    fetch('/admin/dismiss_telemetry_notice', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    }).then(() => {
        document.getElementById('telemetry-overlay').style.display = 'none';
    });
}
</script>
{% endif %}

{% include "admin/footer.html" %}
