{% include "admin/head.html" %}

<div class="view-wrapper is-dashboard">
    <!--Dashboard container-->
    <div id="creator-dashboard" class="dashboard-container">
        <!--Toolbar-->
        {% include "admin/dash_head.html" %}

        <div class="dashboard-body">

            <div class="columns">
                <div class="column is-12">
                    <div class="dashboard-box">
                        <a href="/admin/experiments">Experiments</a> > Simulation: {{ experiment.exp_name }}
                    </div>
                </div>
            </div>

            <div class="columns">
                <!--Dashboard column-->
                <div class="column is-4">

                    {% for message in get_flashed_messages() %}
                    <div class="alert alert-warning">
                        <button type="button" class="close" data-dismiss="alert">&times;</button>
                        {{ message }}
                    </div>
                    {% endfor %}

                    <!--Dashboard box-->
                    <div class="dashboard-box">
                        <h3 class="title is-5 is-thin">Experiment Overview</h3>
                        <p style="font-size: 0.9em; color: #666; margin-bottom: 1em;">
                            Core information about this simulation experiment, including configuration and access details.
                        </p>

                        <div class="box-content">
                            <div class="box-lines">
                                <b>Basic Information</b>
                                <p style="font-size: 0.85em; color: #777; margin-bottom: 0.5em;">Experiment identification and settings.</p>
                                <div class="box-line">
                                    <span class="left">Name</span>
                                    <span class="right">{{ experiment.exp_name }}</span>
                                </div>
                                <div class="box-line">
                                    <span class="left">Description</span>
                                    <span class="right">{{ experiment.exp_descr }}</span>
                                </div>
                                <div class="box-line">
                                    <span class="left">Platform Type</span>
                                    <span class="right">{{ experiment.platform_type }}</span>
                                </div>
                                <div class="box-line">
                                    <span class="left">Owner</span>
                                    <span class="right">{{ experiment.owner }}</span>
                                </div>

                                {% if experiment.running == 1 %}
                                <hr>
                                <b>Connection Details</b>
                                <p style="font-size: 0.85em; color: #777; margin-bottom: 0.5em;">Server endpoint for active experiment.</p>
                                <div class="box-line">
                                    <span class="left">Endpoint</span>
                                    <span class="right" style="word-break: break-all;">http://{{ experiment.server }}:{{ experiment.port }}</span>
                                </div>
                                {% endif %}
                                <hr>
                                <b>Actions</b>
                                <p style="font-size: 0.85em; color: #777; margin-bottom: 0.5em;">Manage experiment data and configuration.</p>
                            </div>
                            {% if len(clients)>0 %}
                            <div class="box-line">
                                    <span class="left">Edit LLM Prompts</span>
                                    <span class="right">
                                        <a class="link-tooltip" href="/admin/prompts/{{ experiment.idexp }}" title="Edit">
                                            <i class="mdi mdi-credit-card" style="font-size: 24px;"></i></a>
                                    </span>
                                </div>
                            {% endif %}

                            {% if dbtype=="sqlite" %}
                            <div class="box-line">
                                    <span class="left">Download Experiment</span>
                                    <span class="right"><a class="link-tooltip" href="/admin/download_experiment/{{ experiment.idexp }}" title="Download"><i
                                     class="mdi mdi-download" style="font-size: 24px;"></i></a></span>
                                </div>
                            {% endif %}
                            <div class="box-line">
                                    <span class="left">Delete Experiment</span>
                                    <span class="right"> <a class="link-tooltip" href="/admin/delete_simulation/{{ experiment.idexp }}" title="Delete"><i
                                     class="mdi mdi-delete" style="font-size: 24px;"></i></a></span>
                                </div>

                        </div>
                    </div>

                    {% if len(users) > 0 %}
                    <div class="dashboard-box">
                        <h3 class="title is-5 is-thin">Registered Users</h3>
                        <p style="font-size: 0.9em; color: #666; margin-bottom: 1em;">
                            Users with access to participate in this experiment.
                        </p>

                        <div class="box-content">
                            <div class="box-lines">
                                <div class="box-line">

                                    <span class="left">
                                        {% for user, user_exp in users %}
                                            <a href="/admin/user_details/{{ user.id }}"
                                               style="border: #0d95e8 1px solid; padding: 4px 8px; margin: 2px; border-radius: 4px; display: inline-block;">{{ user.username }}</a>
                                        {% endfor %}
                                    </span>

                                </div>
                            </div>

                        </div>
                    </div>
                    {% endif %}

                </div>

                <!--Dashboard box-->

                <!--Dashboard column-->
                <div class="column is-4">
                    <!--Box-->

                    <div class="dashboard-box">
                        <h3 class="title is-5 is-thin">Server & Analysis Controls</h3>
                        <p style="font-size: 0.9em; color: #666; margin-bottom: 1em;">
                            Control panel for simulation server, web interface, and data analysis environment.
                        </p>
                        
                        <div class="box-content" style="background: #fafafa; border: 1px solid #e6e6e6; border-radius: 8px; padding-left: 15px; padding-right: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.06);">
                            <div class="box-lines">
                                <div class="box-line" style="padding-bottom: 5px; margin-bottom: 5px;">
                                    <span class="left" style="display: flex; align-items: center;">
                                        Server Controls
                                    </span>
                                    <span class="right" style="display: flex; gap: 8px; align-items: center;">
                                        <div style="display: flex; gap: 3px;">
                                            {% if experiment.running == 0 %}
                                            <a class="link-tooltip" href="/admin/start_experiment/{{ experiment.idexp }}" title="Run Experiment">
                                                <i class="mdi mdi-play-box-outline" style="font-size: 24px;"></i>
                                            </a>
                                            {% endif %}
                                            {% if experiment.running == 1 %}
                                            <a class="link-tooltip" href="/admin/stop_experiment/{{ experiment.idexp }}" title="Stop Experiment">
                                                <i class="mdi mdi-stop active" style="font-size: 24px;"></i>
                                            </a>
                                            {% endif %}
                                            <a class="link-tooltip" href="/admin/select_experiment/{{ experiment.idexp }}" title="Load Experiment">
                                                <i class="mdi mdi-select-all {% if experiment.status == 1 %}active{%endif%}" style="font-size: 24px;"></i>
                                            </a>
                                            {% if experiment.status == 1 %}
                                            <a class="link-tooltip" href="/admin/join_simulation" title="Join Simulation">
                                                <i class="mdi mdi-plus-box" style="font-size: 24px;"></i>
                                            </a>
                                            {% endif %}
                                        </div>
                                        {% if notebooks %}
                                        <div style="display: flex; gap: 3px; padding-left: 8px; border-left: 1px solid #ddd;">
                                            {% if jupyter_instance.status!='stopped' %}
                                            <a class="link-tooltip" href="#" onclick="stopJupyter('{{ jupyter_instance.exp_id }}'); return false;" title="Stop JupyterLab">
                                                <i class="mdi mdi-flask-empty-outline" style="font-size: 24px; color: #dc3545;"></i>
                                            </a>
                                            <a class="link-tooltip" href="/admin/lab/{{ experiment.idexp }}" target="_blank" title="Open JupyterLab">
                                                <i class="mdi mdi-open-in-new" style="font-size: 24px; color: #039be5;"></i>
                                            </a>
                                            {% else %}
                                            <a class="link-tooltip" href="#" onclick="startJupyter('{{ experiment.idexp }}'); return false;" title="Start JupyterLab">
                                                <i class="mdi mdi-flask-outline" style="font-size: 24px; color: #039be5;"></i>
                                            </a>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    {% if notebooks %}
                    <script>
                        function startJupyter(expId) {
                            fetch(`/admin/lab_start/${expId}`)
                                .then(response => response.json())
                                .then(data => {
                                    location.reload();
                                })
                                .catch(error => {
                                    console.error('Error starting JupyterLab:', error);
                                    location.reload();
                                });
                        }

                        function stopJupyter(instanceId) {
                            fetch(`/admin/lab_stop/${instanceId}`)
                                .then(response => response.json())
                                .then(data => {
                                    location.reload();
                                })
                                .catch(error => {
                                    console.error('Error stopping JupyterLab:', error);
                                    location.reload();
                                });
                        }
                    </script>
                    {% endif %}

                    <div class="dashboard-box">
                        <h3 class="title is-5 is-thin">Simulation Clients</h3>
                        <p style="font-size: 0.9em; color: #666; margin-bottom: 1em;">
                            Manage clients running agent populations for this experiment.
                        </p>
                        <div class="box-content">
                            {% if len(clients) == 0 %}
                            <div class="box-line">
                                <span class="left">No clients registered</span>
                            </div>
                            {% else %}
                            {% for client in clients %}
                            <div class="box-content" style="background: #fafafa; border: 1px solid #e6e6e6; border-radius: 8px; padding-left: 15px; padding-right: 15px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.06);">
                                <div class="box-line" style="padding-left: 0px; padding-top: 8px; padding-bottom: 8px;">
                                    <span class="left" style="font-size: 0.9em; display: flex; align-items: center; gap: 5px;">
                                        <i class="mdi mdi-account-cog" style="font-size: 16px; color: #7f8c8d;"></i>
                                        {{ client.name }}
                                        <a href="/admin/client_details/{{client.id}}" class="link-tooltip" title="View Client Details">
                                            <i class="mdi mdi-open-in-new" style="font-size: 16px; color: #039be5;"></i>
                                        </a>
                                    </span>
                                    <span class="right" style="width: 55%; display: flex; align-items: center; gap: 10px;">
                                        <div class="sleek-progress-container" style="flex: 1; position: relative; background: linear-gradient(to right, #f5f5f5 0%, #e8e8e8 100%); border-radius: 20px; height: 24px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.08);">
                                            <div id="progress-bar-{{client.id}}" class="sleek-progress-bar" 
                                                 style="position: absolute; left: 0; top: 0; height: 100%; width: 0%; background: linear-gradient(90deg, #039be5 0%, #4facfe 100%); border-radius: 20px; transition: width 0.4s ease-in-out, background 0.3s ease; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 6px rgba(3,155,229,0.3);">
                                                <span style="font-size: 0.75em; font-weight: 600; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">0%</span>
                                            </div>
                                        </div>
                                        <div style="display: flex; gap: 3px;">
                                            {% if client.status == 0 and experiment.running == 1 %}
                                            <a class="link-tooltip" href="/admin/run_client/{{ client.id }}/{{ experiment.idexp }}" title="Run Client">
                                                <i class="mdi mdi-play-box-outline" style="font-size: 20px;"></i>
                                            </a>
                                            {% endif %}
                                            {% if client.status == 1 %}
                                            <a class="link-tooltip" href="/admin/pause_client/{{ client.id }}/{{ experiment.idexp }}" title="Pause Client">
                                                <i class="mdi mdi-pause active" style="font-size: 20px;"></i>
                                            </a>
                                            {% endif %}
                                            {% if client.status == 0 %}
                                            <a class="link-tooltip" href="/admin/delete_client/{{ client.id }}" title="Delete Client">
                                                <i class="mdi mdi-delete" style="font-size: 20px;"></i>
                                            </a>
                                            {% endif %}
                                        </div>
                                    </span>
                                </div>
                                
                                <script>
                                    $(document).ready(function () {
                                        $.ajax({
                                            url: `/admin/progress/{{client.id}}`,
                                            method: 'GET'
                                        });

                                        function pollProgress() {
                                            $.ajax({
                                                url: '/admin/progress/{{client.id}}',
                                                method: 'GET',
                                                dataType: 'json',
                                                success: function (data) {
                                                    const percentage = data.progress;
                                                    const progressBar = $('#progress-bar-{{client.id}}');
                                                    progressBar.css('width', percentage + '%');
                                                    progressBar.find('span').text(percentage + '%');
                                                    
                                                    // Update gradient based on progress
                                                    if (percentage >= 75) {
                                                        progressBar.css('background', 'linear-gradient(90deg, #039be5 0%, #00d1b2 100%)');
                                                        progressBar.css('box-shadow', '0 2px 6px rgba(0,209,178,0.3)');
                                                    } else if (percentage >= 50) {
                                                        progressBar.css('background', 'linear-gradient(90deg, #039be5 0%, #5596e6 100%)');
                                                        progressBar.css('box-shadow', '0 2px 6px rgba(85,150,230,0.3)');
                                                    }
                                                    
                                                    if (percentage < 100) {
                                                        setTimeout(pollProgress, 500);
                                                    }
                                                }
                                            });
                                        }
                                        pollProgress();
                                    });
                                </script>
                            </div>
                            {% endfor %}
                            {% endif %}

                            <div style="text-align: center; margin-top: 10px;">
                                 <hr style="margin-bottom: 5px; margin-top: 5px;">
                                <a class="link-tooltip" href="/admin/clients/{{ experiment.idexp }}" title="Add Client">
                                    <i class="mdi mdi-plus-circle-outline" style="font-size: 24px;"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="column is-4">
                    <!--Box-->
                    <div class="dashboard-box is-compact">
                        <h3 class="title is-5 is-thin">Quick Reference Guide</h3>
                        <div class="help-block">

                            <p>
                                <b>Server & Analysis Controls</b><br>
                                Unified control panel for managing the simulation server, web interface, and data analysis tools.<br><br>
                                <i class="mdi mdi-play-box-outline" style="font-size: 16px;"></i> Start the experiment server<br>
                                <i class="mdi mdi-stop" style="font-size: 16px;"></i> Stop the experiment server<br>
                                <i class="mdi mdi-select-all" style="font-size: 16px;"></i> Load experiment's web interface<br>
                                <i class="mdi mdi-plus-box" style="font-size: 16px;"></i> Join the web interface<br>
                                <i class="mdi mdi-flask-outline" style="font-size: 16px;"></i> Start/Stop JupyterLab for data analysis
                                <br><br>
                                <em>Note: Only one web interface can be active at a time.</em>
                            </p>
                            <hr>
                            <p>
                                <b>Simulation Clients</b><br>
                                Each client manages a population of agents that interact in the simulation. Clients can be started and paused independently while the server is running.<br><br>
                                Progress bars show real-time completion status for each client.
                            </p>
                            <hr>
                            <p>
                                <b>LLM Prompts</b><br>
                                Define the instructions that LLM agents follow during the experiment.<br><br>
                                <i class="mdi mdi-credit-card" style="font-size: 16px;"></i> Edit prompts to customize agent behavior
                            </p>

                        </div>
                    </div>


                </div>

            </div>


        </div>
    </div>
</div>

{% include "admin/footer.html" %}