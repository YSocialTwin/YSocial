{% include "admin/head.html" %}

<div class="view-wrapper is-dashboard">
    <!--Dashboard container-->
    <div id="creator-dashboard" class="dashboard-container">
        <!--Toolbar-->
        {% include "admin/dash_head.html" %}

        <div class="dashboard-body">

            <div class="columns">
                <div class="column is-12">
                    <div class="dashboard-box">
                        <a href="/admin/experiments">Experiments</a> > Simulation: {{ experiment.exp_name }}
                    </div>
                </div>
            </div>

            <div class="columns">
                <!--Dashboard column-->
                <div class="column is-4">

                    {% for message in get_flashed_messages() %}
                    <div class="alert alert-warning">
                        <button type="button" class="close" data-dismiss="alert">&times;</button>
                        {{ message }}
                    </div>
                    {% endfor %}

                    <!--Dashboard box-->
                    <div class="dashboard-box">
                        <h3 class="title is-5 is-thin">Experiment Overview</h3>
                        <p style="font-size: 0.9em; color: #666; margin-bottom: 1em;">
                            Core information about this simulation experiment, including configuration and access details.
                        </p>

                        <div class="box-content">
                            <div class="box-lines">
                                <b>Basic Information</b>
                                <p style="font-size: 0.85em; color: #777; margin-bottom: 0.5em;">Experiment identification and settings.</p>
                                <div class="box-line">
                                    <span class="left">Name</span>
                                    <span class="right">{{ experiment.exp_name }}</span>
                                </div>
                                <div class="box-line">
                                    <span class="left">Description</span>
                                    <span class="right">{{ experiment.exp_descr }}</span>
                                </div>
                                <div class="box-line">
                                    <span class="left">Platform Type</span>
                                    <span class="right">{{ experiment.platform_type }}</span>
                                </div>
                                <div class="box-line">
                                    <span class="left">Owner</span>
                                    <span class="right">{{ experiment.owner }}</span>
                                </div>

                                {% if experiment.running == 1 %}
                                <hr>
                                <b>Connection Details</b>
                                <p style="font-size: 0.85em; color: #777; margin-bottom: 0.5em;">Server endpoint for active experiment.</p>
                                <div class="box-line">
                                    <span class="left">Endpoint</span>
                                    <span class="right" style="word-break: break-all;">http://{{ experiment.server }}:{{ experiment.port }}</span>
                                </div>
                                {% endif %}
                                <hr>
                                <b>Actions</b>
                                <p style="font-size: 0.85em; color: #777; margin-bottom: 0.5em;">Manage experiment data and configuration.</p>
                            </div>
                            {% if len(clients)>0 %}
                            <div class="box-line">
                                    <span class="left">Edit LLM Prompts</span>
                                    <span class="right">
                                        <a class="link-tooltip" href="/admin/prompts/{{ experiment.idexp }}" title="Edit">
                                            <i class="mdi mdi-credit-card" style="font-size: 24px;"></i></a>
                                    </span>
                                </div>
                            {% endif %}

                            {% if dbtype=="sqlite" %}
                            <div class="box-line">
                                    <span class="left">Download Experiment</span>
                                    <span class="right"><a class="link-tooltip" href="/admin/download_experiment/{{ experiment.idexp }}" title="Download"><i
                                     class="mdi mdi-download" style="font-size: 24px;"></i></a></span>
                                </div>
                            {% endif %}
                            <div class="box-line">
                                    <span class="left">Delete Experiment</span>
                                    <span class="right"> <a class="link-tooltip" href="/admin/delete_simulation/{{ experiment.idexp }}" title="Delete"><i
                                     class="mdi mdi-delete" style="font-size: 24px;"></i></a></span>
                                </div>

                        </div>
                    </div>

                    {% if len(users) > 0 %}
                    <div class="dashboard-box">
                        <h3 class="title is-5 is-thin">Registered Users</h3>
                        <p style="font-size: 0.9em; color: #666; margin-bottom: 1em;">
                            Users with access to participate in this experiment.
                        </p>

                        <div class="box-content">
                            <div class="box-lines">
                                <div class="box-line">

                                    <span class="left">
                                        {% for user, user_exp in users %}
                                            <a href="/admin/user_details/{{ user.id }}"
                                               style="border: #0d95e8 1px solid; padding: 4px 8px; margin: 2px; border-radius: 4px; display: inline-block;">{{ user.username }}</a>
                                        {% endfor %}
                                    </span>

                                </div>
                            </div>

                        </div>
                    </div>
                    {% endif %}

                </div>

                <!--Dashboard box-->

                <!--Dashboard column-->
                <div class="column is-4">
                    <!--Box-->

                    <div class="dashboard-box">
                        <h3 class="title is-5 is-thin">YServer Status</h3>
                        <p style="font-size: 0.9em; color: #666; margin-bottom: 1em;">
                            Simulation server status and control panel.
                        </p>
                        <div class="box-content">
                            <div class="box-line">
                                <span class="left">Web Interface</span>
                                <span class="right">
                                         <a class="link-tooltip" href="/admin/select_experiment/{{ experiment.idexp }}"
                                            title="Load"><i
                                                 class="mdi mdi-select-all {% if experiment.status == 1 %}active{%endif%}"
                                                 style="font-size: 24px;"></i></a>
                                         <a class="link-tooltip" {% if experiment.status== 1 %} href="/admin/join_simulation" {%
                                            endif %} title="Join"><i
                                                 class="mdi mdi-plus-box {% if experiment.status == 0 %} disabled {% endif %}"
                                                 style="font-size: 24px;"></i></a>

                                    </span>
                            </div>

                            <div class="box-line">
                                <span class="left">Server</span>
                                <span class="right">
                                     <a class="link-tooltip" {% if experiment.running == 0 %} href="/admin/start_experiment/{{ experiment.idexp }}" {% endif %}title="Run">
                                            <i class="mdi mdi-play-box-outline {% if experiment.running %}active{% endif %}"
                                               style="font-size: 24px;"></i>
                                        </a>

                                     <a class="link-tooltip" {% if experiment.running == 1 %} href="/admin/stop_experiment/{{ experiment.idexp }}" {% endif %}
                                        title="Stop">

                                    <i class="mdi mdi-stop {% if experiment.running == 0 %} disabled {% endif %}"
                                       style="font-size: 24px;"></i>
                                    </a>

                                    </span>
                            </div>
                        </div>

                    </div>


                    <div class="dashboard-box">
                        <div class="box-content">
                            <h3 class="title is-5 is-thin">YClients</h3>
                            <hr style="margin-bottom: 5px; margin-top: 5px;">
                            {% if len(clients) == 0 %}
                            <div class="box-line">
                                <span class="left">No clients registered</span>
                            </div>
                            {% endif %}
                            {% for client in clients %}
                            <div class="box-line" style="height: 40px;">
                                <span class="left"><a href="/admin/client_details/{{client.id}}">{{ client.name }}</a></span>

                                <span class="right">
                                        <a class="link-tooltip" {% if  client.status == 0  and experiment.running == 1 %} href="/admin/run_client/{{ client.id }}/{{ experiment.idexp }}" {% endif %} title="Run">
                                            <i class="mdi mdi-play-box-outline {% if  client.status == 1  %}active {% elif experiment.running == 0 %} disabled {% endif %}" style="font-size: 24px;"></i>
                                        </a>
                                        <a class="link-tooltip" {% if  client.status == 1 %} href="/admin/pause_client/{{ client.id }}/{{ experiment.idexp }}" {% endif %} title="Pause">
                                            <i class="mdi mdi-pause {% if  client.status == 0 %} disabled {% endif %}" style="font-size: 24px;"></i>
                                        </a>
                                        <!--<a class="link-tooltip" {% if  client.status == 1 %} href="/admin/stop_client/{{ client.id }}/{{ experiment.idexp }}" {% endif %} title="Stop">
                                            <i class="mdi mdi-stop {% if  client.status == 0 %} disabled {% endif %}" style="font-size: 24px;"></i>
                                        </a>-->
                                        <a class="link-tooltip" href="/admin/delete_client/{{ client.id }}" title="Delete">
                                            <i class="mdi mdi-delete" style="font-size: 24px;"></i>
                                        </a>
                                    </span>
                            </div>
                            {% endfor %}

                            <div style="text-align: center">
                                 <hr style="margin-bottom: 5px; margin-top: 5px;">
                                <a class="link-tooltip" href="/admin/clients/{{ experiment.idexp }}" title="Add">
                                    <i class="mdi mdi-plus-circle-outline" style="font-size: 24px;"></i>
                                </a>
                            </div>

                        </div>
                    </div>

                    {% if notebooks %}
                    <div class="dashboard-box">
                        <h3 class="title is-5 is-thin">Data Analysis</h3>
                        <p style="font-size: 0.9em; color: #666; margin-bottom: 1em;">
                            JupyterLab environment for data exploration and analysis.
                        </p>
                        <div class="box-content">
                            <div class="box-lines">
                                <div class="box-line">
                                    <span class="left">JupyterLab Service</span>

                                    <span class="right">
                                        <a class="link-tooltip" 
                                           {% if jupyter_instance.status=='running' %}
                                           href="#" onclick="stopJupyter('{{ jupyter_instance.exp_id }}'); return false;"
                                           {% else %}
                                           href="#" onclick="startJupyter('{{ experiment.idexp }}'); return false;"
                                           {% endif %}
                                           title="{% if jupyter_instance.status!='stopped' %}Stop{% else %}Start{% endif %}">
                                            <i class="mdi {% if jupyter_instance.status!='stopped' %}mdi-stop active{% else %}mdi-play-box-outline{% endif %}"
                                               style="font-size: 24px;"></i>
                                        </a>
                                        {% if jupyter_instance.status!='stopped' %}
                                        <a class="link-tooltip" 
                                           href="/admin/lab/{{ experiment.idexp }}"
                                           >
                                            <i class="mdi mdi-open-in-new active" style="font-size: 24px;"></i>
                                        </a>
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <script>
                        function startJupyter(expId) {
                            fetch(`/admin/lab_start/${expId}`)
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        //alert(data.message);
                                        location.reload();
                                    } else {
                                        alert('Error: ' + data.message);
                                    }
                                })
                                .catch(error => {
                                    alert('Error starting JupyterLab: ' + error);
                                });
                        }

                        function stopJupyter(instanceId) {
                            fetch(`/admin/lab_stop/${instanceId}`)
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        //alert(data.message);
                                        location.reload();
                                    } else {
                                        alert('Error: ' + data.message);
                                    }
                                })
                                .catch(error => {
                                    alert('Error stopping JupyterLab: ' + error);
                                });
                        }
                    </script>
                    {% endif %}
                </div>

                <div class="column is-4">
                    <!--Box-->
                    <div class="dashboard-box is-compact">
                        <h3 class="title is-5 is-thin">Guide</h3>
                        <div class="help-block">

                            <p>
                                <b>Web Interface</b> allows to interact with the experiment through an online social platform-like interface.<br><br>
                                <i class="mdi mdi-select-all" style="font-size: 16px;"></i> activates the experiment's web interface.<br>
                                <i class="mdi mdi-plus-box" style="font-size: 16px;"></i> access the web interface.
                                <br><br>
                                <em>Note: Only one web interface can be active at a time, even for non-running experiments.</em>
                            </p>
                            <hr>
                            <p>
                                <b>YServer</b>
                                 is the main component of the experiment. It is responsible for
                                the execution of the experiment.
                            </p>
                            <p>
                                <b>YClients.</b>
                                Each client simulates a population of agents. Clients can be started and stopped while the server is running.<br>
                            </p>
                            <hr>
                            <p>
                                <b>Prompts</b> specify the instruction that the LLM agents will be required to follow during the experiment.<br><br>

                                <i class="mdi mdi-credit-card" style="font-size: 16px;"></i> allows to edit the prompts to tune them to the simulation needs.
                            </p>

                        </div>
                    </div>


                </div>

            </div>


        </div>
    </div>
</div>

{% include "admin/footer.html" %}